#!/usr/bin/perl5 -s

	# print "Content-type: text/txt\n\n";

  	use locale;
    use Image::VisualConfirmation;
	
	$tries = 0;
	
	&makeChallenge;

	sub makeChallenge {
	    my $vc = Image::VisualConfirmation->new({
			font_size   => 30,
		});

		##-- generate and retrieve code word
    	$myVCcode = $vc->code;

		$LOWVCcode = lc($myVCcode);

	use DBI;
	$dbh = DBI->connect("DBI:mysql:NVF","root","32GCC5E7TSjqQ") or die "Unable to connect to database\n"; 
	$dbh->{RaiseError} = 1; 




		my $sth = $dbh->prepare("SELECT ENCRYPT('$LOWVCcode','nVo')");
		$sth->execute;
		my $row = $sth->fetchrow_arrayref;
		my $elCrypto = $row->[0];
		$sth->finish;

	$dbh->disconnect; 		
		
		
		$vc->image->write(file => "/usr/local/www/vhosts/nightvisiononline.com/htdocs/besameDiesesEsel/$elCrypto.jpg");

		if (-e "/usr/local/www/vhosts/nightvisiononline.com/htdocs/besameDiesesEsel/$elCrypto.jpg") {
		    $myImagen = "$elCrypto";
		}
		else {
			&tryAgain;
		}
	}

	
	
	sub tryAgain {
		if ($tries <= 3) {
			$tries++;
			&makeChallenge;
		}
		else {
		 	1;
		}
	}




	
1;