#!/usr/bin/perl5 -s

use CGI qw(:standard);

##################################################################
# "PhotoAlbum3.cgi"  -  Scripted by Brian Viehland               #
# E-mail: scripts@viehland.org                                   #
# VERSION 3.1 (c) March 2005                                     #
#                                                                #
# /////      description       /////                             #
#                                                                #
# This script will allow users to create photo albums and upload #
# images with descriptions to those albums.  It also records the #
# date of the posting and has display options and multiple       #
# passwords for security and access control. You can set up      #
# email notification for each parts of the script.               #
# Please leave some mention of me in this header and that you    #
# modified the script I provided. If you come up with an update  # 
# to this script that is really good, PLEASE email it to me at   #
# scripts@viehland.org                                           #
#                                                                #
# If it don't work, email me and I'll help you get it runnning.  #
#                                                                #
# The perl module CGI.pm is required on your server.  If you     #
# don't have it installed, get it.  You also need to have POSIX  #
# installed or some other date getting plugin.                   #
#                                                                #
# BUGS AND THINGS TO BE LOOKED INTO                              #
# On some servers, you must create your own folder called        #
# PhotoAlbums in the base html directory and chmod it to 766     #
##################################################################


##################################################################
# Editable Variables (just a few)
##################################################################
# use this for set up problems - it will closely track the progress
# of the script using hidden html tags.  When this is set to yes,
# the html source will show where the script is at each point
$debug = "no";


##################################################################
# Set the paths to the directories as absolute and as url paths
# use / between folders for unix and \ for dos 
##################################################################

# this should automatically retrieve the site name
# otherwise, enter your site http://www.site.com
$parentURL = "http://$ENV{'HTTP_HOST'}";
# this should automatically retrieve the path
# otherwise, enter the path to your site /home/username/www
$parentDirectory = "/usr/local/www/vhosts/nightvisiononline.com/htdocs/";
# this should automatically retrieve the script URL
# otherwise, enter the URL to your script http://www.site.com/cgi-bin/script.cgi
$URLToThisFile = "http://$ENV{'SERVER_NAME'}$ENV{'SCRIPT_NAME'}";
# this should automatically retrieve the script path
# otherwise, enter the URL to your script /home/username/www/cgi-bin/script.cgi
$pathToThisFile = "$ENV{'SCRIPT_FILENAME'}";


##################################################################
# These options are for controlling the posting of Photos
# All very straight forward
##################################################################
$showPhotoPostOption = "yes";			# yes or no
$usePostingPassword = "yes";			# yes or no
$postingPassword = "superusnv";
$maximumFileSize = "512000";			# in bytes
@allowedFileExtensions = ('jpg','jpeg','png');
$useMimeTypeDetection = "yes";			# yes or no

##################################################################
# These options are for controlling the deleting of Photos
##################################################################
$showPhotoDeleteButton = "yes";			# yes or no
$usePasswordForPhotoDelete = "yes";		# yes or no
$deletePassword = "superusnv";

##################################################################
# These options are for controlling the adding of Albums
##################################################################
$allowUserDefinedAlbums = "yes";		# yes or no
$usePasswordForAlbumAdd = "yes";		# yes or no
$addAlbumPassword = "superusnv";

##################################################################
# These options are for controlling the deleting of Albums
##################################################################
$showAlbumDeletionOption = "yes";		# yes or no
$usePasswordForAlbumDelete = "yes";		# yes or no
$deleteAlbumPassword = "superusnv";

##################################################################
# These variables are used to set the date format that ends up
# as the prefix for the filename. They should work as is, but 
# they may need to be configured to your server
##################################################################
($sec,$min,$hour,$mday,$mon,$year,$wday,$yday,$isdst) = localtime(time);
$month = ($mon + 1);
$year += 1900;
$year %= 100;
$date = sprintf("%02d-%02d-%02d",$month,$mday,$year);

##################################################################
# These variables are used for email notification of actions
##################################################################
$sendNotificationUponPostPhoto = "no";		# yes or no
$sendNotificationUponDeletePhoto = "no";	# yes or no
$sendNotificationUponCreateAlbum = "no";	# yes or no
$sendNotificationUponDeleteAlbum = "no";	# yes or no
$emailAddress = "webmaster\@site.com";	# use \@ in address
$sendmailpath="/usr/sbin/sendmail";

##################################################################
# This sets the file directory structure, unix or dos
##################################################################
$servertype = "unix";			# unix or dos

##################################################################
# If you are going to use this for an adult site, please change
# this to yes.  With this set to no, the script will edit out 
# bad words listed in the array below for both album names and
# file descriptions.  Setting this to yes disables the bad words
# check and also takes my name off of the bottom of the page.
##################################################################
$usedAsAdultGallery = "no"; 	# yes or no

##################################################################
# Predefined variables, you may change them, but be careful
##################################################################
# use PhotoAlbums in the base directory to store all pics
if ($servertype eq "unix") {
	$parentDirectory =~ s/\/$//g;
	$parentDirectory = $parentDirectory . "/PhotoAlbums";
	$parentURL = $parentURL . "/PhotoAlbums";
}
else {
	$parentDirectory =~ s/\\\\/\\/g;
	$parentDirectory =~ s/\\$//g;
	$parentDirectory =~ s/\\/\\\\/g;
	$parentDirectory = $parentDirectory . "\\PhotoAlbums";
	$parentURL = $parentURL . "/PhotoAlbums"; 
}
# words that will not be allowed in the file names or descriptions
@badwords = ('bastard','fuck','f..k','shit','sh.t','cunt',
	'whore','hore','twat','bitch','b..ch','pussy','p..sy','adult',
	'goddamn','damn','prick','c.ck','dick','asshole','_ass_',
	'^ass_','_ass$',' ass ','cock','viagra','cialis','erection','penis',
	'vagina');

##################################################################
# That's It!!!  You are ready to go now!
##################################################################
# Just dump this file into your cgi-bin directory, name it 
# with the extention .pl or .cgi and CHMOD it to 755
##################################################################
##################################################################
##################################################################
##################################################################
##################################################################
##################################################################
##################################################################






if ($debug eq "yes") { 
	use CGI::Carp qw(fatalsToBrowser);
}






##################################################################
# Script Wrapper
##################################################################
&main();    # run script
1;     # end program







##################################################################
# The main part of the script that tells the script what to do
##################################################################
sub main {
	use DBI;
	my $dbh = DBI->connect("DBI:mysql:NVF".$thyHost,$thyRU,$thyRP) or die "Unable to connect to database: <b>$elDB</b>\n"; 
	$dbh->{RaiseError} = 1; 
	#-- CONNECT TO DB (GET PAGE CONTENT)
	
	my $whatToDo = "mainScreenUnLogged";
	if (param()) {$whatToDo = param('doWhat'); }                             

	if ($whatToDo eq "mainScreenUnLogged"){ &mainScreenUnLogged(param); }
	if ($whatToDo eq "showPics"){ &showPics(param); }
	if ($whatToDo eq "showSinglePhoto"){ &showSinglePhoto(param); }
	if ($whatToDo eq "postForm"){ &postForm(param); }
	if ($whatToDo eq "postPics"){ &postPics(param); } 
	if ($whatToDo eq "deleteForm"){ &showPics(param); } 
	if ($whatToDo eq "deletePics"){ &deletePics(param); } 
	if ($whatToDo eq "albumManagement"){ &albumManagement(param); } 
	if ($whatToDo eq "addAlbumAction"){ &addAlbumAction(param); } 
	if ($whatToDo eq "deleteVerification"){ &deleteVerification(param); } 
	if ($whatToDo eq "deleteAlbumAction"){ &deleteAlbumAction(param); } 

	if ($debug eq "yes") { print "\n<!-- End sub main -->\n"; }

	$dbh->disconnect;
}






##################################################################
# This part opens the parent directory and lists all the albums
# located there in order to provide them to other sub routines
##################################################################
sub getAlbums {

	##-- OLD WAY
	##-- if ($debug eq "yes") { print "\n<!-- Begin sub getAlbums -->"; } my $err = opendir(DIR,"$parentDirectory"); if ($err == 1) { if ($debug eq "yes") { print "\n<!-- Succesfully Opened $parentDirectory -->"; } } else {  if ($debug eq "yes") {  print "\n<!-- Failed To Open $parentDirectory -->"; print "\n<!-- Attempting To Create $parentDirectory -->\n";  } my $err2 ==	mkdir("$parentDirectory",755); if ($err2 == 1) { if ($debug eq "yes") { print "\n<!-- Succesfully Created $parentDirectory -->"; } } else { if ($debug eq "yes") { print "\n<!-- Failed To Create $parentDirectory -->"; } } if ($debug eq "yes") { print "\n<!-- Opening $parentDirectory -->"; } opendir(DIR,"$parentDirectory"); } my @albums = readdir(DIR); if ($debug eq "yes") { print "\n<!-- Closing $parentDirectory -->"; } closedir(DIR); if ($albums[0] =~ m/^\./) { shift(@albums);} if ($albums[0] =~ m/^\./) { shift(@albums);} @albums = sort { $a cmp $b } @albums; if ($debug eq "yes") { print "\n<!-- Returning Album List -->";  print "\n<!-- End sub getAlbums -->\n";  } return (@albums);

	##-- NEW WAY
	## -->  CONNECT TO DB
	use DBI;
	my $dbh = DBI->connect("DBI:mysql:NVF".$thyHost,$thyRU,$thyRP) or die "Unable to connect to database: <b>$elDB</b>\n"; 
	$dbh->{RaiseError} = 1; 

	my $sth = $dbh->prepare("SELECT Title FROM Albums ORDER BY LastUpdated DESC");
	$sth->execute or die "Unable to execute query\n";
	my @row;
	while(@row = $sth->fetchrow_array) {
		$AT = $row[0];
		$miFIL = "$parentDirectory" . "/" . "$AT";
		##-- make sure directory actually exists...
		if (-e $miFIL) {
			push(@albums,"$AT");
		}
	}
	$sth->execute or die "Unable to execute query\n";
	$dbh->disconnect;
	return (@albums);

}






##################################################################
# Here we display our header - You can also add additional info
# here if you want
##################################################################
sub beginPage {

	if ($debug eq "yes") { print "\n<!-- Begin sub beginPage -->\n"; }
	$generatedTag = "";
	print "<center>";
}

##################################################################
# Here we end the html display and customize it (somewhat)
# for the particular page we are on
##################################################################
sub endPage {


	if ($debug eq "yes") { print "\n<!-- Begin sub endPage -->"; }

	my ($thisPage) = @_;
	print "\n<!-- End the display for action: $thisPage -->\n";
	my $tempnumber = "0";
	if ($thisPage ne "mainScreenUnLogged") {
#		print start_form,
##XX##
#		"<input type=hidden name=doWhat value=mainScreenUnLogged>\n",
#		submit(-value=>'Main Page'),
#		end_form;
		$tempnumber++; 
	}
	if ($showPhotoPostOption eq "yes") {
		if ($thisPage ne "postForm") {
			my $numberOfAlbums;
			if ($numberOfAlbums ne "0"){
#				print start_form,
##XX##
#				"<input type=hidden name=doWhat value=postForm>\n",
#				submit(-value=>'Posting Page'),
#				end_form;
			}
		}
		$tempnumber++; 
	}
	if (($allowUserDefinedAlbums ne "no") || ($showAlbumDeletionOption ne "no")){
		if ($thisPage ne "albumManagement") {
#			print start_form,
##XX##
#			"<input type=hidden name=doWhat value=albumManagement>\n",
#			submit(-value=>'Manage Albums'),
#			end_form;
		} 
		$tempnumber++; 
	}
	if ($tempnumber ne "0") {
	}


	if ($debug eq "yes") { print "\n<!-- End sub endPage -->"; }



##	if ($CSen eq "SI") { $myLogPrompt = '<div class="formInput" style="padding-right:15px;">[ <a href="#" style="color:#337701;letter-spacing:2px;">Manage Your Album</a> ]</div>'; }
##	else { $myLogPrompt = '<div class="formInput" style="padding-right:15px;">[ <a href="#" style="color:#337701;letter-spacing:2px;">Start An Account</a> ]</div>'; }


	### --->>> INSERT INTO PAGE
	$PageContent =~ s/%%LOGINPROMPT%%/$myLogPrompt/gi;
	$AlbumGallery = "&nbsp;<!--<font style=\"font-family:verdana,arial;color:#ffffff\"><b>Album</b> &nbsp;\| &nbsp; <a href=\"javascript:void(0);\" style=\"color:#ffffff;\" title=\"Photograph Galleries coming soon...\">Gallery</a></font>-->";
	$PageContent =~ s/%%ALBUM_GALLERY%%/$AlbumGallery/gi;

	print "$PageContent";



}

##################################################################
# MainScreen NOT LOGGED IN
##################################################################
sub mainScreenUnLogged {


#	#- --> SET HARD PARAM
#	$ct = '56';

#	##-->> GET TEMPLATE PAGE FROM DB
#	$sth = $dbh->prepare("SELECT * FROM WebsiteContent where ContentID = '$ct';");
#	$sth->execute or die "Unable to execute query\n"; 
#		my @row;
#		while(@row = $sth->fetchrow_array) { 
#			$PageContent = $row[1];
#			$PageHeader = $row[2];
#			$PCount++;
#		}
#	$sth->execute or die "Unable to execute query\n"; 
#	$sth->finish;
	
	
	
	$PageContent = '
	<!--** PhotoMainNoLog **-->

<link rel="stylesheet" href="commonStyles.css" type="text/css">

<center>
  <table width="800" border="0" cellspacing="0" cellpadding="0">
    <form method="post" name="browseAll">
      <input type="hidden" name="browseAll" value="1">
	  <tr>
    	<td colspan="2"><img src="nvi/spacer.gif" width="1" height="5"></td>
	  </tr>
<!--<font class="photoSmallest">%%LOGINPROMPT%%</font>-->
      <tr> 
        <td align="left" style="padding-left:10px;"><a href="/FotoBlog.htm"><img src="nvi/fotoBlogLogoSmall.gif" width="104" height="20" border="0"></a></td>
        <td align="right" style="padding-right:10px;"><div id="FotoMMLinks" class="FotoMMLinks"><a href="/FotoBlog.htm?browseAll=1&albumChoice=random&PN=&doWhat=showPics&startPic=0&amountOfPhotos=10&Thumbnails=yes&showDates=yes&deleteInfo=Show" title="Album Browser" class="FotoMMLinksA">browser</a> &nbsp;&nbsp;|&nbsp;&nbsp; <a href="/Slideshow.htm?browseAll=1&albumChoice=random" title="Artist\'s Galleries" class="FotoMMLinksA">slideshow</a> &nbsp;&nbsp;|&nbsp;&nbsp; <font class="FotoMMLinksA">manage</font> &nbsp;&nbsp;|&nbsp;&nbsp; <font class="FotoMMLinksA">share</font></div></td>
      </tr>
      <tr> 
        <td colspan="2"><img src="nvi/spacer.gif" width="1" height="5"></td>
      </tr>
      <tr> 
        <td colspan="2" background="nvi/horizontalDottie.gif"><img src="nvi/spacer.gif" border="0" width="1" height="1"></td>
      </tr>
      <tr>
        <td colspan="2"><img src="nvi/spacer.gif" width="1" height="15"></td>
      </tr>
      <tr> 
        <td colspan="2"><table width="100%"  border="0" cellspacing="0" cellpadding="0">
            <tr valign="top"> 
              <td width="480" align="center">


%%GRAP%%

			  </td>
              <td width="320" align="center"> 
			  <table width="290" border="0" cellspacing="0" cellpadding="0">
                  <tr> 
                    <td align="center"> <table width="290" border="0" cellspacing="0" cellpadding="0" background="nvi/photo_tableBacker3.gif">
                        <tr> 
                          <td rowspan="3"><img src="nvi/spacer.gif" width="1" height="68"></td>
                          <td colspan="2"><img src="nvi/spacer.gif" width="289" height="1"></td>
                        </tr>
                        <tr> 
                          <td align="left" valign="top" height="22" class="photoTitles" nowrap>user albums</td>
                          <td align="right" valign="top" height="22" style="padding-top:5px;padding-right:5px;"><font class="photoSmallest" nowrap>%%ALBUM_GALLERY%%</font></td>
                        </tr>
                        <tr> 
                          <td colspan="2" align="center" height="20" valign="top">%%ALB_GAL_LIST%%</td>
                        </tr>
                      </table>
                      <table width="290" border="0" cellspacing="0" cellpadding="0">
                        <tr> 
                          <td align="center" valign="bottom" height="15"><img src="nvi/photo_tableBot3.gif" width="290" height="15"></td>
                        </tr>
                      </table></td>
                  </tr>
                  <tr>
                    <td align="center" style="padding-top:10px;padding-bottom:15px;">
						<table width="290" border="0" cellspacing="0" cellpadding="0">
            				<tr> 
            			        <td align="center"><input type="button" name="submitb" value="Album Browser" class="Buttons" tabindex="11" style="width:95px;" onClick="runBrowser();" disabled></td>
			                    <td align="center" class="numberPhotos"><div id="numberPhotos"></div></td>
                    			<td align="center"><input type="button" name="slideb" value="Album Slideshow" class="Buttons" tabindex="11" style="width:106px;" onClick="runSlideShow();" disabled></td>
                  			</tr>
				  		</table><div id="albumBy"></div>
					</td>
                  </tr>
                  <tr> 
                    <td align="center"><table width="290" border="0" cellspacing="0" cellpadding="0" background="nvi/photo_tableBacker3.gif">
                        <tr> 
                          <td rowspan="4"><img src="nvi/spacer.gif" width="1" height="68"></td>
                          <td><img src="nvi/spacer.gif" width="289" height="1"></td>
                        </tr>
                        <tr> 
                          <td height="28" align="left" valign="top" class="photoTitles" nowrap>preview</td>
                        </tr>
                        <tr> 
                          <td height="20" align="left" valign="top" class="photoTitlesR" nowrap>album</td>
                        </tr>
                        <tr> 
                          <td align="center" height="40" valign="middle"><div id="collectionPreview"  class="photoSmallest">select an album from list above</div></td>
                        </tr>
                      </table>
                      <table width="250" border="0" cellspacing="0" cellpadding="0">
                        <tr> 
                          <td align="center" valign="bottom" height="15"><img src="nvi/photo_tableBot3.gif" width="290" height="15"></td>
                        </tr>
                      </table></td>
                  </tr>
                  <tr> 
                    <td align="center" style="padding-top:25px;">&nbsp;</td>
                  </tr>
                </table></td>
            </tr>
          </table></td>
      </tr>
     %%HIDDEN_FIELDS%%
    </form>
  </table>
</center>
<br><br>

	';
	
	my $thisPage = "mainScreenUnLogged";
	print "\n<!-- Begin action: $thisPage -->\n";
	&beginPage;
#	print start_form;
	my @albums = &getAlbums;				
	$numberOfAlbums = scalar(@albums);	

	if ($numberOfAlbums eq "0"){			
	if ($debug eq "yes") { print "\n<!-- No Albums Found -->\n"; }
		print "<!-- Display for No Albums Condition -->\n";
	}


	if ($numberOfAlbums gt "0") {
		$losAlbums = "\n<select onChange=\"cambiame();\" name=\"albumChoice\" class=\"albumSelector\">\n";
		my $tempcount = 0;
		$losAlbums = $losAlbums . "<option value=\"BIGNULL\">Choose An Album</option>\n";
		my $albumName;
		foreach $albumName(@albums){
			my $display = $albumName;		
			$display =~ s/_/ /g;			
			$losAlbums = $losAlbums . "<option value=\"$albumName\">$display</option>\n";
			$tempcount++; 
		}
		$losAlbums = $losAlbums . "</select>\n\n",
	
		### --->>> INSERT INTO PAGE
		$PageContent =~ s/%%ALB_GAL_LIST%%/$losAlbums/gi;

		use LWP::Simple;
		$muaGRAP = get("http://www.nightvisiononline.com/getRandomAP.htm");
		
		$PageContent =~ s/%%GRAP%%/$muaGRAP/gi;	
		$integPHOTOS = "integPhotos();";

	}

	if ($numberOfAlbums gt "0"){					
		$formFields = $formFields . "<input type=hidden name=doWhat value=showPics><input type=hidden name=startPic value=0><input type=hidden name='amountOfPhotos' value='10'><input type=hidden name='Thumbnails' value='yes'><input type=hidden name='showDates' value='yes'>";
	}

	$formFields = $formFields . "<input type=hidden name=deleteInfo value=Show>";

	### --->>> INSERT INTO PAGE
	$PageContent =~ s/%%HIDDEN_FIELDS%%/$formFields/gi;

	&endPage($thisPage);

}






####-->> VIEW ALBUM
##################################################################
# Here we list the files in the directory chosen by the user, then
# based on their preferences, show them in a table format, linking
# to the file and if desired, showing the file (full size download
# but shown smaller)  We take the filename and split it as needed
# to get the date and the description separated.
##################################################################
sub showPics {

#	#- --> SET HARD PARAM
#	$ct = '60';

#	##-->> GET TEMPLATE PAGE FROM DB
#	$sth = $dbh->prepare("SELECT * FROM WebsiteContent where ContentID = '$ct';");
#	$sth->execute or die "Unable to execute query\n"; 
#		my @row;
#		while(@row = $sth->fetchrow_array) { 
#			$PageContent = $row[1];
#			$PageHeader = $row[2];
#			$PCount++;
#		}
#	$sth->execute or die "Unable to execute query\n"; 
#	$sth->finish;

	$PageContent = '
<!--** AlbumMain **-->


<link rel="stylesheet" href="commonStyles.css" type="text/css">

<center>
  <table width="800" border="0" cellspacing="0" cellpadding="0">
    <form method="post" name="browseAll">
      <input type="hidden" name="browseAll" value="1">
	  <tr>
    	<td colspan="2"><img src="nvi/spacer.gif" width="1" height="5"></td>
	  </tr>
<!--<font class="photoSmallest">%%LOGINPROMPT%%</font>-->
      <tr> 
        <td align="left" style="padding-left:10px;"><a href="/FotoBlog.htm"><img src="nvi/fotoBlogLogoSmall.gif" width="104" height="20" border="0"></a></td>
        <td align="right" style="padding-right:10px;"><div id="FotoMMLinks" class="FotoMMLinks"><font class="FotoMMLinksA" style="text-decoration:none;">browser</font> &nbsp;&nbsp;|&nbsp;&nbsp; <a href="/Slideshow.htm?browseAll=1&albumChoice=random" title="Artist\'s Galleries" class="FotoMMLinksA">slideshow</a> &nbsp;&nbsp;|&nbsp;&nbsp; <font class="FotoMMLinksA">manage</font> &nbsp;&nbsp;|&nbsp;&nbsp; <font class="FotoMMLinksA">share</font></div></td>
      </tr>
      <tr> 
        <td colspan="2"><img src="nvi/spacer.gif" width="1" height="5"></td>
      </tr>
      <tr> 
        <td colspan="2" background="nvi/horizontalDottie.gif"><img src="nvi/spacer.gif" border="0" width="1" height="1"></td>
      </tr>
      <tr>
        <td colspan="2"><img src="nvi/spacer.gif" width="1" height="1"></td>
      </tr>
    <tr>
    	<td colspan="2" valign="top" style="padding-left:20px; padding-right:20px;">


			<table width="100%" border="0" cellspacing="0" cellpadding="0">
            	<tr> 
					<td style="padding-top:6px;" valign="top" nowrap><font class="breadCrumb">%%BREADCRUMB%% <b>%%ALBUM_NAME%%</b></font></td>
              		<td valign="top" align="right"> 
			  			<table border="0" cellspacing="0" cellpadding="0">
                  			<tr> 
                    			<td > 
									<table border="0" cellpadding="0" cellspacing="0">
                        				<tr> 
                          					<td style="padding-bottom:20px;" align="center"> 
						  						<table cellpadding="0" cellspacing="0" border="0">
                									<tr valign="top"> 
            	                    					<td nowrap class="resultsBreakdown" style="padding-top:5px;padding-right:10px;">%%NUMITEMS_SHOWING%%</td>
														%%PAGING%%
                              						</tr>
                            					</table>
											</td>
                        				</tr>
                      				</table>
								</td>
                  			</tr>
                		</table>
					</td>
            	</tr>
			</table>		
		
		
		</td>
    </tr>
    <tr> 
    	<td colspan="2" style="padding-left:20px;padding-right:20px;" valign="top">
			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr height="30"> 
              		<td align="left" valign="bottom" style="padding-left:10px;" class="titloAlbumBrowse"><font style="font-size:9px;letter-spacing:1px;"><em>ALBUM: </em></font> <b>%%ALBUM_NAME%%</b></td>
              		<td align="right" valign="bottom" style="padding-right:10px;"><div>%%OWNERINFO%%</div></td>
				</tr>
			</table>


			<table width="100%" border="0" cellspacing="0" cellpadding="0">
      			  <tr>
			        <td colspan="5"><img src="nvi/spacer.gif" width="1" height="10"></td>
			      </tr>
                  <tr> 
                    <td height="1" colspan="5" style="background-image:url(\'nvi/horizontalDottie.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>
      			  <tr>
			        <td colspan="5"><img src="nvi/spacer.gif" width="1" height="1"></td>
			      </tr>
                  <tr> 
                    <td height="1" colspan="5" style="background-image:url(\'nvi/horizontalDottie.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>

            <tr> 
              <td width="1" valign="bottom" style="background-image:url(\'nvi/spacer.gif\');background-repeat:repeat-y;"><img src="nvi/whiteSpacer.gif" width="1" height="35"></td>
              <td align="center" valign="top" style="padding-top:10px;padding-bottom:10px;"><center>%%ALBUM_SPIT%%</center></td>
              <td width="1" valign="bottom" style="background-image:url(\'nvi/verticalDottie.gif\');background-repeat:repeat-y;"><img src="nvi/whiteSpacer.gif" width="1" height="35"></td>
              <td align="center" valign="top" style="padding-top:15px;padding-bottom:10px;">
                  <table width="400" border="0" cellspacing="0" cellpadding="0" background="nvi/photo_tableBacker2.gif">
      			  <tr>
			        <td colspan="3"><img src="nvi/spacer.gif" width="1" height="5"></td>
			      </tr>
                  <tr> 
                    <td colspan="3" style="height:25px;" bgcolor="#000000" class="photoTitle"><center><b>%%IMAGE_TITLE%%</b></center></td>
                  </tr>
                  <tr> 
                    <td colspan="3" bgcolor="#000000" style="padding-top:15px;padding-bottom:20px;"><center><div>%%LARGE_PHOTO%%</div></center></td>
                  </tr>
                  <tr> 
                    <td height="1" colspan="3" style="background-image:url(\'nvi/horizontalDottieB.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>
                  <tr> 
                    <td height="1" colspan="3" style="background-image:url(\'nvi/horizontalDottieB.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>
                  <tr> 
                    <td align="right" valign="top" class="listItems" nowrap>description</td>
                    <td width="1" style="background-image:url(\'nvi/verticalDottieB.gif\');background-repeat:repeat-y;"><img src="nvi/spacer.gif" width="1" height="1"></td>
                    <td align="left" valign="top" class="listItems2">%%ART_COMMENTS%%</td>
                  </tr>
                  <tr> 
                    <td height="1" colspan="3" style="background-image:url(\'nvi/horizontalDottieB.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>
                  <tr> 
                    <td align="right" valign="middle" class="listItems" nowrap><img src="nvi/blogs.gif" width="38" height="14" border="0"></td>
                    <td style="background-image:url(\'nvi/verticalDottieB.gif\');background-repeat:repeat-y;"><img src="nvi/spacer.gif" width="1" height="1"></td>
                    <td align="left" valign="top" class="listItems2" nowrap><div id="thyComments">%%USER_COMMENTS%%</div></td>
                  </tr>
                  <tr> 
                    <td height="1" colspan="3" style="background-image:url(\'nvi/horizontalDottieB.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>
                  <tr> 
                    <td align="right" valign="top" class="listItems" nowrap>equipment</td>
                    <td style="background-image:url(\'nvi/verticalDottieB.gif\');background-repeat:repeat-y;"><img src="nvi/spacer.gif" width="1" height="1"></td>
                    <td align="left" valign="top" class="listItems2">%%EQUIPMENT%%</td>
                  </tr>
                  <tr> 
                    <td height="1" colspan="3" style="background-image:url(\'nvi/horizontalDottieB.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>
                  <tr> 
                    <td align="right" valign="middle" class="listItems" nowrap>rate it</td>
                    <td style="background-image:url(\'nvi/verticalDottieB.gif\');background-repeat:repeat-y;"><img src="nvi/spacer.gif" width="1" height="1"></td>
                    <td align="left" valign="top" class="listItems2" nowrap>%%RATING%%</td>
                  </tr>
                  <tr> 
                    <td height="1" colspan="3" style="background-image:url(\'nvi/horizontalDottieB.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>

                  <tr> 
                    <td align="right" valign="top" class="listItems" nowrap>added</td>
                    <td width="1" style="background-image:url(\'nvi/verticalDottieB.gif\');background-repeat:repeat-y;"><img src="nvi/spacer.gif" width="1" height="1"></td>
                    <td align="left" valign="top" class="listItems2">%%ADDEDON%%</td>
                  </tr>
                  <tr> 
                    <td height="1" colspan="3" style="background-image:url(\'nvi/horizontalDottieB.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>

				  
				  
                  <tr> 
                    <td align="right" valign="top" class="listItems" nowrap>albums</td>
                    <td style="background-image:url(\'nvi/verticalDottieB.gif\');background-repeat:repeat-y;"><img src="nvi/spacer.gif" width="1" height="1"></td>
                    <td align="left" valign="top" class="listItems2" nowrap>%%INALBUMS%%</td>
                  </tr>
                  <tr> 
                    <td height="1" colspan="3" style="background-image:url(\'nvi/horizontalDottieB.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>
                  <tr> 
                    <td align="right" valign="top" class="listItems" nowrap>keywords</td>
                    <td style="background-image:url(\'nvi/verticalDottieB.gif\');background-repeat:repeat-y;"><img src="nvi/spacer.gif" width="1" height="1"></td>
                    <td align="left" valign="top" class="listItems2" nowrap>%%KEYWORDS%%</td>
                  </tr>
                  <tr> 
                    <td height="1" colspan="3" style="background-image:url(\'nvi/horizontalDottieB.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>
				  
                  <tr> 
                    <td height="1" colspan="3" style="background-image:url(\'nvi/horizontalDottieB.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>
                </table>
                  <table width="290" border="0" cellspacing="0" cellpadding="0">
                    <tr> 
                      <td align="center" valign="bottom" height="15"><img src="nvi/photo_tableBot2.gif" width="450" height="15"></td>
                    </tr>
                  </table>

                </td>
              <td width="1" valign="bottom" style="background-image:url(\'nvi/spacer.gif\');background-repeat:repeat-y;"><img src="nvi/whiteSpacer.gif" width="1" height="35"></td>
            </tr>
                  <tr> 
                    <td height="1" colspan="5" style="background-image:url(\'nvi/horizontalDottie.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>
      			  <tr>
			        <td colspan="5"><img src="nvi/spacer.gif" width="1" height="1"></td>
			      </tr>
                  <tr> 
                    <td height="1" colspan="5" style="background-image:url(\'nvi/horizontalDottie.gif\');background-repeat:repeat-x;"><img src="nvi/spacer.gif" width="450" height="1"></td>
                  </tr>
      			  <tr>
			        <td colspan="5"><img src="nvi/spacer.gif" width="1" height="15"></td>
			      </tr>

          </table>

		
		</td>
	</tr>
</table>
</center>
<br><br>
	
	';
	my $thisPage = "showPics";
	&beginPage;

	
	my $fileDirName = param('albumChoice');
	
	if ($fileDirName eq "random") {
		my @albums = &getAlbums;
		$myACount = @albums;
		$randomAC = int( rand($myACount));
		$fileDirName = "$albums[$randomAC]";
		$FORM{'albumChoice'} = "$fileDirName";
	}
	

	my $list_dir;
	if ($servertype eq "unix") { $list_dir = "$parentDirectory" . "/" . "$fileDirName"; }
	else { $list_dir = "$parentDirectory" . "\\" . "$fileDirName"; }

	my @files;

	if (!param('albumChoice')) { &error('You Must Choose an Album'); }
	if ($fileDirName eq "Choose") { &error('You Must Choose an Album'); }
	if (opendir(DIR,"$list_dir") == 1) { 
		@files = readdir(DIR); 
		closedir(DIR); 
	}
	else { &error('Cannot Open Directory'); } 
	if ($files[0] eq '.') {shift(@files);} 
	if ($files[0] eq '..') {shift(@files);}

	@files = sort { $b <=> $a } @files;
	my $total = scalar(@files);
	my $showPic = param('startPic');
	if ($showPic<0) {$showPic=0;}
		
	my $showDates = param('showDates');	 
	my $startPic = $showPic;
	my $quantity = param('amountOfPhotos');
	my $endPic = $showPic + $quantity;	
	my $prevPage = $showPic - $quantity;
	my $nextPage = $endPic;
	my $showDirName = $fileDirName;
	$showDirName =~ s/_/ /g;
	my $showThumbnails = param('Thumbnails');	


	if ($total eq "1"){ $cualTword = "Photo"; }
	else { $cualTword = "Photos"; }

	$BreadC = "<div class=\"breadCrumb\"><a href=\"/FotoBlog.htm\" style=\"color:#000000\">FotoBlog Home</a> &gt; <a href=\"/FotoBlog.htm?browseAll=1&albumChoice=random&PN=&doWhat=showPics&startPic=0&amountOfPhotos=10&Thumbnails=yes&showDates=yes&deleteInfo=Show\" style=\"color:#000000\" title=\"Album Browser\">Browser</a> &gt; %%BREADCRUMBO%% &gt;</font>";
	$numShowing = '<b>' . $total . '</b> ' . $cualTword . ' ( Showing <b>' . $startPic . '-' . $endPic . '</b> )';
	if ($total > $quantity) {
		$paging = "<td background=\"nvi/verticalDottie.gif\"><img src=\"nvi/spacer.gif\" border=\"0\" width=\"1\" height=\"20\"></td><td class=\"resultsBreakdown\" style=\"padding-top:5px;padding-left:10px;\">%%NUMPAGES%%</td>";
	}
	## $browseSlide = '<b>browse</b> | <a href="javascript:runSlideShow();" style="color:#337701;" title="Click to view this album as a SlideShow...">slideshow</a>';
	$PageContent =~ s/%%BREADCRUMB%%/$BreadC/gi;
	$PageContent =~ s/%%ALBUM_NAME%%/$showDirName/gi;
	$PageContent =~ s/%%NUMITEMS_SHOWING%%/$numShowing/gi;
	$PageContent =~ s/%%PAGING%%/$paging/gi;
	$PageContent =~ s/%%BROWSE_SLIDESHOW%%/$browseSlide/gi;
	
	
	
#	print "<table border=0 cellpadding=3 cellspacing=0 width=400>\n"; 
	if ($total ne "0") { 
#		print "<tr><td colspan=4>\n";
#			if ($total eq "1"){ print "$total photo is in this album\n"; }
#			else { print "$total photos are in this album\n"; }
#		print "</td></tr>\n"; 

		my $thing;
		$countTwos = 0;
		foreach $thing (@files) {
			if ($showPic < $endPic){
				my $item = $files[$showPic];

				my $itemPathname;

				if ($servertype eq "unix") { $itemPathname = "$parentDirectory" . "/" . "$fileDirName" . "/" . "$item"; }
				else { $itemPathname = "$parentDirectory" . "\\" . "$fileDirName"  . "\\" . "$item"; }

				$showPic++;
				if (-e $itemPathname) {
				 	if (-d $itemPathname) {next;}
					my $tempstring = $item;	# get name of file
					my @DateDisplExt = split(/\./,$tempstring);
					my $recordDate = $DateDisplExt[0];
					my $display = $DateDisplExt[1];
					$display =~ s/_/ /g;
#					print "\n\n<tr valign=top><td align=left>\n";
#						print start_form,
#						print "<input type=hidden name=doWhat  value=showSinglePhoto><input type=hidden name=displayAlbum  value=$fileDirName><input type=hidden name=pictureNumber value=$showPic><input type=submit value=\"View \# $showPic\"> "; 
#						end_form;
#						print "<td width=180 align=right>";
#						print "$display<br>\n";
#					if ($showDates eq "yes"){
#						print "<font size=-1><i>Posted on: $recordDate</i></font><br>\n"; 
#					}
#					print "</td><td width=20><br></td><td width=150>\n";
#					print "</td></tr><tr><td colspan=4><center><hr width=400></td></tr>\n";
					$countTwos++;
					if ($countTwos eq "2") { $countTwos = 0; $CTs = '<br>'; } 
					else { $CTs = ''; }

					use DBI;
					my $dbh = DBI->connect("DBI:mysql:NVF".$thyHost,$thyRU,$thyRP) or die "Unable to connect to database: <b>$elDB</b>\n"; 
					$dbh->{RaiseError} = 1; 
					$sth = $dbh->prepare("SELECT * FROM losPhotos where FileName='$item';");
					$sth->execute or die "Unable to execute query\n";
					my @row;
					while(@row = $sth->fetchrow_array) { $MPID = int($row[0]); }
					$sth->execute or die "Unable to execute query\n"; 
					$sth->finish;
					$dbh->disconnect;

					push(@allPs,"<a href=\"?browseAll=1&albumChoice=$fileDirName&PN=$MPID&doWhat=showPics&startPic=0&amountOfPhotos=10&Thumbnails=yes&showDates=yes&deleteInfo=Show\" title=\"Click to view photography information\"><img src=\"$parentURL/$fileDirName/$item\" style=\"margin:5px;border:#000000 1px solid;\" width=\"105\" align=\"top\"></a>$CTs");
					push(@allLargePs,"$item");
				}
			}
			else { last; }
		}
	}

	if ($total eq "0") {
		print "Sorry, no photos have been posted here yet!!";
		if ($showPhotoPostOption = "yes") {
#			print start_form,
#			"<input type=hidden name=doWhat value=postForm>\n",
#			submit(-value=>'Post Pictures'),
#			end_form; 
		}
#		print "</td></td></tr><br>\n";
	}

	foreach $APS (@allPs) {
		$allAPS =  $allAPS . $APS;
	}

	use DBI;
	my $dbh = DBI->connect("DBI:mysql:NVF".$thyHost,$thyRU,$thyRP) or die "Unable to connect to database: <b>$elDB</b>\n"; 
	$dbh->{RaiseError} = 1; 

	### -->> parse LARGE/MAIN photo and information
	### -->> pick random large
	if (param('PN')) {
		$AID = int( param('PN') );
		$sth = $dbh->prepare("SELECT * FROM losPhotos where ImageID='$AID';");
	}
	else { 	
		$myCount = @allLargePs;
		$random = int( rand($myCount));
		$FileName = "$allLargePs[$random]";
		$sth = $dbh->prepare("SELECT * FROM losPhotos where FileName = '$FileName';");
	}

	$sth->execute or die "Unable to execute query\n";
		my @row;
		while(@row = $sth->fetchrow_array) { 
			$PID = $row[0];
			$ImageType = $row[1];
			$FileName = $row[2];
			$Width = $row[3];
			$Height = $row[4];
			$ArtComment = $row[5];
			$UserComment = $row[6];
			$Equipment = $row[7];
			$Rating = $row[8];
			$RateSheet = $row[9];
			$AddedOn = $row[10];
			$Owner = $row[11];
			$Keywords = $row[12];
			$Views = $row[13];
			$Private = $row[14];
			$Albums = $row[15];
			$Galleries = $row[16];
			$Sets = $row[17];
			$PCount++;
		}
	$sth->execute or die "Unable to execute query\n"; 
	$sth->finish;	
	

	if (int($Owner) > 0) {
		
		$albumNombre = "$FORM{'albumChoice'}";
		$sth = $dbh->prepare("SELECT LastUpdated FROM Albums where Title = '$albumNombre';");
		$sth->execute or die "Unable to execute query\n"; 
		my @row;
		while(@row = $sth->fetchrow_array) { 
			$LAD = $row[0];
		}
		$sth->execute or die "Unable to execute query\n"; 
		$sth->finish;

		$Owner = int($Owner);
		$sth = $dbh->prepare("SELECT * FROM vAcctsNew where AccountID = '$Owner';");
		$sth->execute or die "Unable to execute query\n"; 
		my @row;
		while(@row = $sth->fetchrow_array) { 
			$UID = $row[0];
			$UN = $row[1];
			$FN = $row[2];
			$LN = $row[3];
			$LastPost = $row[5];
		}
		$sth->execute or die "Unable to execute query\n"; 
		$sth->finish;
		
		$UID = int($UID);

		if ($UN ne "") {

			($mdt1, $mtm1) = split(/ /,$LAD);
			($myr1, $mmt1, $mdy1) = split(/-/,$mdt1);
			$LastUpdateSHORT = $months[int($mmt1-1)] . " " . $mdy1 . ", " . $myr1;

			$miPile = "<table cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td class=\"albumLastUp\" align=\"right\" valign=\"bottom\" height=\"18\">Updated $LastUpdateSHORT</td><td valign=\"right\" rowspan=\"2\" style=\"padding-top:0px;\"><img src=\"ufoto.htm?myPhoto=0&elPhotoID=$UID\" width=\"30\" height=\"30\" border=\"0\" hspace=\"10\" style=\"border:#000000 1px solid;\"></td></tr><tr><td class=\"albumOwner\" align=\"right\" valign=\"top\" style=\"padding-top:0px;\">by <u>$UN</u></td></tr></table>";
		}
	}	
	
	($mdt, $mtm) = split(/ /,$AddedOn);
	($myr, $mmt, $mdy) = split(/-/,$mdt);
	$AddedOnSHORT = $months[int($mmt-1)] . " " . $mdy . ", " . $myr;
	
	
	if ($Albums =~ ",") { @splitALB = split(/,/,$Albums); }
	elsif (int($Albums) > 0) { $splitALB[0] = $Albums; }
	if (@splitALB) {
		foreach $sALB (@splitALB) {
			$sth = $dbh->prepare("SELECT Title FROM Albums where AlbumID = '$sALB';");
			$sth->execute or die "Unable to execute query\n"; 
				my @row;
				while(@row = $sth->fetchrow_array) { 
					$ATit = $row[0];
					$ATitC = $ATit;
					$ATit =~ s/_/ /gi;
					$ATit =~ s/`/'/gi;
					push(@losAlbums,"<a href=\"http://www.nightvisiononline.com/FotoBlog.htm?browseAll=1&albumChoice=$ATitC&PN=&doWhat=showPics&startPic=0&amountOfPhotos=10&Thumbnails=yes&showDates=yes&deleteInfo=Show\" style=\"color:#D6D6D6;\">$ATit</a>");
				}
			$sth->execute or die "Unable to execute query\n"; 
			$sth->finish;
		}
		$todosAlbums = join(', ',@losAlbums);
	}
	else {
		$todosAlbums = '';
	}

	$dbh->disconnect; 

	
	### -->> MAIN photo layout
	$fiC=0;
	foreach $fi (@files) {
		$fiC++;
		if ($fi eq "$FileName") { $picNum = $fiC; }
	}
	$myClicker = "javascript:cualPicture=$picNum;runSlideShow();";
	$thePhotoCall = "<a href=\"$myClicker\" title=\"Click to toggle Album SlideShow...\"><img src=\"$parentURL/$fileDirName/$FileName\" style=\"border:#000000 1px solid;\" width=\"400\"></a>";

	
	if ($ArtComment ne "") {
		$ArtComment =~ s/\n/<br>/gi;
		$ArtComment =~ s/\r//gi; ## remove unwanted
		$ArtComment =~ s/\t//gi; ## remove unwanted
		$ArtComment =~ s/\n//gi; ## remove unwanted
		$ArtComment =~ s/\f//gi; ## remove unwanted
		$ArtComment =~ s/^\s+//g; ### remove leading spaces
		$ArtComment =~ s/\s+$//g; ### remove trailing spaces
		$ArtComment =~ s/"/'/gi;
	}
	else {
		$ArtComment = "no comment";
	}	
	
	if ($Rating =~ "-----") {
		@splitRating = split(/-----/,$Rating);
		$rating = $splitRating[0];
		$votes = $splitRating[1];
	}
	else { $rating = '0'; $votes = '0'; }

	$PID = int($PID);
	$currentRate = "starRate_blackBG_" . $rating . "star";	
	$rateImage  = "<table><tr><td style=\"padding-bottom:3px;\" width=\"28\" width=\"69\" align=\"center\"><a href=\"javascript:void(0);\" onMouseOut=\"setCurrentStar($rating,$PID);\"><img src=\"nvi/" . $currentRate . ".gif\" height=\"13\" width=\"64\" border=\"0\" name=\"StarRatesBlack\" id=\"StarRates\" usemap=\"#StarRates\" style=\"cursor:pointer;\"></a></td><td style=\"padding-bottom:3px;color:#D6D6D6;cursor:arrow;\" class=\"photoSmall\" align=\"center\" title=\"$votes total user votes\" nowrap>&nbsp; [<span title=\"$votes total user votes\">&nbsp;$votes Votes&nbsp;</span>]</td></tr></table>"; 

	if ($UserComment ne "") {
		$UserComment =~ s/\n/<br>/gi;
		$UserComment =~ s/\r//gi; ## remove unwanted
		$UserComment =~ s/\t//gi; ## remove unwanted
		$UserComment =~ s/\n//gi; ## remove unwanted
		$UserComment =~ s/\f//gi; ## remove unwanted
		$UserComment =~ s/^\s+//g; ### remove leading spaces
		$UserComment =~ s/\s+$//g; ### remove trailing spaces
		$UserComment =~ s/"/'/gi;
		if ($UserComment =~ "-----xxxxx-----"){ @allUCs = split(/-----xxxxx-----/,$UserComment); $eplur1 = 'entries'; $eplur2 = 'Entries'; }
		else { $allUCs[0] = $UserComment; $eplur1 = 'entry'; $eplur2 = 'Entry'; }
		$CUC = int(@allUCs);
		$theUCs = "<table><tr><td style=\"padding-bottom:3px;color:#D6D6D6;\" align=\"center\" class=\"photoSmall\" title=\"View blog $eplur1\" nowrap><a href=\"\" style=\"color:#D6D6D6\">$CUC $eplur2</a></td><td style=\"padding-bottom:3px;color:#D6D6D6;cursor:arrow;\" class=\"photoSmall\" align=\"center\" title=\"Add new blog entry\" nowrap>&nbsp; [<span title=\"Add new blog entry\">&nbsp;<a href=\"\" style=\"color:#D6D6D6\">add</a>&nbsp;</span>]</td></tr></table>";
	}
	else { $theUCs = "<table><tr><td style=\"padding-bottom:3px;color:#D6D6D6;\" align=\"center\" class=\"photoSmall\" nowrap>no entries</td><td style=\"padding-bottom:3px;color:#D6D6D6;cursor:arrow;\" class=\"photoSmall\" align=\"center\" title=\"Add new blog entry\" nowrap>&nbsp; [<span title=\"Be the first to comment on this photograph, add a blog entry!\">&nbsp;<a href=\"\" style=\"color:#D6D6D6\">add</a>&nbsp;</span>]</td></tr></table>"; }
	
	$aName = "<a href=\"http://www.nightvisiononline.com/NVOF_Messenger.htm?mySub=FotoBlogMessaging&UID=$UID&PID=$PID\" title=\"Click to message this user\" style=\"color:#D6D6D6\">$UN</a>";
	$aNameBC = "<a href=\"#\" title=\"View " . $UN . "'s Album Showcase\" style=\"color:#000000\">$UN</a>";
	
	$jpg = '.jpg';
	$png = '.png';
	$FileNameClean = substr($FileName, 9);
	$FileNameClean =~ s/$jpg//gi;
	$FileNameClean =~ s//$png/gi;
	$FileNameClean =~ s/_/ /gi;
	$FileNameClean =~ s/`/'/gi;

	
	
	if ($Keywords =~ ",") { @splitKEYS = split(/,/,$Keywords); }
	elsif (int($Keywords) > 0) { $splitKEYS[0] = $Keywords; }	
	$todosKeys = join(', ',@splitKEYS);
	
	
	
	
	$PageContent =~ s/%%ALBUM_SPIT%%/$allAPS/gi;
	$PageContent =~ s/%%LARGE_PHOTO%%/$thePhotoCall/gi;
	$PageContent =~ s/%%EQUIPMENT%%/$Equipment/gi;
	$PageContent =~ s/%%ART_COMMENTS%%/$ArtComment/gi;
	$PageContent =~ s/%%RATING%%/$rateImage/gi;
	$PageContent =~ s/%%USER_COMMENTS%%/$theUCs/gi;
	$PageContent =~ s/%%ALBUM_OWNER%%/$aName/gi;
	$PageContent =~ s/%%IMAGE_TITLE%%/$FileNameClean/gi;
	$PageContent =~ s/%%INALBUMS%%/$todosAlbums/gi;
	$PageContent =~ s/%%KEYWORDS%%/$todosKeys/gi;
	$PageContent =~ s/%%BREADCRUMBO%%/$aNameBC/gi;
	$PageContent =~ s/%%OWNERINFO%%/$miPile/gi;
	$PageContent =~ s/%%ADDEDON%%/$AddedOnSHORT/gi;



	
	
#	print "\n\n";
#	print "<table border=0 cellpadding=3 cellspacing=0 width=400>\n<tr><td colspan=4>\n";
#	print "<center>\n<table cellpadding=6 background=0>\n<tr valign=top>\n";

#	print "<td width=130 align=right>";
	my $whatNow = "showPics";
	my $tempcount = "0";
	if ($startPic ne "0"){			
#		print start_form;			
#		print "<input type=hidden name=doWhat value=$whatNow>\n",
#		"<input type=hidden name=albumChoice value=$fileDirName>\n",
#		"<input type=hidden name=Thumbnails value=$showThumbnails>\n",
#		"<input type=hidden name=amountOfPhotos value=$quantity>\n",
#		"<input type=hidden name=startPic value=$prevPage>\n",
#		"<input type=hidden name=showDates value=$showDates>\n",
#		submit(-value=>'<-- Previous'),
#		end_form; 
		$tempcount++; 
		$myPrev = "<a href=\"?doWhat=$whatNow&albumChoice=$fileDirName&Thumbnails=$showThumbnails&amountOfPhotos=$quantity&startPic=$prevPage&showDates=$showDates\" style=\"color:#337701;\">&lt;&lt; Prev</a>";
	}

#	print "</td>\n<td width=140 align=center>";


#	print "</td>\n<td width=130 align=left>";
	if (($endPic < $total) && ($total ne "0")){		
#		print start_form;			
#		print "<input type=hidden name=doWhat value=$whatNow>\n",
#		"<input type=hidden name=albumChoice value=$fileDirName>\n",
#		"<input type=hidden name=Thumbnails value=$showThumbnails>\n",
#		"<input type=hidden name=amountOfPhotos value=$quantity>\n",
#		"<input type=hidden name=startPic value=$nextPage>\n",
#		"<input type=hidden name=showDates value=$showDates>\n",
#		submit(-value=>'Next -->'),
#		end_form; 
		$tempcount++; 
		$myNext = "<a href=\"?doWhat=$whatNow&albumChoice=$fileDirName&Thumbnails=$showThumbnails&amountOfPhotos=$quantity&startPic=$nextPage&showDates=$showDates\" style=\"color:#337701;\">Next &gt;&gt;</a>";
	}

	$PageContent =~ s/%%NUMPAGES%%/$myPrev $myNext/gi;

#	print "</td></tr>\n</table></tr></table>\n";			
	
	print "
	<script>
		parent.cualAlbum = '$fileDirName';
		parent.PID = '$PID';
		parent.loggedIn = '$CSen';
	</script>";
	&endPage($thisPage);
}









##################################################################
# Here we take the input from the delete form (part of the
# showPics routine) to delete the file specified.
##################################################################
sub showSinglePhoto {
	my $thisPage = "showPics";
	&beginPage;
	
	my $pictureNumber = param('pictureNumber');
	my $albumName = param('displayAlbum');
	my $albumDisplay = $albumName;
	$albumDisplay =~ s/_/ /g;

	if ($servertype eq "unix") {
		opendir(ALBUM,"$parentDirectory/$albumName");
	}
	else {
		opendir(ALBUM,"$parentDirectory\\$albumName");
	}
	my @files = readdir(ALBUM);
	closedir(ALBUM);
	while ($files[0] =~ /^\./) { shift(@files);}
	@files = sort { $b <=> $a } @files;
	my $total = scalar(@files);

	my $thisNumber = $pictureNumber;
	$thisNumber--;
	my $fileName = $files[$thisNumber];
	my $prevNo = $pictureNumber;
	my $nextNo = $pictureNumber;
	$prevNo--;
	$nextNo++;

	my $item = $fileName;
	my @DateDisplExt = split(/\./,$item);
	my $recordDate2 = $DateDisplExt[0];
	my $displayName = $DateDisplExt[1];
	$displayName =~ s/_/ /g;
	my $itemPathName;

	if ($servertype eq "unix") {
		$itemPathName = "$parentURL" . "/" . "$albumName" . "/" . "$fileName";
	}
	else {
		$itemPathName = "$parentURL" . "\\" . "$albumName"  . "\\" . "$fileName";
	}

	
	## -->> GET IMAGE INFO FROM DB	(add condition for those albums without photos in DB)
	if ($fileName =~ ".") {
		use DBI;
		my $dbh = DBI->connect("DBI:mysql:NVF".$thyHost,$thyRU,$thyRP) or die "Unable to connect to database: <b>$elDB</b>\n"; 
		$dbh->{RaiseError} = 1; 

		$sth = $dbh->prepare("SELECT * FROM losPhotos where FileName = '$fileName';");
		$sth->execute or die "Unable to execute query\n"; 
			my @row;
			while(@row = $sth->fetchrow_array) { 
				$ImageType = $row[1];
				$FileName = $row[2];
				$Width = $row[3];
				$Height = $row[4];
				$ArtComment = $row[5];
				$UserComment = $row[6];
				$Equipment = $row[7];
				$Rating = $row[8];
				$RateSheet = $row[9];
				$AddedOn = $row[10];
				$Owner = $row[11];
				$Keywords = $row[12];
				$Views = $row[13];
				$Private = $row[14];
				$Albums = $row[15];
				$Galleries = $row[16];
				$Sets = $row[17];
				$PCount++;
			}
		$sth->execute or die "Unable to execute query\n"; 
		$sth->finish;	

		$sth = $dbh->prepare("SELECT * FROM userBase where UserID = '$Owner';");
		$sth->execute or die "Unable to execute query\n"; 
			my @row;
			while(@row = $sth->fetchrow_array) { 
				$FN = $row[12];
				$LN = $row[13];
			}
		$sth->execute or die "Unable to execute query\n"; 
		$sth->finish;	
		$dbh->disconnect; 
	}
	
	$an = $albumName;
	$an =~ s/_/ /gi;

	$totalMove = int($Height + 89);

	if ($ArtComment ne "" && $ArtComment ne " ") { $hasArtistComments = '1'; }
	else { $hasArtistComments = '0'; }	
	
	print qq~ 
	<script language="Javascript">
		parent.PID = '$PID';
		parent.loggedIn = '$Cookies{'Logged'}';
		parent.hasArtistComments = '$hasArtistComments';
		
	</script>
	~;
	
	$scriptPageLayout = '';
	$tWidth = int($Width + 2);
	##-->> JAVASCRIPT SPIT $scriptPageLayout
	$scriptPageLayout = "<table width='$tWidth' align='center' cellpadding='10' cellspacing='0' border='0'>";

	print "<center><img src=$itemPathName border=0><hr width=400><font size=-1><i>This image was posted on $recordDate2\n</i></font><br>Picture Number $pictureNumber of $total<br>\n";
	print "<table><tr valign=top><td width=130 align=right>";
	if ($prevNo > 0) {
		print "<a href=\"?doWhat=showSinglePhoto&pictureNumber=$prevNo&displayAlbum=$albumName\"><--Previous</a>";
		$PREV = "Slideshow.htm?doWhat=showSinglePhoto&pictureNumber=$prevNo&displayAlbum=$albumName";
		#print start_form,
	}

	print " </td><td width=140 align=center>";
	print "<a href=\"?doWhat=showPics&startPic=$showPic&amountOfPhotos=$quantity&Thumbnails=yes&showDates=yes&deleteInfo=Show&albumChoice=$albumName\">Show Entire Album</a>";
	#print start_form;
	print "</td><td width=130 align=left>";

	if ($pictureNumber < $total) {
		print "<a href=\"?doWhat=showSinglePhoto&pictureNumber=$nextNo&displayAlbum=$albumName\">Next--></a>";
		$PNUM = "Slideshow.htm?doWhat=showSinglePhoto&pictureNumber=$nextNo&displayAlbum=$albumName";
		#print start_form,
	}
	print "</td></tr></table><hr width=400></td></tr></table>";

	## THIS NUM FOR JAVASCRIPT VAR (comment add = return back with comment viewable)
	$TNUM = "Slideshow.htm?doWhat=showSinglePhoto&pictureNumber=$pictureNumber&displayAlbum=$albumName";
	
	
	$MdisplayName = "`" . $displayName . "`";
	$PNUM =~ s/'/`/gi;
	$PREV =~ s/'/`/gi;
	$scriptPageLayout = $scriptPageLayout . "<tr height=\"5\"><td width=\"100\"><img src=\"nvi/spacer.gif\" border=\"0\" width=\"100\" height=\"5\"></td><td width=\"100%\"><img src=\"nvi/spacer.gif\" border=\"0\" width=\"1\" height=\"1\"></td><td width=\"100\"><img src=\"nvi/spacer.gif\" border=\"0\" width=\"100\" height=\"1\"></td></tr><tr><td style=\"border-left:#FFFFFF 1px solid;border-top:#FFFFFF 1px solid;border-bottom:#FFFFFF 1px solid;\">";
	if ($prevNo > 0) { $scriptPageLayout = $scriptPageLayout . "<a class=\"photoSmallest\" style=\"color:#009900;font-family:verdana,arial,helvetica;\" href=javascript:clearGalleryBody();trigger('$PREV');><< Previous</a>"; }
	else { $scriptPageLayout = $scriptPageLayout . "<img src=\"nvi/spacer.gif\" border=\"0\" width=\"1\" height=\"1\">"; }
	$scriptPageLayout = $scriptPageLayout . "</td><td class=\"photoSmallest\" style=\"color:#FFFFFF;font-size:11px;font-family:verdana,arial;border-top:#FFFFFF 1px solid;border-bottom:#FFFFFF 1px solid;\" align=\"center\">";
	if ($displayName ne "") { $scriptPageLayout = $scriptPageLayout . "<i>$MdisplayName</i>"; }
	else { $scriptPageLayout = $scriptPageLayout . "<nobr>. . . album has no photos . . .</nobr>"; }
	$scriptPageLayout = $scriptPageLayout . "</td><td align=\"right\" style=\"border-right:#FFFFFF 1px solid;border-top:#FFFFFF 1px solid;border-bottom:#FFFFFF 1px solid;\">";
	if ($pictureNumber < $total) { $scriptPageLayout = $scriptPageLayout . "<a class=\"photoSmallest\" style=\"color:#009900;font-family:verdana,arial,helvetica;\" href=javascript:clearGalleryBody();trigger('$PNUM'); >Next >></a>"; }
	else { $scriptPageLayout = $scriptPageLayout . "<img src=\"nvi/spacer.gif\" border=\"0\" width=\"1\" height=\"1\">"; }
	$scriptPageLayout = $scriptPageLayout . "</td></tr></table>";
	if ($displayName ne "") { $scriptPageLayout = $scriptPageLayout . "<center><a href=\"javascript:parent.hideSlideShow();\" title=\"Hide SlideShow\"><img src=\"$itemPathName\" border=\"0\" width=\"$Width\" height=\"$Height\" style=\"border:#FFFFFF 1px solid;margin-top:1px;\" alt=\"Hide SlideShow\"></a></center>"; }	

	if ($Rating =~ "-----") {
		@splitRating = split(/-----/,$Rating);
		$rating = $splitRating[0];
		$votes = $splitRating[1];
	}
	else { $rating = '0'; $votes = '0'; }


	## image height minus amount top placement
	$mHeight = int($Height - 3);
	$scriptPageLayout = $scriptPageLayout . "<div id=\"rateComment\" style=\"position:relative;top:-$mHeight;left:0px;z-index:10;\"><table width=\"$tWidth\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td align=\"left\" style=\"padding-left:5px;\"><img src=\"nvi/photo_box_userrating.gif\" id=\"rateBox\" style=\"opacity: 0.80;-moz-opacity: 0.80;filter:alpha(opacity=80);\"></td><td width=\"100%\">&nbsp;</td><td align=\"right\" style=\"padding-right:5px;\"><img src=\"nvi/photo_box_comments.gif\" id=\"commentsBox\" style=\"opacity: 0.80;-moz-opacity: 0.80;filter:alpha(opacity=80);\"></td></tr></table></div>";

	## secondary layer overlay
	$mHeight2 = int($mHeight + 44);
	$scriptPageLayout = $scriptPageLayout . "<div id=\"rateCommentData\" style=\"position:relative;top:-$mHeight2;left:0px;z-index:20;\"><table width=\"$tWidth\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\"><tr><td><img src=\"nvi/spacer.gif\" height=\"1\" width=\"140\"></td><td width=\"100%\"><img src=\"nvi/spacer.gif\" height=\"1\" width=\"1\"></td><td><img src=\"nvi/spacer.gif\" height=\"1\" width=\"140\"></td></tr><tr valign=\"bottom\"><td align=\"center\" style=\"padding-left:5px;color:#FFFFFF;\" class=\"photoSmallest\" nowrap>";

	$currentRate = "starRate_blackBG_" . $rating . "star";	
	$scriptPageLayout = $scriptPageLayout . "<table><tr><td style=\"padding-bottom:7px;color:#FFFFFF;cursor:hand;\" class=\"photoSmallest\" valign=\"bottom\" width=\"32\" align=\"center\" title=\"$rating star rating\">$rating</td><td style=\"padding-bottom:7px;\" width=\"28\" width=\"69\" align=\"center\"><a onMouseOver=setCurrentStar($rating,$PID); href=javascript:trigger('');><img src=\"nvi/" . $currentRate . ".gif\" height=\"13\" width=\"64\" border=\"0\" name=\"StarRatesBlack\" id=\"StarRates\" usemap=\"#StarRates\"></a></td><td style=\"padding-bottom:7px;color:#FFFFFF;cursor:hand;\" class=\"photoSmallest\" valign=\"bottom\" width=\"32\" align=\"center\" title=\"$votes total user votes\">$votes</td></tr></table>"; 
	$scriptPageLayout = $scriptPageLayout . "</td><td width=\"100%\"><img src=\"nvi/spacer.gif\" height=\"44\" width=\"1\"></td><td align=\"center\" style=\"font-family:verdana,arial;padding-right:5px;color:#FFFFFF;padding-bottom:9px;\" class=\"photoSmallest\">";
	
	
		if ($ArtComment ne "" && $ArtComment ne " ") { $hasArtistComments = '1'; }
		else { $hasArtistComments = '0'; }
	
	
	## withuser comments
	if ($UserComment ne "" && $UserComment ne "null" && $UserComment ne "Null") { 
		$elDel = '-----xxxxx-----';
		if ($UserComment =~ "$elDel") { @myUC = split(/$elDel/,$UserComment); }
		else {
			$myUC[0] = "$UserComment";
		}
		$cUC=0;
		foreach (@myUC) { $cUC++; }
		if ($cUC > 1) { $extraS = 'comments'; } else { $extraS = 'comment'; }
		$scriptPageLayout = $scriptPageLayout . "<a href=\"javascript:hasArtistComments = $hasArtistComments; addComment();\" title=\"$cUC user $extraS... Care to add a comment?\" style=\"color:#ffffff;text-decoration:none;\">$cUC</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href=\"javascript:viewComments();\" style=\"color:#009900;\" id=\"commentTrigger\" nowrap><u title=\"Click to view user $extraS...\">view</u></a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href=\"javascript:hasArtistComments = $hasArtistComments; addComment();\" style=\"color:#009900;\" id=\"addCTrigger\"><u title=\"Click to add a comment to this photograph...\">add</u></a>";
	}
	## without user comments
	else { $scriptPageLayout = $scriptPageLayout . "<a href=\"javascript:hasArtistComments = $hasArtistComments; addComment();\" title=\"0 (zero) user comments at this time. Care to add one?\" style=\"color:#ffffff;text-decoration:none;\">0</a>&nbsp;&nbsp;|&nbsp;&nbsp;<a href=\"javascript:hasArtistComments = $hasArtistComments; addComment();\" style=\"color:#009900;\" id=\"addCTrigger\"><u title=\"Click to add a comment to this photograph...\">add</u></a>"; }
	
	$scriptPageLayout = $scriptPageLayout . "</td></tr></table></div>";
	
	
	
	if ($ArtComment ne "") {
		$ArtComment =~ s/\n/<br>/gi;
		$ArtComment =~ s/\r//gi; ## remove unwanted
		$ArtComment =~ s/\t//gi; ## remove unwanted
		$ArtComment =~ s/\n//gi; ## remove unwanted
		$ArtComment =~ s/\f//gi; ## remove unwanted
		$ArtComment =~ s/^\s+//g; ### remove leading spaces
		$ArtComment =~ s/\s+$//g; ### remove trailing spaces
		$ArtComment =~ s/"/'/gi;
		$scriptPageLayout = $scriptPageLayout . "<div id=\"theComments\" style=\"z-index:15;position:relative;top:-89;left:0px;\"><table width=\"$tWidth\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"margin-top:1px;border:#FFFFFF 1px solid;opacity: 0.90;-moz-opacity: 0.90;filter:alpha(opacity=90);\" bgcolor=\"#000000\"><tr><td valign=\"bottom\" height=\"25\" class=\"photoSmallest\" align=\"center\" style=\"padding:2px;color:#919191;letter-spacing:10px;\"><i><div id=\"viewCommentsT\">ARTIST'S COMMENTS</div></i></td></tr><tr><td height=\"1\" bgcolor=\"#009900\"><img src=\"nvi/spacer.gif\" border=\"0\" width=\"1\" height=\"1\"></td></tr><tr><td><div id='viewComments' class='photoSmallest' style='padding:10px;color:#FFFFFF;'></div></td></tr></table></div>";
	}
	else {
		$scriptPageLayout = $scriptPageLayout . "<div id=\"theComments\" style=\"z-index:15;position:relative;top:-89;left:0px;visibility:hidden;opacity: 0.80;-moz-opacity: 0.80;filter:alpha(opacity=80);\"><table width=\"$tWidth\" align=\"center\" cellpadding=\"0\" cellspacing=\"0\" border=\"0\" style=\"margin-top:1px;border:#FFFFFF 1px solid;opacity: 0.90;-moz-opacity: 0.90;filter:alpha(opacity=90);\" bgcolor=\"#000000\"><tr><td valign=\"bottom\" height=\"25\" class=\"photoSmallest\" align=\"center\" style=\"padding:2px;color:#919191;letter-spacing:10px;\"><i><div id=\"viewCommentsT\">USER COMMENTS</div></i></td></tr><tr><td height=\"1\" bgcolor=\"#009900\"><img src=\"nvi/spacer.gif\" border=\"0\" width=\"1\" height=\"1\"></td></tr><tr><td><div id='viewComments' class='photoSmallest' style='padding:10px;color:#FFFFFF;'></div></td></tr></table></div>";
	}



	if ($UserComment ne "") {
		$UserComment =~ s/\n/<br>/gi;
		$UserComment =~ s/\r//gi; ## remove unwanted
		$UserComment =~ s/\t//gi; ## remove unwanted
		$UserComment =~ s/\n//gi; ## remove unwanted
		$UserComment =~ s/\f//gi; ## remove unwanted
		$UserComment =~ s/^\s+//g; ### remove leading spaces
		$UserComment =~ s/\s+$//g; ### remove trailing spaces
		$UserComment =~ s/"/'/gi;
		if ($UserComment =~ "-----xxxxx-----"){ @allUCs = split(/-----xxxxx-----/,$UserComment); }
		else { $allUCs[0] = $UserComment; }
		$CUC = 0 ;
		foreach $AUC (@allUCs) {
			if ($CUC eq "0") { $theUCs = $AUC; }
			else { $theUCs = $theUCs . "<br><br><br><center style=\"color:#FFFFFF;\"><em>~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~ &nbsp; ~</em></center><br><br>" . $AUC; }
			$CUC++;
		}
		$scriptPageLayout = $scriptPageLayout . "<div id=\"userComments\" style=\"z-index-100;position:absolute;top:0;left:0px;width:1px;height:1px;visibility:hidden;overflow:hidden;\">$theUCs</div>";
	}



	
	$scriptPageLayout =~ s/"/'/gi;
	print qq~ 
	<script language="Javascript">
		if (parent.document && parent.document.getElementById) { 
			parent.TNUM = '$TNUM';
			parent.document.getElementById("photoGalleryBrowserBody").innerHTML = "$scriptPageLayout"; 
			if (parent.document.getElementById("viewComments")) {
				parent.document.getElementById("viewComments").innerHTML = "$ArtComment";
			}
		}
	</script>
	~;



	&endPage($thisPage);
}


##################################################################
# Heres the form that lets the user post files to the albums.
# It lists the existing albums and if required, gets the password
# from the user to allow posting.
##################################################################
sub postForm {
	my $thisPage = "postForm";
	print "\n<!-- Begin action: $thisPage -->\n";
	&beginPage;
	my @albums = &getAlbums;				
	my $numberOfAlbums = scalar(@albums);
	print "<hr width=400>";

	if (param('album')) {
		@albums = "";
		$albums[0] = param('album');
	}

	if ($numberOfAlbums eq "0"){			
		print "<!-- Display for No Albums Condition -->\n";
		print b('How Did You Get Here?'), br,
			b('There are no Albums Yet!'), br,
			b('Please Use the Add Album Button'),
			"<hr width=400>\n"; }

	if ($numberOfAlbums ne "0"){
		print start_form(-enctype=>'multipart/form-data'),
		"<input type=hidden name=doWhat value=postPics>",
		"Choose a Picture to Post:<br>\n";
		my $localSize = $maximumFileSize;	
    	$localSize = $localSize/1000;
		print filefield(-name=>'fileName',
		-size=>25, -maxlength=>150),
		br,
		"(maximum size $localSize K)",
		br,
		br;


		if ($numberOfAlbums eq "1"){			
			print "<!-- Display for Single Album Condition -->\n";
			print "<input type=hidden name=\"albumChoice\" value=$albums[0]>\n";
			my $display = $albums[0];		
			$display =~ s/_/ /g;			
			print "Your Photo will go into <i>$display</i>\n"; 
		}

		if ($numberOfAlbums gt "1"){		
			print "<!-- Display for Multiple Albums Condition -->\n";
			print b('Choose the Album:<br>');
			print "\n<select name=\"albumChoice\">\n";
			my $tempcount = 0;
			print "<option value=\"Choose\">Choose an Album</option>\n";
			my $albumName;
			foreach $albumName(@albums){
				my $display = $albumName;	
				$display =~ s/_/ /g;			
				print "<option value=$albumName>$display</option>\n";
				$tempcount++; 
			}
			print "</select>\n\n"; 
		}

		print "<br><br>Type a description:",
		br,
		textfield(-name=>'fileDescription', -default=>'',
			-size=>25, -maxlength=>100), br, br;

		if ($usePostingPassword ne 'no') {
			print "Enter your password:",
			br,
			password_field(-name=>'pwd',
			-value=>'',
			-size=>25,
			-maxlength=>30), br, br;
		}
		print submit(-value=>'Post my Picture'),
		end_form;
		print "<center><hr width=400>";
	}

	&endPage('$thisPage');
}







##################################################################
# Now to upload the pictures to the appropriate album.  Here, the
# bulk of the work is to take the user's description and create a
# new filename out of it, while editing the information to be 
# appropriate for the album name
##################################################################
sub postPics {
	my $thisPage = "postPics";
	print "\n<!-- Begin action: $thisPage -->\n";
	&beginPage;
	if ($showPhotoPostOption eq "no") { 
		&error('You Do Not Have Permissions To Post Photos'); 
	}
	my $password = param('pwd');
	if (($usePostingPassword eq "yes") && ($password ne $postingPassword)) {
		&error('Invalid Password'); 
	}
	my $myMaximumPost = $maximumFileSize + 1000;
	if ($ENV{'CONTENT_LENGTH'} > $myMaximumPost ) { 
		&error('That File Is Too Large!'); 
	}
	my $fileDecription = param('fileDescription');
	if ($fileDecription eq '') { 
		&error('You Must Enter A Description'); 
	}
	my $fileDirName = param('albumChoice');
	if ($fileDirName eq "Choose") { 
		&error('You Must Choose an Album'); 
	}
	my $file = param('fileName');
	my @fileNameParts = split(/\//,$file);
	$file = pop(@fileNameParts);
	
	@fileNameParts = split(/\\/,$file);
	$file = pop(@fileNameParts);
	
	my $name = $file;
	my $tempFileExtension = $file;
	my @fileNameInfo = split(/\./,$tempFileExtension);
	my $fileExtension = pop (@fileNameInfo);
	
	
	## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## 
	## This will be updated, check back at the website
	## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##
	if ($useMimeTypeDetection = "yes") {
		$file = param('fileName');
		my $info = uploadInfo ($file);
		my $realMimeType = $info -> {'Content-Type'};
		my $newExtension;

		if ($realMimeType =~ m/^image/i) {
			if ($realMimeType =~ m/gif$/i)  { $newExtension = "gif";  }
			if ($realMimeType =~ m/jpg$/i)  { $newExtension = "jpg";  }
			if ($realMimeType =~ m/jpeg$/i) { $newExtension = "jpg"; }
			if ($realMimeType =~ m/bmp$/i)  { $newExtension = "bmp";  }
			if ($realMimeType =~ m/png$/i)  { $newExtension = "png";  }
			if ( $fileExtension ne $newExtension ) { 
				print "Not a $fileExtension, but a $newExtension"; 
			}
			if (!$newExtension) { 
				$fileExtension eq $newExtension; 
			}
		}
		else { 
			print "\n<br>This Mime Type: $realMimeType<br>",
			"cannot be verified as an image file<br>\n"; 
		}
	}
	## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ## ##

	my $goodFileType = "no";
	my $extension;
	foreach $extension(@allowedFileExtensions) {
		if ($extension eq $fileExtension) {
			$goodFileType = "yes";
			last;
		}
	}
	if ($goodFileType eq "no") { 
		&error('That File Type Is Not Allowed'); 
	}
	my $newFileName = $fileDecription;
	$newFileName =~ s/^\s+//g; ### remove leading spaces
	$newFileName =~ s/\s+$//g; ### remove trailing spaces
	$newFileName =~ s/..\//_/g;  
	$newFileName =~ s/ /_/g;  
	$newFileName =~ s/\//_/g;    
	$newFileName =~ s/\"//g;
	$newFileName =~ s/'//g;
	$newFileName =~ s/\./_/g;
	$newFileName =~ s/,/_/g;
	$newFileName =~ s/:/_/g;
	$newFileName =~ s/\;/_/g;
	$newFileName =~ s/!/_/g;
	$newFileName =~ s/\@/_/g;
	$newFileName =~ s/\-/_/g;
	$newFileName =~ s/\+/_/g;
	$newFileName =~ s/\[/_/g;
	$newFileName =~ s/\]/_/g;
	$newFileName =~ s/\{/_/g;
	$newFileName =~ s/\}/_/g;
	$newFileName =~ s/\|/_/g;
	$newFileName =~ s/\?/_/g;
	$newFileName =~ s/</_/g;
	$newFileName =~ s/>/_/g;
	
	if ($usedAsAdultGallery = "no") {
		my $badword;
		foreach $badword(@badwords) {
			$newFileName =~ s/$badword//gi;
		}
	}
	my $i;
	for ($i=0, $i<10, $i++) {
		$newFileName =~ s/__/_/g; 
	}
	$newFileName =~ s/^_//g;
	$newFileName =~ s/_$//g;
	my $localFileName = join (".", $date, $newFileName, $fileExtension);
	if ($newFileName ne ""){
		my $fileTotalPath;
		my $fileTotalNewPath;
	
		if ($servertype eq"unix") {
			$fileTotalPath = "$parentDirectory/$fileDirName/$name";
			$fileTotalNewPath = "$parentDirectory/$fileDirName/$localFileName";
		}
		else {
			$fileTotalPath = "$parentDirectory\\$fileDirName\\$name";
			$fileTotalNewPath = "$parentDirectory\\$fileDirName\\$localFileName";
		}
		open(LOCAL, ">$fileTotalPath") or &error('Cannot Open New File');
		if ($servertype ne "unix") { binmode LOCAL; }
		while(<$file>) {
		   print LOCAL $_;	
		}
		close LOCAL or &error('Cannot Close New File');
		rename("$fileTotalPath","$fileTotalNewPath");
		# IF YOU ARE HAVING PERMISSIONS PROBLEMS, TRY UNCOMMENTING THE NEXT LINES
		# chmod(644, "$fileTotalNewPath");
	}
	else { &error('Come On Now, That Description Will Not Do!'); }
	my $displayPhoto = $newFileName;
	$displayPhoto =~ s/_/ /g;
	my $displayAlbum = $fileDirName;
	$displayAlbum =~ s/_/ /g;
	print "<hr width=400>\n",
	"<b>File Uploaded Successfully!</b><br><br>\n";
	print "\n$displayPhoto<br>\n",
	"is now posted in the Album<br>\n",
	"$displayAlbum<br>\n";
	print "<hr width=400>\n";
	&endPage('$thisPage');
}







##################################################################
# Here we take the input from the delete form (part of the
# showPics routine) to delete the file specified.
##################################################################
sub deletePics {
	my $thisPage = "deletePics";
	print "\n<!-- Begin action: $thisPage -->\n";
	&beginPage;
	if ($showPhotoDeleteButton eq "no") { &error('You Do Not Have Permissions to Delete Pictures'); }
	my $deletePassword2 = param('dltpwd');
	if ($usePasswordForPhotoDelete eq "yes"){
  		if ($deletePassword2 ne $deletePassword) { &error('You Entered an Incorrect Password'); }
	}
	my $deleteAlbum = param('deleteFromAlbum');
	my @deleteFiles = param('deleteThesePics');
	my $numbertodelete = scalar(@deleteFiles);

	my $deleteThisAlbum;
	if ($servertype eq "unix") {
		$deleteThisAlbum = "$parentDirectory" . "/" . "$deleteAlbum";
	}
	else {
		$deleteThisAlbum = "$parentDirectory" . "\\" . "$deleteAlbum";
	}
	opendir(DIR,"$deleteThisAlbum") or &error('Cannot Verify The Existence of That Album');
	closedir(DIR);
	if ($numbertodelete eq "1") {
		print "Deleting $numbertodelete Photo:<br>\n";
	}
	else {
		print "Deleting $numbertodelete Photos:<br>\n";
	}
	print "<hr width=400>\n";
	my $deleteThisFile;
	foreach $deleteThisFile(@deleteFiles) {
		my $deletePhotoName = $deleteThisFile;
		$deletePhotoName =~ s/_/ /g;
		$deletePhotoName =~ s/^..-..-..\.//;
		$deletePhotoName =~ s/\....$//;
		my $deleteThisFileNow;
		if ($servertype eq "unix") {
			$deleteThisFileNow = "$parentDirectory" . "/" . "$deleteAlbum" . "/" . "$deleteThisFile";
		}
		else {
			$deleteThisFileNow = "$parentDirectory" . "\\" . "$deleteAlbum" . "\\" . "$deleteThisFile";
		}
		print "$deletePhotoName: ";
		my $err =	unlink("$deleteThisFileNow"); 
		if ($err == 1) { print "<b><font color=Lime>Completed</font></b><br>\n"; }
		else { print "<b><font color=Red>Failed</font></b><br>\n"; }
	}
	if ($sendNotificationUponDeletePhoto eq "yes") {
		my $from = $emailAddress;
		my $to = $emailAddress;
		my $subject="Notification of Image Deleting";
		open (SENDMAIL, "| $sendmailpath -t");
		print SENDMAIL "Subject: $subject\n";
		print SENDMAIL "From: $from\n";
		print SENDMAIL "To: $to\n\n";
		print SENDMAIL "$numbertodelete Photos Have Been Deleted From $parentURL\n\n";
		print SENDMAIL "The Photos Deleted Were:\n";
		my $fileName;
		foreach $fileName(@deleteFiles) {
			print SENDMAIL "$fileName\n"; 
		}
		print SENDMAIL "\nDeleted From:\n";
		print SENDMAIL "$deleteAlbum \n\n";
		print SENDMAIL "Go right to your script:\n";
		print SENDMAIL "$URLToThisFile\n\n";
		print SENDMAIL "Thank You For Using PhotoAlbum! \n\n";
		close (SENDMAIL);
	}
	print "<hr width=400>\n";
	&endPage('$thisPage');
}















##################################################################
# Here we provide a form that lets the user create their own album
# (if allowed) or to delete an album (if allowed).  If you have
# not allowed either of these functions, they shouldn't be able
# to get here anyway.
##################################################################
sub albumManagement {
	my $thisPage = "albumManagement";
	print "\n<!-- Begin action: $thisPage -->\n";
	&beginPage;
	my @albums = &getAlbums;				
	my $numberOfAlbums = scalar(@albums);	
	print b('Album Management'), 
	"<hr width=400>\n";
	if ($allowUserDefinedAlbums eq "yes") {
		print start_form,
		b('Enter a New Album Name:'), 
		br,
		textfield(-name=>'userAlbum',
		-size=>30, -maxlength=>30), 
		br;
		if ($usePasswordForAlbumAdd eq "yes") {
			print "<b>Password: </b><br>\n",
			password_field(-name=>'addAlbumPassword',
				-size=>15, -maxlength=>30), br; 
		}
		print "\n<input type=hidden name=doWhat value=addAlbumAction>\n",
		submit(-value=>'Create Album'),
		end_form,
		"<hr width=400>\n"; 	
	}
	if ($showAlbumDeletionOption ne "no") {
		if ($numberOfAlbums eq "0"){			# if no albums, add one
			print "<!-- Display for No Albums Condition -->\n";
			print b('No Albums Currently Exist'); 
		}
		if ($numberOfAlbums gt "0"){			# if multiple albums, display menu to choose from
			print "<!-- Display for Multiple Albums Condition -->\n";
			print start_form,
			"\n<input type=hidden name=doWhat value=deleteVerification>\n";
			print b('Choose an Album to Delete:'), br;
			print "\n<select name=\"deleteAlbum\">\n";
			my $tempcount = 0;
			print "<option value=\"ChooseAlbum\">Choose An Album</option>\n";
			my $albumName;
			foreach $albumName(@albums){
				my $display = $albumName;		# copy name of album and clean it up
				$display =~ s/_/ /g;			
				print "<option value=$albumName>$display</option>\n";
				$tempcount++; 
			}
			print "</select>\n<br>\n";
			if ($usePasswordForAlbumDelete eq "yes") {
				print "<b>Password: </b><br>\n",
				password_field(-name=>'dAlbumPassword',
					-size=>15, -maxlength=>30); }
				print br, submit(-value=>'Delete Entire Album'),
				end_form; 
			} 
		}
		print "<hr width=400>\n";
	&endPage($thisPage);
}







##################################################################
# After the user says to delete a directory, we check the album
# for photos.  Then we list the files that we find, and ask for
# the user to confirm the delete action.  If delete is password
# protected, we ask them to reenter the password just to make sure
##################################################################
sub deleteVerification {
	my $thisPage = "deleteVerification";
	print "\n<!-- Begin action: $thisPage -->\n";
	&beginPage;
	&getAlbums;				# run subroutine to get album names
	my $deleteAlbum = param('deleteAlbum');
	my $dAlbumPassword = param('dAlbumPassword');
	if ($showAlbumDeletionOption ne "yes") { 
		&error('You Do Not Have Permission To Delete Albums'); 
	}
	if ($usePasswordForAlbumDelete eq "yes"){
		if ($dAlbumPassword ne $deleteAlbumPassword) {
			&error('Invalid Password'); 
		}
	}
	if ($deleteAlbum eq "ChooseAlbum") {
		&error('You Must Choose an Album'); 
	}
	my $deleteThisAlbum;
	if ($servertype eq "unix") {
		$deleteThisAlbum = "$parentDirectory" . "/" . "$deleteAlbum";
	}
	else {
		$deleteThisAlbum = "$parentDirectory" . "\\" . "$deleteAlbum";
	}
	opendir(DIR,"$deleteThisAlbum") or &error('Cannot Verify The Existence of That Album');
	my @deleteFiles = readdir(DIR); 
	closedir(DIR);
	if ($deleteFiles[0] = ".")  { shift(@deleteFiles);} 
	if ($deleteFiles[0] = "..")  { shift(@deleteFiles);} 
	my $deleteTotal = scalar(@deleteFiles);	
	print "<hr width=400>\n";
	if ($deleteTotal gt "0") {
		print "You Are Going To Delete the Following Photos:<br>\n";
		my $deleteThisFile;
		foreach $deleteThisFile(@deleteFiles) {
			my $photoDisplay = $deleteThisFile;
			$photoDisplay =~ s/_/ /g;
			$photoDisplay =~ s/^..-..-..\.//;
			$photoDisplay =~ s/\....$//;
			print "$photoDisplay<br>\n";
		} 
		print "<br>\n";
	}
	my $albumDisplay = $deleteAlbum;
	$albumDisplay =~ s/_/ /g;
	$albumDisplay =~ s/^..-..-..\.//;
	$albumDisplay =~ s/\....$//;
	print "\nYou Are Going To Delete the Following Album:<br>\n",
		"$albumDisplay<br>\n";
	print "<hr width=400>\n";
	print start_form,
	"\n<input type=hidden name=doWhat value=deleteAlbumAction>\n",
	"<input type=hidden name=deleteItAlbum value=$deleteAlbum>\n";
	if ($usePasswordForAlbumDelete eq "yes") {
		print "<b>Password: </b><br>\n",
		password_field(-name=>'deleteItAlready',
			-size=>15, -maxlength=>30); 
	}
	print br, submit(-value=>'Delete It Already!'),
	end_form;
	print "<hr width=400>\n";
	&endPage($thisPage);
}











##################################################################
# To delete an album (and all its contents) we check if it is 
# password protected, then find all the files in the directory
# finally we delete the files one at a time, and then remove the 
# directory itself.  Wrap up by listing the remaining directories
# as a confirmation
##################################################################
sub deleteAlbumAction {
	my $thisPage = "deleteAlbumAction";
	print "\n<!-- Begin action: $thisPage -->\n";
	&beginPage;
	my @albums = &getAlbums;	
	my $deleteAlbum = param('deleteItAlbum');
	my $dAlbumPassword = param('deleteItAlready');
	if ($showAlbumDeletionOption ne "yes") { 
		&error('You Do Not Have Permission To Delete Albums'); 
	}
	if ($usePasswordForAlbumDelete eq "yes"){
		if ($dAlbumPassword ne $deleteAlbumPassword) {&error('Invalid Password'); }
	}
	if ($deleteAlbum eq "ChooseAlbum") {&error('You Must Choose an Album'); }
	my $deleteThisAlbum;
	if ($servertype eq "unix") {
		$deleteThisAlbum = "$parentDirectory" . "/" . "$deleteAlbum";
	}
	else {
		$deleteThisAlbum = "$parentDirectory" . "\\" . "$deleteAlbum";
	}
	opendir(DIR,"$deleteThisAlbum") or &error('Cannot Verify The Existence of That Album');
	my @deleteFiles = readdir(DIR); # read list of files
	closedir(DIR);
	if ($deleteFiles[0] =~ m/^\./)  { shift(@deleteFiles);} 
	if ($deleteFiles[0] =~ m/^\./)  { shift(@deleteFiles);} 
	my $deleteTotal = scalar(@deleteFiles);	
	print "<hr width=400>\n";
	if ($deleteTotal gt "0") {
		print "Deleting the Following Photos:<br>\n";
		my $deleteThisFile;
		foreach $deleteThisFile(@deleteFiles) {
			my $photoDisplay = $deleteThisFile;
			$photoDisplay =~ s/_/ /g;
			$photoDisplay =~ s/^..-..-..\.//;
			$photoDisplay =~ s/\....$//;
			my $deleteThisPhotoNow;
			if ($servertype eq "unix") {
				$deleteThisPhotoNow = "$parentDirectory" . "/" . "$deleteAlbum" . "/" . "$deleteThisFile";
			}
			else {
				$deleteThisPhotoNow = "$parentDirectory" . "\\" . "$deleteAlbum" . "\\" . "$deleteThisFile";
			}
			print "$photoDisplay: ";
			my $err =	unlink("$deleteThisPhotoNow"); 
			if ($err == 1) { print "<b><font color=Lime>Completed</font></b><br>\n"; }
			else { print "<b><font color=Red>Failed</font></b><br>\n"; }
		} 
		print "<br>";
	}
	print "\nDeleting the Following Album:<br>\n";
	my $albumDisplay = $deleteAlbum;
	$albumDisplay =~ s/_/ /g;
	$albumDisplay =~ s/^..-..-..\.//;
	$albumDisplay =~ s/\....$//;
	print "$albumDisplay: ";
	my $err = rmdir("$deleteThisAlbum");
	if ($err == 1) { print "<b><font color=Lime>Completed</font></b><br>\n"; }
	else { print "<b><font color=Red>Failed</font></b><br>\n"; }
	my @albums = &getAlbums;
		print "<hr width=400>\n";
	my $numberOfAlbums = scalar(@albums);
	if ($numberOfAlbums ne "0") {
		print "The New List of Albums is:\n<br>";
		my $album;
		foreach $album(@albums){
			my $display = $album;
			$display =~ s/_/ /g;
			print "$display<br>\n";
		}
	}
	else {
		print "No Albums Currently Exist\n<br>";
	}
	print "<hr width=400>\n";
	if ($sendNotificationUponDeleteAlbum eq "yes") {
		my $from = $emailAddress;
		my $to = $emailAddress;
		my $subject="Notification of Album Deleting";
		open (SENDMAIL, "| $sendmailpath -t");
		print SENDMAIL "Subject: $subject\n";
		print SENDMAIL "From: $from\n";
		print SENDMAIL "To: $to\n\n";
		print SENDMAIL "An Album Has Been Deleted From $parentURL\n\n";
		print SENDMAIL "The Album was:\n";
		print SENDMAIL "$deleteAlbum \n\n";
		if ($deleteTotal gt "0") {
			print SENDMAIL "The Photos Deleted were:\n";
			my $file;
			foreach $file(@deleteFiles) {
				print SENDMAIL "$file\n"; 
			}
		    print "\n\n";
		}
		print SENDMAIL "Go right to your script:\n";
		print SENDMAIL "$URLToThisFile\n\n";
		print SENDMAIL "\nThank You For Using PhotoAlbum! \n\n";
		close (SENDMAIL);
	}
	&endPage($thisPage);
}










##################################################################
# This takes the user's input (if allowed) and removes any special
# characters and directory changes, removes bad words, and then
# creates the album inside the PhotoAlbums folder
##################################################################
sub addAlbumAction {
	my $thisPage = "addAlbumAction";
	print "\n<!-- Begin action: $thisPage -->\n";
	&beginPage;
	my $addAlbumPass = param('addAlbumPassword');
	if ($allowUserDefinedAlbums ne "yes") { 
		&error('You Do Not Have Permission To Add Albums'); 
		print "You Do Not Have Permission To Add Albums";
	}
	if ($usePasswordForAlbumDelete eq "yes"){
		if ($addAlbumPass ne $addAlbumPassword) { 
			&error('Invalid Password'); 
			print "Invalid Password";
		}
	}
	my $userAlbum = param('userAlbum');
	my $displayName = $userAlbum;
	$userAlbum =~ s/^\s+//g; ### remove leading spaces
	$userAlbum =~ s/\s+$//g; ### remove trailing spaces
	$userAlbum =~ s/..\//_/g;  
	$userAlbum =~ s/^\s+//;
	$userAlbum =~ s/ /_/g;  
	$userAlbum =~ s/\//_/g;    
	$userAlbum =~ s/\"/_/g;
	$userAlbum =~ s/'//g;
	$userAlbum =~ s/\./_/g;
	$userAlbum =~ s/,/_/g;
	$userAlbum =~ s/:/_/g;
	$userAlbum =~ s/\;/_/g;
	$userAlbum =~ s/!/_/g;
	$userAlbum =~ s/\@/_/g;
	$userAlbum =~ s/\-/_/g;
	$userAlbum =~ s/\+/_/g;
	$userAlbum =~ s/\[/_/g;
	$userAlbum =~ s/\]/_/g;
	$userAlbum =~ s/\{/_/g;
	$userAlbum =~ s/\}/_/g;
	$userAlbum =~ s/\|/_/g;
	$userAlbum =~ s/\?/_/g;
	$userAlbum =~ s/</_/g;
	$userAlbum =~ s/>/_/g;
	if ($usedAsAdultGallery = "no") {
		my $badword;
		foreach $badword(@badwords) {
			$userAlbum =~ s/$badword//gi;
		}
	}
	my $i;
	for ($i=0, $i<10, $i++) { $userAlbum =~ s/__/_/g; }
	$userAlbum =~ s/^_//g;
	$userAlbum =~ s/_$//g;
	my $makeThisAlbum;
	if ($servertype eq "unix") {
		$makeThisAlbum = "$parentDirectory" . "/" . "$userAlbum";
	}
	else {
		$makeThisAlbum = "$parentDirectory" . "\\" . "$userAlbum";
	}
	if ($userAlbum ne ""){
		my $err = opendir(DIR,"$makeThisAlbum");
		if ($err == 1) { print " \n"; 	}
		else { 
			`mkdir $makeThisAlbum`;
			opendir(DIR,"$makeThisAlbum");
			chmod(0777, $makeThisAlbum)
		}
		close DIR;
		my @albums = &getAlbums;
		my $numberOfAlbums = scalar(@albums);	# get number of albums
		if ($numberOfAlbums eq "0"){			# if no albums, add one
			print "<!-- Display for No Albums Condition -->\n";
			print "<hr width=400>\n",
				"<b>Could Not Create $displayName</b><br>\n"; 
		}
		else {			# if albums, list
			print "<!-- Display for Multiple Albums Condition -->\n";
			print "<hr width=400>",
				b('New List of Albums:'), br;
			my $albumName;
			foreach $albumName(@albums){
				my $display = $albumName;		# copy name of album and clean it up
				$display =~ s/_/ /g;			
				print "$display<br>\n\n"; 
			}
			if ($sendNotificationUponCreateAlbum eq "yes") {
				my $from = $emailAddress;
				my $to = $emailAddress;
				my $subject="Notification of Album Creation";
				open (SENDMAIL, "| $sendmailpath -t");
				print SENDMAIL "Subject: $subject\n";
				print SENDMAIL "From: $from\n";
				print SENDMAIL "To: $to\n\n";
				print SENDMAIL "An Album Has Been Added To $parentURL\n\n";
				print SENDMAIL "The Album is:\n";
				print SENDMAIL "$userAlbum \n\n";
				print SENDMAIL "Go right to your script:\n";
				print SENDMAIL "$URLToThisFile\n\n";
				print SENDMAIL "Thank You For Using PhotoAlbum! \n\n";
				close (SENDMAIL);
			}
		}
		print "<hr width=400>\n"; 
	}
	&endPage($thisPage);
}


##################################################################
# This generates the error message and then ends the html page
##################################################################
sub error {
	my $thisPage = "Error";
	print "<h3>An error occurred:", br;
	print @_;
	print "</h3>";
	print "<center><hr width=400>\n";
	&endPage($thisPage);
	1;
}
