#!/usr/bin/perl5 -s

print "Content-type: text/html\n\n";

## --> Snif cookie, if present test for logged in status
# require ("cookiesnif.nsp");

## --> Parse Request Query
require ("parse_query.nsp");

## -->  CONNECT TO DB
use DBI;
my $dbh = DBI->connect("DBI:mysql:NVF".$thyHost,$thyRU,$thyRP) or die "Unable to connect to database: <b>$elDB</b>\n"; 
$dbh->{RaiseError} = 1; 

if ($FORM{'PID'}) { 

		$PID = "$FORM{'PID'}";



		## -->  GET PAGE CONTENT
		my $sth = $dbh->prepare("SELECT * FROM losPhotos where ImageID = '$PID'");
		$sth->execute or die "Unable to execute query\n"; 
		my @row;
		while(@row = $sth->fetchrow_array) {
			$FileName = $row[2];
			$Height = $row[4];
			$ArtComment = $row[5];
			$UserComment = $row[6];
			$Owner = $row[12];
		}
		$sth->execute or die "Unable to execute query\n"; 
		$sth->finish;

		@sFILE = split(/\./,$FileName);
		$sFILE[1] =~ s/_/ /gi;
		
		## -->> LOGGED USER'S INFO
		my $sth = $dbh->prepare("SELECT * FROM userBase where Email = '$Cookies{'IM'}'");
		$sth->execute or die "Unable to execute query\n"; 
		my @row;
		while(@row = $sth->fetchrow_array) { 
			$CID = int($row[0]);
		}
		$sth->execute or die "Unable to execute query\n"; 
		$sth->finish;

		

		$CUC = 0;
		if ($UserComment ne "") {
			$UserComment =~ s/\n/<br>/gi;
			$UserComment =~ s/\r//gi; ## remove unwanted
			$UserComment =~ s/\t//gi; ## remove unwanted
			$UserComment =~ s/\n//gi; ## remove unwanted
			$UserComment =~ s/\f//gi; ## remove unwanted
			$UserComment =~ s/^\s+//g; ### remove leading spaces
			$UserComment =~ s/\s+$//g; ### remove trailing spaces
			$UserComment =~ s/"/'/gi;
			if ($UserComment =~ "-----xxxxx-----"){ @allUCs = split(/-----xxxxx-----/,$UserComment); }
			else { $allUCs[0] = $UserComment; }
			foreach $AUC (@allUCs) { $CUC++; }
		}
		
		if ($ArtComment ne "" && $ArtComment ne " ") { $hasArtistComments = '1'; }
		else { $hasArtistComments = '0'; }
		
		## view
		if ($FORM{'lz'} eq "view") {
			print qq~ 
			<script language="Javascript">
				if (parent.document && parent.document.getElementById) {
					parent.hasArtistComments = '$hasArtistComments';
					if (parent.document.getElementById("viewCommentsT") && parent.document.getElementById("viewComments")) {
						parent.document.getElementById("viewCommentsT").innerHTML = "USER COMMENTS";
						parent.document.getElementById("viewComments").innerHTML = parent.document.getElementById("userComments").innerHTML;
					}
				}
			</script>
			~;
		}


		## submitComment
		elsif ($FORM{'lz'} eq "submitC") {
			if ($Cookies{'Logged'} eq "SI") {

				## clean up input, NO HTML / SCRIPT
				use HTML::Strip;
				$message = $FORM{'mes'};
  				my $hs = HTML::Strip->new();
				my $clean_text = $hs->parse( $message );
				$hs->eof;

				## make length
				$theL = length($clean_text);

				## after CLEANUP less than 10 characters in message.
				if ($theL < 10) {
					print qq~
					<script language="Javascript">
						if (parent.document && parent.document.getElementById) { 
							if (parent.document.getElementById("viewCommentsT") && parent.document.getElementById("viewComments")) {
								parent.hasArtistComments = '$hasArtistComments';
								myHeight=Number('$Height');
								getHeight = Number(myHeight-232);
								parent.document.getElementById("viewCommentsT").innerHTML = "CANNOT ADD COMMENT";
								parent.document.getElementById("viewComments").innerHTML = '<center>'
								+ '<form><br style="font-size:10px;font-family:verdana,arial;">Your Comment Less Than 10 Characters<br><br>We cannnot post a comment that is less than 10 characters long, please try again.<br><br><br><input type="button" class="aaeButtons" value="Try Again" onClick="javascript:parent.history.go(-1);"><br><img src="nvi/spacer.gif" width="1" height="' + getHeight + '" border="0" vspace="1"></form>'
							}
						}
					</script>
					~;
				}
				## save it
				else {
					push(@allUCs,"$clean_text\n\n$FORM{'ab'}");
					$cuc=0;
					foreach $dUC (@allUCs) {
						if ($cuc eq "0") { $myUCSs = "$dUC";}
						else { $myUCSs = $myUCSs . "-----xxxxx-----" . "$dUC"; }
						$cuc++;
					}

					print qq~
					<script language="Javascript">
						if (parent.document && parent.document.getElementById) { 
							if (parent.document.getElementById("viewCommentsT") && parent.document.getElementById("viewComments")) {
								parent.hasArtistComments = '$hasArtistComments';
								myHeight=Number('$Height');
								getHeight = Number(myHeight-232);
								parent.document.getElementById("viewCommentsT").innerHTML = "COMMENT ADDED";
								parent.document.getElementById("viewComments").innerHTML = '<center>'
								+ '<form><br style="font-size:10px;font-family:verdana,arial;">Your Comment Was Added Successfully...<br><br>Our users\\' always welcome other users feedback and comments.<br><br><br><input type="button" class="aaeButtons" value="Continue..." onClick="javascript:parent.clearGalleryBody();parent.trigger(parent.TNUM);"><br><img src="nvi/spacer.gif" width="1" height="' + getHeight + '" border="0" vspace="1"></form>'
							}
						}
					</script>
					~;
				}

				

			}
			else {
				print qq~ 
					<script>
					var answer = confirm ("You must be logged in to add comments, would you like to log in now?")
					if (answer)
						parent.location.href = 'http://www.nightvisiononline.com/login.htm';
					</script> 
					~;
					exit;
			}		

		}




		## add
		else {
			if ($Cookies{'Logged'} eq "SI") {


				print qq~
				<script language="Javascript">
					if (parent.document && parent.document.getElementById) { 
						if (parent.document.getElementById("viewCommentsT") && parent.document.getElementById("viewComments")) {
							parent.hasArtistComments = '$hasArtistComments';
							myHeight=Number('$Height');
							getHeight = Number(myHeight-182);
							parent.document.getElementById("viewCommentsT").innerHTML = "ADD COMMENT";
							parent.document.getElementById("viewComments").innerHTML = '<center>'
							+ '<form name="addComment">'
							+ '<input type="hidden" name="lz" value="submitC">'
							+ '<input type="hidden" name="PID" value="$PID">'
							+ '<input type="text" name="uName" value="Comment By: $Cookies{'FNe'} $Cookies{'LNe'}" class="aaeLargeInput" style="font-size:9px;width:300px;height:20px;padding-left:5px;padding-top:2px;background-color:#006600;color:#FFFFFF;" onFocus="blur(this);" title="Sorry, you cannot edit this field. This information is controlled by information associated with your user account." readonly><br>'
							+ '<textarea type="text" name="bod" class="aaeTArea" style="font-size:9px;width:240px;height:'+ getHeight +'px;padding-left:5px;padding-top:2px;background-color:#006600;color:#FFFFFF;" onFocus="contentsChanged(this,this.value)" onBlur="checkStat(this,this.value);" onKeyPress="return parent.textLimit();" title="Type your message here. No Markup HTML, SCRIPT or anything active. Simple text will do fine. Yes, you can have newlines in your message.">Your comments: 150 Characters MAX</textarea><br>'
							+ '<input type="button" value="Add Comment" class="aaeButtons" onClick="parent.submitComment(this,150);">'
							+ '<input type="button" value="Cancel" class="aaeButtons" onClick="parent.addComment();"><br>'
							+ '</form></center>';
						}
					}
				</script>
				~;
			}
			else {
				print qq~ 
					<script>
					var answer = confirm ("You must be logged in to add comments, would you like to log in now?")
					if (answer)
						parent.location.href = 'http://www.nightvisiononline.com/login.htm';
					</script>
				 ~;
				exit;
			}

		}

		

}




exit;