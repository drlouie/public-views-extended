#!/usr/bin/perl5 -s

print "Content-type: text/html\n\n";

require "parse_query.nsp";

$ogFGColor = "009A31";

if ($FORM{'FName'} && $FORM{'Email'}) {

	print qq~
	<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
	<html>
	<head>
	<title>Night Vision Forum - US Night Vision Corporation</title>
	<body bgcolor="#FFFFFF" LEFTMARGIN="0" TOPMARGIN="0" MARGINWIDTH="0" MARGINHEIGHT="0">

	</body>
	</html>
	~;
}

else {

if ($FORM{'numPages'}) { $myLoad1 = "toggleForumTab1();"; }
else { $myLoad1 = ""; }

if ($FORM{'nextOne'}) { $myLoad2 = "toggleForumTab2();"; }
else { $myLoad2 = ""; }

if ($FORM{'showAll'}) { $myLoad3 = "toggleForumTab1();"; }
else { $myLoad3 = ""; }

if ($FORM{'thyQuery'}) { 
	if ($myLoad1 eq "" && $myLoad2 eq "" && $myLoad3 eq "") { $myLoad4 = "toggleForumTab3();"; }
	else { $myLoad4 = ""; }
}
else { 
	$myLoad4 = ""; 
}


print qq~
<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html>
<head>
<title>Night Vision Forum - US Night Vision Corporation</title>
<script language="Javascript" src="js/b4dom.js"></script>
<script language="Javascript">
	var ovFGColor = "#009A31";
</script>
<style type="text/css">
.overlibCart { font-size:9px; color: #ffffff; }
.welcomeText { font-size:10px;font-family:verdana,arial,helvetica;color:ffffff;line-height:16px; }
.commonSmallB { font-size:10px;font-family:verdana,arial,helvetica;color:#000000;line-height:10px;font-weight:bold; }
.commonSmall { font-size:10px;font-family:verdana,arial,helvetica;color:#000000;line-height:16px; }
.commonSmallest { font-size:9px;font-family:verdana,arial,helvetica;color:#000000;}
.commonMediumB { font-size:11px;font-family:verdana,arial,helvetica;color:#000000;line-height:10px;font-weight:bold; }
.commonInput { background-color: #cccccc; border: 1px solid #009A31; height:20px; font-size: 10px; font-family:verdana,arial,helvetica; padding: 3px; }
select { background-color: #cccccc; border: #009A31; height:20px; font-size: 11px; font-family:verdana,arial,helvetica; padding: 3px; }
radio { background-color: #cccccc; border: #009A31; height:20px; font-size: 11px; font-family:verdana,arial,helvetica; padding: 3px; }
.commonTArea { background-color: #cccccc; border: 1px solid #009A31; font-size: 10px; font-family:verdana,arial,helvetica; padding: 3px; }
.checkbox0 { font-size:10px;font-family:verdana,arial,helvetica;line-height:9px; line-height:12px; }
</style>
</head>
<body bgcolor="#FFFFFF" LEFTMARGIN="0" SCROLL="YES" TOPMARGIN="0" MARGINWIDTH="0" MARGINHEIGHT="0" onload="$myLoad1 $myLoad2 $myLoad3">
<div id="overDiv"></div>
<table width="100%" cellpadding="0" cellspacing="0" border="0">
  <tr> 
    <td width="185" valign="top"> 

~;


print qq~


    </td>
    <td valign="top" rowspan="2" height="108">
      <table width="100%" align="left" cellpadding="0" cellspacing="0" border="0" height="52">
~;


print qq~            
		<tr> 
          	<td colspan="2" valign="top" align="right"> 
~;


print qq~            
          	</td>
        </tr>
	</table>

		</td>
	</tr>
</table>

~;

if($FORM{'myScreen'} eq "fdisplay") {
	require ("fdisplay_admin.nsp");
}
elsif($FORM{'myScreen'} eq "fmsgr") {
	require ("fmsgr_admin.nsp");
}
elsif($FORM{'myScreen'} eq "postNew") {
	require ("postnew_admin.nsp");
}







elsif ($FORM{'CualForumAdmin'} eq "delete") {
	use DBI;
	my $dbh = DBI->connect("DBI:mysql:NVF","root","32GCC5E7TSjqQ") or die "Unable to connect to database: <b>unvWeb</b>\n"; 
	$dbh->{RaiseError} = 1; 
	
	require '/usr/local/www/vhosts/nightvisiononline.com/htdocs/common2005.htm';

	&openDatabase;

		$FoundCount=0;
		for ($a = 0; $a < @messages; $a++) {
			($mnum[$a],$msub[$a],$mfollow[$a],$mname[$a],$memail[$a],$mdate[$a],$mip[$a],$magent[$a],$murl[$a],$chop) = split(/``/,$messages[$a]);
			if ($FORM{'PID'} == $mnum[$a]) {
				$idnum = $a;
				$FoundCount++;
			}
			else {
				push (@NewDB,"$messages[$a]");
			}
		}

		if ($FoundCount eq "0") {
			print qq~

			<script language="Javascript">
				alert('Sorry, error encountered. Please contact adminstrator for help...');
				document.location.href = "?ADMIN=1";
			</script>
	
			~;
			$dbh->disconnect;
			exit;
		}
		else {
			### DELETE ITEM AND SAVE FILE
			open(DF,">$datafile") || &error('can not write to $datafile');
			flock(DF, 2);
			print DF @NewDB;
			flock(DF, 8);
			close(DF);
	
			## DELETE ITEM FROM DB
			my $sth = $dbh->prepare("DELETE FROM leForu WHERE PostadoID='$FORM{'PID'}'");
			$sth->execute or die "Unable to execute query\n"; 
			$sth->finish;
		
			print qq~
				<script language="Javascript">
					alert('Selected post has been deleted from the system permentantly...');
					document.location.href = "?ADMIN=1";
				</script>
			~;	
	
		}
	$dbh->disconnect;
	exit;
}

## If BANNING
elsif ($FORM{'CualForumAdmin'} eq "BanIP") {

	use DBI;
	my $dbh = DBI->connect("DBI:mysql:NVF","root","32GCC5E7TSjqQ") or die "Unable to connect to database: <b>unvWeb</b>\n"; 
	$dbh->{RaiseError} = 1; 

	## Crumble Form Input to Variables
	my $IP = "$FORM{'IP'}";
	my $Email = "$FORM{'Email'}";
	
	my $sth = $dbh->prepare("INSERT INTO Banned (BannedID, IP, Email, BannedOn) VALUES (Null, '$IP', '$Email', '$date')");
	$sth->execute or die "Unable to execute query\n"; 
	$sth->finish;

	print qq~
	<script lagnauage="Javascript">
		alert('$IP ($Email) has been banned from posting messages on the forum.');
		document.location.href = "?BANMAN=1";
	</script>
	~;

	$dbh->disconnect;
	exit;
}

## If UN-BANNING
elsif ($FORM{'CualForumAdmin'} eq "UnBanIP") {

	use DBI;
	my $dbh = DBI->connect("DBI:mysql:NVF","root","32GCC5E7TSjqQ") or die "Unable to connect to database: <b>unvWeb</b>\n"; 
	$dbh->{RaiseError} = 1; 
	
	## Crumble Form Input to Variables
	my $IP = "$FORM{'IP'}";
	my $Email = "$FORM{'Email'}";
	
	my $sth = $dbh->prepare("DELETE FROM Banned WHERE IP='$IP'");
	$sth->execute or die "Unable to execute query\n"; 
	$sth->finish;

	$dbh->disconnect;

	
	print qq~
	<script lagnauage="Javascript">
		alert('$IP ($Email) has been re-authorized to post messages on this forum.');
		document.location.href = "?BANMAN=1";
	</script>
	~;

	exit;
}









## view messages
else {
	require ("vmessages_admin.nsp");
}

print qq~   


</body>
</html>
~;
}
exit;
