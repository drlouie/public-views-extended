#!/usr/bin/perl5 -s

#	GNU GPL Copyright 2002 - Gavin Laking
#
#	This file is part of Daisy.
#
#	Daisy is free software; you can redistribute it and/or modify
#	it under the terms of the GNU General Public License as published by
#	the Free Software Foundation; either version 2 of the License, or
#	(at your option) any later version.
#
#	Daisy is distributed in the hope that it will be useful,
#	but WITHOUT ANY WARRANTY; without even the implied warranty of
#	MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#	GNU General Public License for more details.
#
#	You should have received a copy of the GNU General Public License
#	along with Daisy; if not, write to the Free Software
#	Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA 02111-1307 USA

$| = 1;

require("parse_query.nsp");

require 'common2005.htm';

require("bcookiesnif.nsp");

#require 'getBanner.nsp';

&openDatabase;

$messagecount = 0;
$threadcount = 0;

if ($FORM{'numPages'}) { $maxdisplay = $FORM{'numPages'}; $myLoad1 = "toggleForumTab1();";}
else { $maxdisplay = $maxdisplay; $myLoad1 = ""; }

if ($FORM{'nextOne'}) { 
	$parseCount = ($FORM{'nextOne'} * $maxdisplay) - 1; 
	$nextInline = $FORM{'nextOne'} + 1; 
	if ($myLoad1 eq "") { $myLoad2 = "toggleForumTab2();"; }
	else { $myLoad2 = ""; }
}
else { $parseCount = ($maxdisplay - 1); $nextInline = 2; $myLoad2 = ""; }

if ($FORM{'showAll'}) { 
	$showAll = "&showAll=YES";
	if ($myLoad1 eq "" && $myLoad2 eq "") { $myLoad3 = "toggleForumTab1();"; }
	else { $myLoad3 = ""; }
}
else { $showAll = ""; $myLoad3 = ""; }

if ($FORM{'thyQuery'}) { 
	if ($FORM{'thyQuery'} =~ ",") { 
		@splitQ = split(/,/,$FORM{'thyQuery'}); 
		$FORM{'thyQuery'} = "$splitQ[0]"; 
	}
	else {
		$FORM{'thyQuery'} = "$FORM{'thyQuery'}"; 	
	}
	$myQuery = "SEEKING: $FORM{'thyQuery'}"; 
	$GOSEARCH = "1";
	$myResearchField = "<input type='hidden' name='thyQuery' value='$FORM{'thyQuery'}'>";
	$reSearch = "&thyQuery=$FORM{'thyQuery'}";
	if ($myLoad1 eq "" && $myLoad2 eq "" && $myLoad3 eq "") { $myLoad4 = "toggleForumTab3();"; }
	else { $myLoad4 = ""; }
}
else { 
	$GOSEARCH = "0"; 
	$myQuery = "Quick Search"; 
	$myLoad4 = ""; 
	$myResearchField = "";
	$reSearch = "";
}


if ($Cookies{'Entrado'}) { $adLoad = "showAdvert();"; }
else { $adLoad = ""; }

## IF SEARCHING
if ($GOSEARCH == "1") {
	foreach $unMensage (@messages) { if ($unMensage =~ "$FORM{'thyQuery'}") { push(@messagesReal,$unMensage); } }
}
else {
	foreach $unMensage (@messages) { push(@messagesReal,$unMensage); }
}

for ($a = 0; $a < @messagesReal; $a++) {
	($mnum[$a],$msub[$a],$mfollow[$a],$mname[$a],$memail[$a],$mdate[$a],$mip[$a],$magent[$a],$mresource[$a],$murl[$a],$chop) = split(/``/,$messagesReal[$a]);
	$messagecount++;

	if ($mfollow[$a] == 1) {
		$threadcount++;
	}
}

$AppTitle = "Night Vision Online Forum";

	if ($parseCount == $maxdisplay - 1) { $myPager = "Live Forum - Active Thread"}
	else { $myPage = $nextInline - 1; $myPager = "Archived Forum - Page $myPage" }

	$BROWSER = "$ENV{'HTTP_USER_AGENT'}";
	if ($BROWSER =~ "Netscape") { $MuaSpeed = "20"; }
	else { $MuaSpeed = "5"; }

	if (!$FORM{'nextOne'} && !$FORM{'thyQuery'}) { $cualTopper = "newTopper_mid_home.jpg"; }
	elsif ($FORM{'nextOne'} == "1" && !$FORM{'thyQuery'}) { $cualTopper = "newTopper_mid_home.jpg"; }
	elsif ($FORM{'thyQuery'} ne "") { $cualTopper = "newTopper_mid_search.jpg"; }
	else { $cualTopper = "newTopper_mid_bypage.jpg"; }
print qq~
<html>
<head>
<title>$AppTitle</title>
<script language="Javascript" src="js/b4dom.js"></script>
<script language="Javascript" src="js/mousetable.js"></script>
<style type="text/css">
#myOverDiv { padding-top:1px; padding-bottom:1px; padding-left:1px; padding-right:1px; position:absolute; top:0px; left:0px; visibility:hidden; z-index:5000; border-top:1px solid #D7A368; border-bottom:1px solid #D7A368; border-left:1px solid #D7A368; border-right:1px solid #D7A368; }
.myOverDiv { padding:10px;font-weight:bold; color:#eb0000; padding-top:3px; padding-bottom:3px; padding-left:3px; padding-right:3px; z-index:5000; }
.myOverlib { margin-top:10px;margin-left:10px;margin-bottom:10px;margin-right:10px; }
</style>
<script language="Javascript">
//
// START FORUM TAB Controls
// 

// FORUM TAB ONE
// LEFT = 30px / TOP = 95px;
function loadTabs() {
	MforumLayer1 = document.getElementById("forumTab1").style.top;
	MforumLayer2 = document.getElementById("forumTab2").style.top;
	MforumLayer3 = document.getElementById("forumTab3").style.top;
	forumLayer1 = MforumLayer1.split("px");
	forumLayer2 = MforumLayer2.split("px");
	forumLayer3 = MforumLayer3.split("px");
	
	Layer1 = document.getElementById("forumTab1").style;
	Layer2 = document.getElementById("forumTab2").style;
	Layer3 = document.getElementById("forumTab3").style;
	
	n = (document.layers) ? 1 : 0;
	ie = (document.all) ? 1 : 0;
	block1 = document.getElementById("forumTab1").style;
	block1.ypos = parseInt(block1.top);
	block1.xpos = parseInt(block1.left);
	block2 = document.getElementById("forumTab2").style;
	block2.ypos = parseInt(block2.top);
	block2.xpos = parseInt(block2.left);
	block3 = document.getElementById("forumTab3").style;
	block3.ypos = parseInt(block3.top);
	block3.xpos = parseInt(block3.left);	
}

// FORUM TAB ONE
function toggleForumTab1() {
	if (block1.ypos <= 134) { toggleForum1Down(); }
	if (block1.ypos >= 194) { 
		toggleForum1Up(); 
		if (block2.ypos != 194) { toggleForum2Down(); }
		if (block3.ypos != 194) { toggleForum3Down(); }
	}
	
}
function toggleForum1Down() {
	document.numberMessages.numPages.style.visibility = 'hidden';
	block1.ypos += $MuaSpeed;
	block1.top = block1.ypos;
	block1.xpos -= $MuaSpeed;
	block1.left = block1.xpos;
	if (block1.ypos != 194) { setTimeout("toggleForum1Down()", 5); }
}
function toggleForum1Up() {
	block1.ypos -= $MuaSpeed;
	block1.top = block1.ypos;
	block1.xpos += $MuaSpeed;
	block1.left = block1.xpos;
	if (block1.ypos != 134) { setTimeout("toggleForum1Up()", 5); }
	else { document.numberMessages.numPages.style.visibility = 'visible'; }
}


// FORUM TAB TWO
function toggleForumTab2() {
	if (block2.ypos <= 134) { toggleForum2Down(); }
	if (block2.ypos >= 194) { 
		if (block1.ypos != 194) { toggleForum1Down(); }
		if (block3.ypos != 194) { toggleForum3Down(); }
		toggleForum2Up(); 
	}
}
function toggleForum2Down() {
	document.pager.GoToPages.style.visibility = 'hidden';
	block2.ypos += $MuaSpeed;
	block2.top = block2.ypos;
	block2.xpos -= $MuaSpeed;
	block2.left = block2.xpos;
	if (block2.ypos != 194) { setTimeout("toggleForum2Down()", 5); }
}
function toggleForum2Up() {
	block2.ypos -= $MuaSpeed;
	block2.top = block2.ypos;
	block2.xpos += $MuaSpeed;
	block2.left = block2.xpos;
	if (block2.ypos != 134) { setTimeout("toggleForum2Up()", 5); }
	else { document.pager.GoToPages.style.visibility = 'visible'; }
}



// FORUM TAB THREE
function toggleForumTab3() {
	if (block3.ypos <= 134) { toggleForum3Down(); }
	if (block3.ypos >= 194) { 
		if (block1.ypos != 194) { toggleForum1Down(); }
		if (block2.ypos != 194) { toggleForum2Down(); }
		toggleForum3Up(); 
	}
}
function toggleForum3Down() {
	document.leSoich.thyQuery.style.visibility = 'hidden';
	block3.ypos += $MuaSpeed;
	block3.top = block3.ypos;
	block3.xpos -= $MuaSpeed;
	block3.left = block3.xpos;
	if (block3.ypos != 194) { setTimeout("toggleForum3Down()", 5); }
}
function toggleForum3Up() {
	block3.ypos -= $MuaSpeed;
	block3.top = block3.ypos;
	block3.xpos += $MuaSpeed;
	block3.left = block3.xpos;
	if (block3.ypos != 134) { setTimeout("toggleForum3Up()", 5); }
	else { document.leSoich.thyQuery.style.visibility = 'visible'; }
}







//-->
</script>
<script language="Javascript" src="js/myOverlib.js"></script>
<!--END-->
<LINK REL="STYLESHEET" HREF="common_css2005.css" Type="text/css">
</head>
<BODY LEFTMARGIN="0" TOPMARGIN="0" MARGINWIDTH="0" MARGINHEIGHT="0" onLoad="loadTabs(); $myLoad1 $myLoad2 $myLoad3 $myLoad4 $adLoad">
<table width="100%" align="center" border="0" cellpadding="0" cellspacing="0">
  <tr> 
    <td width="100%" align="right" valign="top" height="94"><img src="images2005/newTopper_left.jpg" width="396" height="94"></td>
    <td width="333" align="left" valign="top" height="94"><img src="images2005/$cualTopper" width="333" height="94"></td>
  </tr>
</table>

<table width="100%" align="center" border="0" cellpadding="0" cellspacing="0">
	<tr valign="top">

		<td height="20">
<script type="Javascript">
function goToPage(cual) {
	var formindex = document.pager.GoToPages.selectedIndex;
	var thisone = document.pager.GoToPages.options[formindex].value;
	document.location.href = thisone;
}
</script>
~;

$pagecount=1;
print qq~
<TABLE width="100%" border="0" cellpadding="5" cellspacing="0">
<tr><td height="1" width="100%">
<div id="forumTab1" style="visibility:visible;position:absolute;left:30px;top:194px;z-index:2;width:474px;height:55px; background-image: url(images2005/alayer_messages.gif); background-repeat: no-repeat; background-position: right top;">
<a href="javascript:void(0);" onClick="javascript:toggleForumTab1();"><img src="images2005/spacer.gif" width="170" height="25" border="0"></a><br>

<table width="405" border="0" cellpadding="0" cellspacing="0">
<form name="numberMessages">
<tr><td align="center" width="376"><font class="pageCount">

<nobr>
$myResearchField
<select name="numPages" class="numPages" onChange="document.numberMessages.submit();" style="visibility:hidden;">
~;

if ($FORM{'numPages'} == "100") { print "<option value=\"100\" selected>VIEWING: 100 Per Page</option>"; }
else { print "<option value=\"100\">Show 100 Per Page</option>"; }
if ($FORM{'numPages'} == "200") { print "<option value=\"200\" selected>VIEWING: 200 Per Page</option>"; }
else { print "<option value=\"200\">Show 200 Per Page</option>"; }
if ($FORM{'numPages'} == "300") { print "<option value=\"300\" selected>VIEWING: 300 Per Page</option>"; }
else { print "<option value=\"300\">Show 300 Per Page</option>"; }
if ($FORM{'numPages'} == "400") { print "<option value=\"400\" selected>VIEWING: 400 Per Page</option>"; }
else { print "<option value=\"400\">Show 400 Per Page</option>"; }
if ($FORM{'numPages'} == "500") { print "<option value=\"500\" selected>VIEWING: 500 Per Page</option>"; }
else { print "<option value=\"500\">Show 500 Per Page</option>"; }

print qq~
	
</select> &nbsp;&nbsp;&nbsp; | &nbsp;&nbsp;&nbsp; 
~;

#if ($FORM{'showAll'}) { print "<a href=\"index2005.htm?$leNumPages\" style=\"font-size:12px; font-family:verdana,arial,helvetica; color: #D7A368;\">Hide All Messages</a></font>"; }
#else { print "<a href=\"index2005.htm?showAll=YES$leNumPages\" style=\"font-size:12px; font-family:verdana,arial,helvetica; color: #D7A368;\">Show All Messages</a></font>"; }

#if ($FORM{'showAll'}) { print "<a href=\"index2005.htm?$leNumPages\" style=\"font-size:12px; font-family:verdana,arial,helvetica; color: #D7A368;\">Hide All Messages</a></font>"; }
#else { print "<a href=\"index2005.htm?showAll=YES$leNumPages\" style=\"font-size:12px; font-family:verdana,arial,helvetica; color: #D7A368;\">Show All Messages</a></font>"; }

print "<a href=\"index2005.htm?newlook=1\" style=\"font-size:12px; font-family:verdana,arial,helvetica; color: #D7A368;\">New Forum Format</a></font>";

print qq~
</nobr>
</font>
</td>
<td width="29"><a href="javascript:void(0);" onClick="javascript:toggleForumTab1();"><img src="images2005/spacer.gif" width="29" height="30" border="0"></a></td>
</tr>
</form>
</table>
</div>





~;

if ($FORM{'numPages'}) { $leNumPages = "&numPages=$FORM{'numPages'}"; }
	for ($b = 0; $b < @messagesReal;) {
		$b = $b+$maxdisplay;
		if ($b ne $parseCount) { 
			if ($FORM{'nextOne'} == "$pagecount") { push(@allOthers,"<option value=\"index2005.htm?nextOne=$pagecount$leNumPages$showAll$reSearch\" SELECTED> >>> PAGE $pagecount <<<</option>"); }
			else { push(@allOthers,"<option value=\"index2005.htm?nextOne=$pagecount$leNumPages$showAll$reSearch\"> Jump to page $pagecount</option>"); } 
		}
		$pagecount++;
	}
	$prevPage = $nextInline - 2;

	print "<div id=\"forumTab2\" style=\"visibility:visible;position:absolute;left:202px;top:194px;z-index:3;width:474px;height:55px; background-image: url(images2005/alayer_bypage.gif); background-repeat: no-repeat; background-position: right top;\">";
	print "<a href=\"javascript:void(0);\" onClick=\"javascript:toggleForumTab2();\"><img src=\"images2005/spacer.gif\" width=\"160\" height=\"25\" border=\"0\"></a><br><table width=\"474\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\"><form name=\"pager\">$myResearchField<tr><td align=\"center\" width=\"445\"><font class=\"pageCount\">";

	if ($parseCount != $maxdisplay - 1) { print "<a href=\"index2005.htm?nextOne=$prevPage$leNumPages$showAll$reSearch\" style=\"font-size:12px; font-family:verdana,arial,helvetica; color: #D7A368;\"><<< Prev Page</a> &nbsp;&nbsp; | &nbsp;&nbsp; "; }
	print "<select name=\"GoToPages\" onChange=\"location.href=this.options[this.selectedIndex].value;\" class=\"numPages\" style=\"visibility:hidden\"><option value=\" \"> </option>@allOthers</select>";
	if ($parseCount < @messagesReal) { print " &nbsp;&nbsp; | &nbsp;&nbsp; <a href=\"index2005.htm?nextOne=$nextInline$leNumPages$showAll$reSearch\" style=\"font-size:12px; font-family:verdana,arial,helvetica; color: #D7A368;\">Next Page >>></a>"; }
	print "</font></td><td width=\"29\"><a href=\"javascript:void(0);\" onClick=\"javascript:toggleForumTab2();\"><img src=\"images2005/spacer.gif\" width=\"29\" height=\"30\" border=\"0\"></a></td></tr></form></table>";
	print "</div>";

print qq~


<div id="forumTab3" style="visibility:visible;position:absolute;left:364px;top:194px;z-index:3;width:405px;height:55px; background-image: url(images2005/alayer_search.gif); background-repeat: no-repeat; background-position: right top;">
<a href="javascript:void(0);" onClick="javascript:toggleForumTab3();"><img src="images2005/spacer.gif" width="170" height="25" border="0"></a><br>
<table width="405" border="0" cellpadding="0" cellspacing="0">
<form name="leSoich">
<tr><td align="center" width="376"><font class="pageCount">
<nobr>
<script language="Javascript">
function checkSearch(cual) {
var daValue = cual.value;
	if (daValue == "$myQuery") { cual.value = ""; }
}
</script>
<input type="text" name="thyQuery" size="30" value="$myQuery" class="search" onFocus="javascript:checkSearch(this)"> &nbsp; | &nbsp; Advanced Search
</nobr>
</font>
</td>
<td width="29"><a href="javascript:void(0);" onClick="javascript:toggleForumTab3();"><img src="images2005/spacer.gif" width="29" height="30" border="0"></a></td>
</tr>
</form>
</table>
</div>
<img src="images2005/spacer.gif" width="1" height="1"></td></tr>
<tr>
<td width="100%" align="right">

~;



print qq~
		</tr></table>		
		</td>

	</tr>
	<tr>

		<td width="100%" align="center" valign="top">
<span style="position:absolute;left:0px;top:219px;z-index:10;padding-left:15px;padding-right:15px;">
<center>
			<table width="100%" border="0" cellpadding="0" cellspacing="0">
  				<tr align="center" bgcolor="#000000">
    				
~;

	print "<td width=\"12\" height=\"12\" valign=\"top\"><img src=\"images2005/topleftcorner2_forum.gif\"></td>";
	print "<td valign=\"bottom\" height=\"12\" width=\"100%\" class=\"leForumTop\"><img src=\"images2005/spacer.gif\" border=\"0\" height=\"1\" width=\"1\"></td>";


print qq~
					<td width="12" height="12" valign="top" colspan="2"><img src="images2005/toprightcorner_forum.gif"></td>

  				</tr>
				<tr valign="top">
					<td width="100%" align="center" colspan="4" class="leForumLeftRight" valign="top">

<TABLE width="100%" cellpadding="10" align="center" cellspacing="0" border="0">
	<tr valign="top" bgcolor="#000000">
~;


$MuaColspan=" colspan='2'";


print "<td width=\"100%\" align=\"left\" $MuaColspan><font class=\"commonText\" style='font-size:13px;'>";

if ($FORM{'showAll'}) {
	print "<table width=\"100%\" border=\"0\" cellpadding=\"10\" cellspacing=\"0\">";
}

@template = "<!--messages-->";

### QUERY DB
use DBI;
my $dbh = DBI->connect("DBI:mysql:NVF","root","32GCC5E7TSjqQ") or die "Unable to connect to database\n"; 
$dbh->{RaiseError} = 1; 

for ($a = 0; $a < @template; $a++) {
	$_ = $template[$a];
		$last = 1;
	if (!$FORM{'showAll'}) { print "<ul class='UL1'>\n"; }
	    for ($b = 0; $b < @messagesReal; $b++) {
			if ($parseCount == $maxdisplay - 1) { $lastSet = ($parseCount - $maxdisplay); }
			else { $lastSet = ($parseCount - $maxdisplay); }
			if ($b <= $parseCount && $b > $lastSet) {
				if ($mfollow[$b] > $last) {
			        if (!$FORM{'showAll'}) { print "<ul class='UL2'>\n"; }
				}
		        else {
			        if ($mfollow[$b] <= $last) {
				        for ($c = 0; $c < $last - $mfollow[$b]; $c++) {
					        if (!$FORM{'showAll'}) { print "</ul>\n"; }
						}
				    }
			    }
				$last = $mfollow[$b];

if ($mname[$b] eq "" || $mname[$b] eq " ") { $muaUsername = "AnonymousUser"; }
else { $muaUsername = $mname[$b]; }

@dateTime = split(/ - /, $mdate[$b]);
@datePieces = split (/\//, $dateTime[0]);
@timePieces = split(/:/, $dateTime[1]);

@months = ('','January','February','March','April','May','June','July','August','September','October','November','December');

$tresLineas="$back;"; 


if ($datePieces[2] > 50) { $myYear = "19" . $datePieces[2]; }
else { $myYear = "20" . $datePieces[2]; }

if ($timePieces[0] > 12) { $timeSet = "pm"; $theHour = $timePieces[0] - 12; }
elsif ($timePieces[0] == 12) { $timeSet = "pm"; $theHour = $timePieces[0]; }
elsif ($timePieces[0] < 12) { $timeSet = "am"; $theHour = $timePieces[0]; }
$theMinute = $timePieces[1];

$theHour = sprintf("%02d", $theHour);
$leCuenta = $b + 1;


$msub[$b] =~ s/"//g;

if (!$FORM{'showAll'}) { 

	print "<li style='line-height:20px;'><a href='fdisplay2005.htm?action=display\&num=$mnum[$b]' class='instruct' style='font-size:13px;'>$msub[$b]</a> ( <b>$muaUsername</b> - $months[$datePieces[0]] $datePieces[1], $myYear )</li>\n"; 
}
else { 
	my $sth = $dbh->prepare("SELECT * FROM leForu WHERE PostadoID='$mnum[$b]'");
	$sth->execute or die "Unable to execute query\n"; 
	my @row;
		while(@row = $sth->fetchrow_array) { 
			$leBody = $row[3];
		}
	$sth->execute or die "Unable to execute query\n"; 
	$sth->finish;
	$Body = "$leBody";
	$cualA = $a / 2;
	if ($cualA =~ ".") { $bgC = ""; }
	else { $bgC = "bgcolor=\"#353535\""; }
	print "<tr><td width=\"100%\" $bgC><font class=\"commonText\" style=\"font-size:14px;\"><center><a href=\"fdisplay2005.htm?action=display\&num=$mnum[$b]\" class=\"instruct\" style=\"font-size:14px;\"><b>$msub[$b]</b></a><br>Posted by <b>$muaUsername</b></center><br>$Body<br><br><center>Posted on $days[$datePieces[1]], $months[$datePieces[0]] $datePieces[1] $myYear at $theHour:$theMinute $timeSet PST<br>from IP $mip[$b]</center></font></td></tr>\n"; 

}


#  Posted on $datePieces[0].$datePieces[1].$datePieces[2] \@ $theHour:$theMinute $timeSet - $mip[$b]

				#if ($b >= $maxdisplay && $maximum == 1 && $action ne 'showall') {
				#	$b = @messagesReal;
				#}
			}
		}
		for ($b = 0; $b < $last; $b++) {
			$lastSet = $parseCount - $maxdisplay;
			if ($b <= $parseCount && $b >= $lastSet) {
				if (!$FORM{'showAll'}) { print "</ul>\n"; }
			}
		}
}

$dbh->disconnect;


if ($FORM{'showAll'}) {
	print "</table>";
}

print "</td></tr></table>";

print qq~


					</td>
				</tr>
  <tr align="center" bgcolor="#000000">
    


~;

	print "<td width=\"12\" height=\"12\" valign=\"bottom\"><img src=\"images2005/botleftcorner2_forum.gif\" width=\"12\" height=\"12\"></td>";
	print "<td valign=\"top\" height=\"12\" width=\"100%\" class=\"leForumBot\"><img src=\"images2005/spacer.gif\" height=\"12\" width=\"12\" border=\"0\"></td>";


print qq~


	<td width="12" height="12" valign="bottom"><img src="images2005/botrightcorner_forum.gif"></td>
  </tr>

			</table>
</center>
</span>

&nbsp;
		</td>

	</tr>
</table>
<br>

<div id="myOverDiv"></div>
<script>
function showAdvert() { }
</script>
</body>
</html>

~;

sub dropBanner ($incoming) {
## request and then parse banner as needed
	my ($incoming) = @_;
	$leAdType = $incoming;
	require 'require_ad.nsp';
	$leAdType = "";
}