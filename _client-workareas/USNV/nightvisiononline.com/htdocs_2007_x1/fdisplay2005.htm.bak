#!/usr/bin/perl5 -s

$| = 1;

print "Content-type: text/html\n\n";

require("parse_query.nsp");

$IP = "$ENV{'REMOTE_ADDR'}";

require 'common2005.htm';

#require 'getBanner.nsp';

&getDate;
&readFormFields;

	$viewnum = $INFO{'num'};
	$viewnum = int ( $viewnum );

	&errorMessage("$text{'009'}") unless ($viewnum > 0);
	&openDatabase;

	for ($a = 0; $a < @messages; $a++) {
		($mnum[$a],$msub[$a],$mfollow[$a],$mname[$a],$memail[$a],$mdate[$a],$mip[$a],$magent[$a],$murl[$a],$chop) = split(/``/,$messages[$a]);
		if ($viewnum == $mnum[$a]) {
			$idnum = $a;
		}
	}


### QUERY DB
use DBI;
my $dbh = DBI->connect("DBI:mysql:NVF","root","32GCC5E7TSjqQ") or die "Unable to connect to database\n"; 
$dbh->{RaiseError} = 1; 


$count=0;
my $sth = $dbh->prepare("SELECT * FROM leForu WHERE PostadoID='$viewnum'");
$sth->execute or die "Unable to execute query\n"; 
my @row;
	while(@row = $sth->fetchrow_array) { 
		$Body = $row[3];
		$count++;
}
$sth->execute or die "Unable to execute query\n"; 
$sth->finish;
$dbh->disconnect;


$Body =~ s/\n/<br>/g;
#	open ('FILE', "$datadir/$viewnum\.txt") || &errorMessage("$text{'010'}");
#	&lockFile('FILE');
#	@body = <FILE>;
#	&unlockFile('FILE');
#	close('FILE');

	open ('FILE', "$postTemplateFile") || &errorMessage("$text{'011'}");
	&lockFile('FILE');
	@template = <FILE>;
	&unlockFile('FILE');
	close('FILE');

$AppTitle = "Night Vision Online Forum";




&thyHeader;


print qq~

<table width="100%" align="center" border="0" cellpadding="0" cellspacing="0">
  <tr> 
    <td width="100%" align="right" valign="top" height="94"><img src="images2005/newTopper_left.jpg" width="396" height="94"></td>
    <td width="333" align="left" valign="top" height="94"><img src="images2005/newTopper_mid_nowviewing.jpg" width="333" height="94"></td>
  </tr>
</table>
<table width="100%" align="center" border="0" cellpadding="0" cellspacing="0">
				<tr valign="top">
					<td height="20" colspan="3"><img src="images2005/spacer.gif" border="0" height="20"></td>
				</tr>
	<tr>
		<td width="15"><img src="images2005/spacer.gif" width="15" height="10" border="0"></td>
		<td width="100%" align="center" valign="top">
~;

## Snif cookie, if present test for username, fname, lname info...
require ("bcookiesnif.nsp");

@leEmail = split(/\[AT\]/,$memail[$idnum]);
$myEmail = $leEmail[0] . "\@" . $leEmail[1];

if ($myEmail =~ "@") {
	if ($myEmail =~ "noemail") { $myEmailer = "javascript:void(0);"; }
	elsif ($Cookies{'Entrado'} eq "YES") { $myEmailer = "fmsgr2005.htm?posterid=$mnum[$idnum]" }
	## USNV AND NMS CAN ALWAYS EMAIL FORUM USERS
	elsif ($IP =~ "206.55.152" || $IP =~ "68.123.147") { $myEmailer = "fmsgr2005.htm?posterid=$mnum[$idnum]" }
	else { $myEmailer = "javascript:void(0);\" onClick=\"alert('Sorry, you can only email a user if you have posted at least one message to this forum previously.\\n\\nAlso, if and when you delete your browser cookies, you will need to post a message to the forum to gain access to the messenger feature of this site.')\""; }
}
else {
	$myEmailer = "javascript:void(0);";
}

print "<form action=\"postMessage2005.htm?action=postMessage&follow=yes\" method=\"post\" name=\"bbsform\" onSubmit=\"return validateInfo();\">\n";
print "<input type=\"hidden\" name=\"followto\" value=\"$viewnum\">\n";
print "<input type=\"hidden\" name=\"level\" value=\"$mfollow[$idnum]\">\n";

$topWrapper = "<table width=\"100%\" border=\"0\" cellpadding=\"0\" cellspacing=\"0\" bgcolor=\"#000000\"><tr align=\"center\"><td width=\"12\" height=\"12\" valign=\"top\"><img src=\"images2005/topleftcorner_forum.gif\"></td><td valign=\"bottom\" height=\"12\" class=\"leForumTop\" bgcolor=\"#02341E\" width=\"209\"><img src=\"images2005/spacer.gif\" border=\"0\" height=\"1\" width=\"209\"></td><td valign=\"bottom\" height=\"12\" width=\"100%\" class=\"leForumTop\"><img src=\"images2005/spacer.gif\" border=\"0\" height=\"1\" width=\"1\"></td><td width=\"12\" height=\"12\" valign=\"top\"><img src=\"images2005/toprightcorner_forum.gif\"></td></tr><tr valign=\"top\"><td width=\"100%\" align=\"center\" colspan=\"4\" class=\"leForumLeftRight\" valign=\"top\">";
$botWrapper = "</td></tr><tr align=\"center\"><td width=\"12\" height=\"12\" valign=\"top\" align=\"left\"><img src=\"images2005/botleftcorner_forum.gif\"></td><td valign=\"top\" height=\"1\" width=\"209\" class=\"leForumBot\" bgcolor=\"#02341E\"><img src=\"images2005/spacer.gif\" height=\"1\" width=\"209\" border=\"0\"></td><td valign=\"top\" height=\"1\" width=\"100%\" class=\"leForumBot\"><img src=\"images2005/spacer.gif\" height=\"1\" width=\"1\" border=\"0\"></td><td width=\"12\" height=\"12\" valign=\"top\"><img src=\"images2005/botrightcorner_forum.gif\"></td></tr></table>";

#require 'getBanner.nsp';

push(@allInfo, $topWrapper);
push(@allInfo,"<TABLE bgcolor=\"#000000\" width=\"100%\" cellpadding=\"10\" align=\"center\" cellspacing=\"0\" border=\"0\"><tr valign=\"top\"><td width=\"200\" align=\"left\" bgcolor=\"#02341E\"><font class=\"commonText\"><div align=\"right\"><b>Topic / Discussion > ></b></div><ul><li>You can reply to this message by filling in the form fields below.</li><li>Or, you can click the \"Originator ( Username )\" to directly email the person who posted this message.</li><li>You can also see view all replies to this message at the lower section of this page or by <a href=\"#replies\" class=\"commonText\" style=\"color:#CCCCCC\">clicking here</a>.</li></ul><br><img src=\"images2005/spacer.gif\" height=\"1\" width=\"200\" border=\"0\"></font></td>");
push(@allInfo, "<td width=\"100%\" align=\"left\"><font class=\"commonText\" style='font-size:13px;'>");
if ($mname[$idnum] eq "" || $mname[$idnum] eq " ") { $muaUsername = "AnonymousUser"; }
else { $muaUsername = $mname[$idnum]; }
push(@allInfo,"<b>Originator ( Username )</b><br><div style=\"margin-left:20px;\"><a href=\"$myEmailer\" class=\"instruct\" style=\"font-size:13px;\">$muaUsername</a></div>");
push(@allInfo,"<br><br><b>Subject</b><br><div style=\"margin-left:20px;\">$msub[$idnum]</div>");
if ($murl[$idnum] =~ "://") {
	if ($murl[$idnum] =~ "nourl") { $sorryNoGood = 0; }
	else { push(@allInfo,"<br><br><b>Related URL</b><br><div style=\"margin-left:20px;\"><a href=\"javascript:void(0);\" onClick=\"window.open('$murl[$idnum]','RELATED');\" class=\"instruct\">$murl[$idnum]</a></div>"); }
}
push(@allInfo,"<br><br><b>Message</b><br><div style=\"margin-left:20px;\">$Body</div>");
push(@allInfo,"</font></td></tr></table>");
push(@allInfo, $botWrapper);
push(@allInfo, "<br>");

push(@allPrevious, "<a name=\"replies\"></a>");
push(@allPrevious, $topWrapper);
push(@allPrevious,"<TABLE width=\"100%\" cellpadding=\"10\" align=\"center\" cellspacing=\"0\" border=\"0\" bgcolor=\"#000000\"><tr valign=\"top\"><td width=\"200\" align=\"left\" bgcolor=\"#02341E\"><font class=\"commonText\"><font class=\"commonText\"><div align=\"right\"><b>Replies > ></b></div><br><img src=\"images2005/spacer.gif\" height=\"1\" width=\"200\" border=\"0\"></font>");
	push(@allPrevious,"<table align=\"center\" cellpadding=\"10\" cellspacing=\"0\" class=\"leForumWrap2\" bgcolor=\"#000000\"><tr><td align=\"center\"><font class=\"commonText\"><b>List Legend</b><br><br><div align=\"left\" style=\"font-size:9px;\">&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;<img src=\"images2005/UL1_2.png\" border=\"0\">) Direct Reply<br>&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;<img src=\"images2005/UL2_2.png\" border=\"0\">) Reply to Reply</div></font></td></tr></table>");
push(@allPrevious, "</td><td width=\"100%\" align=\"left\">");
push(@allPrevious, "<font class=\"commonText\" style='font-size:13px;'>");
			if ($mfollow[$idnum] >= $mfollow[$idnum+1]) {
				push(@allPrevious,"<br><div style=\"margin-left:20px;\">There are no replies to this message.</div>");
			}
			else {
				push(@allPrevious,"<ul class=\"UL1\">\n");
				$last = $mfollow[$idnum+1];
				for ($d = $idnum+1; $d < @messages; $d++) {
					if ($mfollow[$d] <= $mfollow[$idnum]) {
						$d = @messages;
						$count = $last - $mfollow[$idnum];
					}
					else {
						if ($mfollow[$d] > $last) {
							push(@allPrevious,"<ul class=\"UL2\">\n");
						}
						elsif ($mfollow[$d] < $last) {
							for ($e = 0; $e < $last - $mfollow[$d]; $e++) {
								push(@allPrevious,"</ul>\n");
							}	
						}
						push(@allPrevious,"<li>\n");
						push(@allPrevious,"<a href=\"fdisplay2005.htm?action=display\&num=$mnum[$d]\" class=\"instruct\" style='font-size:13px;'>$msub[$d]</a>");
						push(@allPrevious,"( $mname[$d] - $mdate[$d] )</li>\n");
					}
						$last = $mfollow[$d];
				}
				for ($b = 0; $b < $count; $b++) {
						push(@allPrevious,"</ul>\n");
				}
			}
push(@allPrevious, "</td></tr></table>");
push(@allPrevious, $botWrapper);
push(@allPrevious, "<br>");
			
## Snif cookie, if present test for username, fname, lname info...
require ("bcookiesnif.nsp");
			
$myInstructions = "<b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Reply to this message > > </b><br><br>You have the option of replying to this user's message. Please complete all required(*) fields in the following form to do so.<br><br><font class='star1'>Challenge Code:</font> It allows us to block automated message posting, the likes of spammers, advertisers and rouge users. You must enter the challenge code (<font class='star1' style='font-weight:normal;'>in lower case</font>) into the challenge field properly, otherwise you will not be allowed to post your message.<br><br>Please remember to be kind towards others, post messages that respect your feelings as well as those of other users. Don't post messages soliciting business, we offer you a place for you to legally advertise your business. Never reply to a message for the sole purpose of ranting about someone else's post, for this type of posts can get you banned from the system.<br><br>Most of all, Have fun and enjoy your stay...";
			
$leForm = `cat gui/form2005.inc`;



	require("gesichtDeEsel.nsp");

	$elImagen = '<span style="border:#D7A368 1px solid;padding:1px;margin-bottom:1px;"><img src="/besameDiesesEsel/' . $myImagen . '.jpg" width="196" style="Filter: Gray;"></span>';
	$elCompromiso = '<input type="hidden" name="gesicht" value="Esel">';
	$theChallenge = '<input type="hidden" name="simple" value="' . $myImagen . '">';
	$acquireChallenge = '<input class="commonInput" type="text" maxlength="6" size="10" style="margin-top:5px;" onfocus="this.style.backgroundColor=\'#D7A368\';" onblur="this.style.backgroundColor=\'#CCCCCC\';" name="challenger" value="">' . $elCompromiso . '';
		
	$nuestroChallenge = "<tr style=\"height:8px;\"><td align=\"center\"><font style=\"font-size:6px; letter-spacing:10px; color:#D7A368\">CHALLENGE CODE</font></td><td><font style=\"font-size:1px;\">&nbsp;</font></td></tr><tr><td align='right'>$elImagen $theChallenge</td><td align='left' valign='middle'><font class='commonText' style='line-height:16px;'><center>Type your 'challenge code' <br>below to \"Post Message\"</center></font>$acquireChallenge</td></tr>";
	$leForm =~ s/%%CHALLENGER%%/$nuestroChallenge/g;


$leForm =~ s/%%MyInstructions%%/$myInstructions/g;
$leForm =~ s/<!--MessageInfo-->/@allInfo/g;
$leForm =~ s/<!--PreviousReplies-->/@allPrevious/g;

if ($Cookies{'Entrado'} eq "YES") { 
	$leName = "$Cookies{'Boozer'}";
	$muaName = "value=\"$Cookies{'Boozer'}\" readonly";
	$muaEmail = "value=\"$Cookies{'Amil'}\" readonly";
	$muaEmail =~ s/\[AT\]/@/g;
	$muaMessage = "You last posted a message on $Cookies{'LP'} ";
}

$leForm =~ s/%%leName%%/$leName/g;
$leForm =~ s/%%Muaname%%/$muaName/g;
$leForm =~ s/%%Muaemail%%/$muaEmail/g;
$leForm =~ s/%%Muamessage%%/$muaMessage/g;

print "$leForm";

			
print qq~
		</td>
		<td width="15"><img src="images2005/spacer.gif" width="15" height="10" border="0"></td>
	</tr>
</table>
<!--
<table width="100%" align="center" border="0" cellpadding="10" cellspacing="0">
	<tr>
		<td width="100%" align="center" valign="middle">
			<table align="center" valign="middle" border="0" cellpadding="5" cellspacing="0" class="traditionalBacker">
				<tr valign="middle">
					<td width="100%">
~;

#print "<font class=\"adverHomeTradi\"><center><nobr><img src=\"images2005/adverarrow.gif\" border=\"0\" width=\"20\" height=\"5\"> ADVERTISEMENT<img src=\"images2005/adverarrow.gif\" border=\"0\" width=\"20\" height=\"5\"></nobr><br><img src=\"http://www.nightvisiononline.com/images2005/spacer.gif\" border=\"0\" width=\"450\" height=\"5\"></center></font>";
#require 'getBanner.nsp';
#&dropBanner('Traditional');

print qq~
					</td>
				</tr>
			</table>
		</td>
	</tr>
</table>
-->

~;
&thyFooter;

	print "</body></html>";
	exit;