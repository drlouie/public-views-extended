#!/usr/bin/perl5 -s

###########################################################################################################
# Company: ©2001 NetMedia Solutions                                                                       #
# Date: Saturday, September 21, 2001                                                                      #
# Location: Los Angeles County, California, United States of America                                      #
# Made By: Luis Rodriguez (drlouie)                                                                       #
# Email: Drlouie@NetMediaSol.com                                                                          #
#                                                                                                         #
# This program cannot be duplicated, distributed or re-used for any other purpose other than its original #
# intended purpose and function. You may request NetMedia Solutions for a copy of the script,             #
# personalized to fit your exact needs for a small re-programming fee.                                    #
###########################################################################################################

## --> Make sure all request coming from this server's domain or IP
require "referer.nsp";

## --> Snif cookie, if present test for logged in status
require ("cookiesnif.nsp");

## --> Parse Request Query
require ("parse_query.nsp");

## --> USNVSiteTemplates
require "templateMaster.nsp";
$showCartPreview = 0;
## --> Left Menu Inclusion
require ("leftMenu.nsp");



#- --> SET HARD PARAM
$ct = '9';


	#-- CONNECT TO DB (GET PAGE CONTENT)
	use DBI;
	my $dbh = DBI->connect("DBI:mysql:unvWeb","root","19nv8n6uilPoA") or die "Unable to connect to database: <b>unvWeb</b>\n"; 
	$dbh->{RaiseError} = 1; 

		my $sth = $dbh->prepare("SELECT * FROM WebsiteContent where ContentID = '$ct';");
		$sth->execute or die "Unable to execute query\n"; 
		my @row;
		while(@row = $sth->fetchrow_array) { 
			$PageContent = $row[1];
			$PageHeader = $row[2];
			$PCount++;
		}
		$sth->execute or die "Unable to execute query\n"; 
		$sth->finish;

		if ($FORM{'shipZip'}) {

			use Text::Beautify;

			$LCount=0;
			$myZip = "$FORM{'shipZip'}";
			my $sth = $dbh->prepare("SELECT * FROM USCensusZip1999 where ZIP_CODE = '$myZip';");
			$sth->execute or die "Unable to execute query\n"; 
			my @row;
			while(@row = $sth->fetchrow_array) {
				$CITYNAME = lc($row[4]);
				@splitCity = split(/ /,$CITYNAME);
				$CSC=0;
				foreach $SC (@splitCity) {
					my $text1 = Text::Beautify->new($SC);
					my $CleanCity = $text1->beautify;
					if ($CSC eq "0") { $splitCity[$CSC] = "$CleanCity"; }
					else { $splitCity[$CSC] = " $CleanCity"; }
					$CSC++;
				}

				
				$STATEID = $row[5];
				push(@Cities,"@splitCity");
				push(@StateIDs,"$STATEID");
				$LCount++;
			}
			$sth->execute or die "Unable to execute query\n"; 
			$sth->finish;
			
			foreach $SID (@StateIDs) {
				my $sth = $dbh->prepare("SELECT * FROM States where USCensusID = '$SID';");
				$sth->execute or die "Unable to execute query\n"; 
				my @row;
				while(@row = $sth->fetchrow_array) {
					$StateABV = $row[1];
					push(@States,"$StateABV");
					$LCount++;
				}
				$sth->execute or die "Unable to execute query\n"; 
				$sth->finish;
			}

			$CL = 0;
			foreach $CEE (@Cities) {
				if ($CL eq "0") { $theLocations = "$CEE, $States[$CL]"; }
				else { $theLocations = $theLocations . " and $CEE, $States[$CL]"; }
				$CL++;
			}
			
			
		}	





if ($Cookies{'Shicar'} ne "") {

$theTotalPrice = "0.00";



$myCartContent = "";


	$cartTable = '
		<table width="581" border="0" cellspacing="0" cellpadding="0">
			<tr height="1"><td colspan="12"><img src="Night_Vision_Images/resultsTableTopper_581.jpg" width="581" height="5"></td></tr>
			<tr bgcolor="#DEDDCC" valign="bottom">
				<td width="10"><img src="Night_Vision_Images/spacer.gif" width="10" height="25"></td>
				<td width="225"><font face="Arial" size="2" color="#000000"><b>Product</b></font></td>
				<td align="center" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
				<td width="40" align="center"><font face="Arial" size="1" color="#000000">Type</font></td>
				<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
				<td width="40" align="center"><font face="Arial" size="1" color="#000000">Class</font></td>
				<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
				<td width="50" align="center"><font face="Arial" size="1" color="#000000">Quantity</font></td>
				<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
				<td width="70" align="center"><font face="Arial" size="1" color="#000000">Wgt ea. (lb)</font></td>
				<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
				<td width="100" align="center"><font face="Arial" size="1" color="#000000">Total Price ($)</font></td>
			</tr>
			<tr height="1"><td colspan="12" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td></tr>
			!!TheseRows!!
			<tr height="1"><td colspan="12"><img src="Night_Vision_Images/resultsTableBottom_581.jpg" width="581" height="14"></td></tr>
			</table>!!ShipSelect!!<br>!!ThyButtons!!';
	$cartRow = '
		<tr height="19">
			<td width="10" style="border-left:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="10" height="19"></td>
			<td><font face="Arial" size="1" color="#000000"><nobr>!!PName!!</nobr></font></td>
			<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
			<td align="center"><font face="Arial" size="1" color="#000000"><nobr>!!Type!!</nobr></font></td>
			<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
			<td align="center"><font face="Arial" size="1" color="#000000"><nobr>!!Class!!</nobr></font></td>
			<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
			<td align="center"><font face="Arial" size="1" color="#000000">!!Quantity!!</font></td>
			<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
			<td align="left" style="padding-left:20px;" nowrap><font face="Arial" size="1" color="#000000">!!Weight!!</font></td>
			<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
			<td align="right" style="border-right:#DEDDCC 1px solid;" nowrap><font face="Arial" size="1" color="#000000"><nobr>!!TPrice!!<img src="Night_Vision_Images/spacer.gif" width="25" height="8" border="0"></nobr></font></td>
		</tr>
		<tr height="1"><td colspan="12" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td></tr>';

	## -->
	## --> Run Cookie reader for updates/deletions/quantity
	## -->

	#############################
	#### FIRST READ THE CART ####
	#############################
		## ----------------->>> 	
		## ----------------->>> FIRST read saved cart
		## ----------------->>> 
		$inUID = $Cookies{'Shicar'};
		my $sth = $dbh->prepare("SELECT * FROM customerScarts WHERE UID = '$inUID'");
		$sth->execute or die "Sorry, that Username/Password combination is incorrect, please try again.\n";
		my $row = $sth->fetchrow_arrayref;
		my $cartID = $row->[0];
		my $cartContents = $row->[2];
		my $cartEA = $row->[3];
		my $cartCID = $row->[4];
		my $cartDate = $row->[5];
		
		# more than one item
		if ($cartContents =~ "!!!!!!--!!!!!!") { @myCContents = split(/!!!!!!--!!!!!!/,$cartContents); }
		# one only
		else { $myCContents[0] = $cartContents; }
		
		$cMcc = 0;
		foreach $MCC (@myCContents) {
			$FORM{$myINDEL} = "";			
			## ----------------->>> IF COMING FROM CART, CHECK FOR DEL_ && QTY_
			if ($MCC =~ " %%%%%%%%%%% ") { @allMCC = split(/ %%%%%%%%%%% /,$MCC); }
			else { $allMCC[0] = $MCC; }
			
			$dontPush = 0;

			## find QTY fields by looking at QTY_Layout = (QTY_PID_ORDERPARSED)
			foreach $AMCC (@allMCC) {
				@sAMCC = split(/ xxxxx /,$AMCC);
				$myINQTY = "QTY_" . $sAMCC[0] . "_" . $cMcc;
				$myINDEL = "DEL_" . $sAMCC[0] . "_" . $cMcc;
				if ($FORM{$myINQTY}) {
					if ($MCC =~ " %%%%%%%%%%% ") { $MCC = "$sAMCC[0] xxxxx $FORM{$myINQTY} %%%%%%%%%%% $allMCC[1]"; }
					else { $MCC = "$sAMCC[0] xxxxx $FORM{$myINQTY}"; }
					
					
					## dont parse if chosen to delete
					if ($FORM{$myINDEL} eq "on") {
						# $cartTable = $cartTable . "<script>alert('$FORM{$myINDEL}');</script>";
						$dontPush = 1;
					}

				}

			 }


			if ($dontPush eq "0") { push(@cartedItems,"$MCC"); }
			$cMcc++;
		}


	
	

	
	
	
	
	print "Content-type: text/html \n\n";

	## --> Main Template START
	print $USNVMainTemplateTop;



## --->>> IF CHOOSING PACKAGE (Ship Method)
if (!$FORM{'Package'} && $Cookies{'Shicar'} ne "") {


	$pd = "Your shipping zip code has been verified and now will be used to calculate the price for shipping the items you ordered to you. Select a shipping method from the UPS list below and click 'Calculate Shipping Cost'.<br><br>We always utilize UPS to deliver all our orders and always insure every package to make sure you get a fully guaranteed product. From it's conceptualization, to it's design and its manfacturing, you will always get State-of-the-Art equipment from US Night Vision Corporation.";

	###							   
	### SHIP METHOD SELECTION
	###
	$shippingSelector = '
	<br><font style="font-size:12px;font-family:arial,verdana,helevtica;color:#eb0000;font-weight:bold;">Select a shipping method:<br><br></font>
	<table width="550"  border="0" cellspacing="0" cellpadding="0">
                        <tr>
                          <td colspan="3"><img src="Night_Vision_Images/resultsTableTopper.jpg" width="550" height="5"></td>
                        </tr>
                        <tr>
                          <td width="125" rowspan="3" style="border-left:#DEDDCC 1px solid;cursor:hand;" title="We always utilize UPS to deliver all our orders and always insure every package to make sure you get a fully guaranteed working product at time of delivery."><img src="Night_Vision_Images/shipUPS.jpg" width="125" height="67" border="0"></td>
                          <td colspan="2" align="left" bgcolor="#DEDDCC" style="padding-left:10px;" height="35"><font face="Verdana" size="1" color="#000000">Please select a shipping method (package) from the list below and click \'Calculate Shipping Cost\'.</font></td>
                        </tr>
                        <tr>
                          <td colspan="2" height="1" bgcolor="#ffffff" style="border-right:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
                        </tr>
                        <tr height="50">
                          <td width="212" align="center" bgcolor="#DEDDCC"><font face="Verdana" size="1" color="#000000" style="line-height:17px;"><b>Shipping Zip Code</b><br><a href="javascript:document.location.href=\'http://www.usnightvision.com/cart.htm?verifyZip=1&shipZip=Enter New ZIP\';" title="Click to enter a different ZIP CODE"><font color="#eb0000">' . $myZip . '</font></a><input type="hidden" name="shipZip" value="' . $myZip . '"</td>
                          <td width="213" align="center" bgcolor="#DEDDCC"><font face="Verdana" size="1" color="#000000" style="line-height:17px;"><b>Select a Shipping Method</b><br><select class="input" name="Package"><option value="1DM">Next Day Air Early AM</option><option value="1DA">Next Day Air</option><option value="2DA">2nd Day Air</option><option value="3DS">3 Day Select</option><option value="GNDCOM">Ground Commercial</option><option value="GNDRES">Ground Residential</option></select></font></td>
                        </tr>
                        <tr>
                          <td colspan="3"><img src="Night_Vision_Images/resultsTableBottom.jpg" width="550" height="14"></td>
                        </tr>
                      </table>
	';	

	@CT = "";

	&parseCartContents;

	
	## --->>>ADD ALL PRICES TOGETHER FOR TOTAL
	$theTotalPrice = 0;
	$theTotal = 0;
	foreach $myCTotal (@CT) {
		$theTotalPrice = $theTotalPrice+=$myCTotal;
		# $PageContent = $PageContent . "<script>alert('$theTotalPrice');</script>";
	}
	$theTotal=&format_money($theTotalPrice);




		###							   
		### ADDED ROWS TO MAIN TABLE (weight & totals)
		###
		$allRows = $allRows . "
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
							   <tr>
							   		<td colspan=\"10\" align=\"right\" style=\"padding-right:10px; line-height:24px;border-left:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\">Cart Sub-Total</font></td>
									<td bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
							   		<td align=\"right\" style=\"border-right:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\">$theTotal<img src=\"Night_Vision_Images/spacer.gif\" width=\"25\" height=\"8\" border=\"0\"></font></td>
								</tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>



								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
							   	<tr bgcolor=\"#DEDDCC\">
							   		<td colspan=\"8\" align=\"right\" style=\"padding-right:10px; line-height:24px;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\"><b>Total Weight</b></font></td>
									<td bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
							   		<td style=\"padding-left:20px;\" ><font face=\"Verdana\" size=\"1\" color=\"#000000\"><b>$allWeights lbs</b></font></td>
									<td bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
									<td align=\"center\" bgcolor=\"#DEDDCC\" style=\"border-right:#DEDDCC 1px solid;cursor:hand;\" title=\"This figure shown below upon selection of shipping package.\"><font face=\"Verdana\" size=\"1\" color=\"#eb00000\"><i>Shipping Price</i></font></td>
								</tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>

								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
							   ";

	
	
	$myCT = $cartTable;
	$myCT =~ s/!!TheseRows!!/$allRows/gi;
	$myButtons = '<input type="submit" value="Calculate Shipping Cost" class="submitButton" onClick="document.location.href=\'http://www.usnightvision.com/US_Night_Vision_Inventory_Pricesheet.htm\';">';
	$PageContent =~ s/!!ThisTitle!!/Shopping Cart ( Select Shipping Method )/gi;
	$PageContent =~ s/!!ProductSubTitle!!/<b>$cAllItems Items in Your Cart<\/b>/gi;
	$PageContent =~ s/!!PageDescription!!/$pd/gi;
	$PageContent =~ s/!!PageContent!!/$myCT/gi;
	$PageContent =~ s/!!FormAction!!/http:\/\/www.usnightvision.com\/calculateShipping.htm/gi;
	$PageContent =~ s/!!ThyButtons!!/$myButtons/gi;		


	$PageContent =~ s/!!ShipSelect!!/$shippingSelector/gi;	
	
}













## --->>> IF PACKAGE CHOSEN (Order or Quote Selection)
if ($FORM{'Package'} && $Cookies{'Shicar'} ne "") {




@CT = "";

&parseCartContents;

	## --->>>ADD ALL PRICES TOGETHER FOR TOTAL
	$theTotalPrice = 0;
	$theTotal = 0;
	foreach $myCTotal (@CT) {
		$theTotalPrice = $theTotalPrice+=$myCTotal;
		# $PageContent = $PageContent . "<script>alert('$theTotalPrice');</script>";
	}
	$theTotal=&format_money($theTotalPrice);




		###							   
		### ADDED ROWS TO MAIN TABLE (weight & totals)
		###
		$allRows = $allRows . "
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
							   <tr>
							   		<td colspan=\"10\" align=\"right\" style=\"padding-right:10px; line-height:24px;border-left:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\">Cart Sub-Total</font></td>
									<td bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
							   		<td align=\"right\" style=\"border-right:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\">$theTotal<img src=\"Night_Vision_Images/spacer.gif\" width=\"25\" height=\"8\" border=\"0\"></font></td>
								</tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>



								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
							   	<tr bgcolor=\"#DEDDCC\">
							   		<td colspan=\"8\" align=\"right\" style=\"padding-right:10px; line-height:24px;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\"><b>Total Weight</b></font></td>
									<td bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
							   		<td style=\"padding-left:20px;\" ><font face=\"Verdana\" size=\"1\" color=\"#000000\"><b>$allWeights lbs</b></font></td>
									<td bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
									<td align=\"center\" bgcolor=\"#DEDDCC\" style=\"border-right:#DEDDCC 1px solid;cursor:hand;\" title=\"This figure shown below upon selection of shipping package.\"><font face=\"Verdana\" size=\"1\" color=\"#eb00000\"><i>Shipping Price</i></font></td>
								</tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>

								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
							   ";

###							   
### ADDED ROWS TO MAIN TABLE (weight & totals)
###


							   
							   

	## ----------------->>> 
	## ----------------->>> CALCULATE SHIPPING COSTS
	## ----------------->>> 
	use lib '.';
	use Business::UPS;
	my $type = "$FORM{'Package'}";
	my $to = "$FORM{'shipZip'}";
	my $wgt = "$allWeights";
	my ($from,$co) = qw/92626/;
	my ($shipping,$ups_zone,$error) = getUPS($type,$from,$to,$wgt,$co,'', '', '', '', '');
	
	## ----------------->>> IF ERROR (TRY TO CLEAN UP/OPTION FOR RE-TRY)
	if ($error) { 
		$error =~ s/to the requested destination/to the requested destination at this time/gi;
		$error =~ s/Please select UPS/Please select/gi;
		$error =~ s/service as an alternative./as your alternative shipping method. Click 'Choose an Alternative' to go back to the shipping method selection screen./gi;
		$pd = $error; 
	
		$myButtons = "<input type=\"button\" value=\"Choose an Alternative\" class=\"submitButton\" onClick=\"javascript:document.location.href='http://www.usnightvision.com/calculateShipping.htm?shipZip=$myZip';\">";
		$PageContent =~ s/!!ThisTitle!!/Shopping Cart ( Select Shipping Method )/gi;
		$PageContent =~ s/!!ProductSubTitle!!/<b>Shipping Method Error<\/b>/gi;
		$PageContent =~ s/!!PageDescription!!/$pd/gi;
		$PageContent =~ s/!!PageContent!!/!!ThyButtons!!/gi;
		$PageContent =~ s/!!FormAction!!//gi;
		$PageContent =~ s/!!ThyButtons!!/$myButtons/gi;
		$PageContent =~ s/!!ShipSelect!!//gi;
	
	}
	## ----------------->>> ELSE GOOD REPLY = CONTINUE PROCESS (Order or Quote Selection)
	else { 
		$pd = "Your route has been cleared, your package(s) have been measured and weighed and the shipping price for the delivery service has been calculated. If you are satisfied with your choice of shipping method and agree to the <i>Total Cart Price</i>, click 'Order Now' to jump to the final process of Ordering or click 'Request Quote' to submit a price quote request to us.<br><br><i>If you want to change your shipping method selection simply click the shipping price highlighted in red to take you to the selection screen.</i>"; 

		$handlingCharge = "15.00";

		### --->CALCULATE INSURANCE COST
		$insuranceCharge = int(int($theTotalPrice / 100) * .75);

		### --->INSURANCE COST
		$insuranceCharged = "$insuranceCharge";
		$insuranceCharged=&format_money($insuranceCharged);

		### --->ADD ALL SHIPPING COSTS INTO ONE CHARGE
		$newSCost = ($shipping + $handlingCharge) + $insuranceCharge;

		### --->SHIP COST
		$leSCost = "$newSCost";
		$leSCost=&format_money($leSCost);

		### --->TOTAL CART PRICE
		$TCPrice = ($newSCost + $theTotalPrice);
		$TCPrice=&format_money($TCPrice);

		## cual package
		@Packages = ("1DM,Next Day Air Early AM","1DA,Next Day Air","2DA,2nd Day Air","3DS,3 Day Select","GNDCOM,Ground Commercial","GNDRES,Ground Residential");
		foreach $Type (@Packages) {
			local($value, $name) = split(/,/, $Type);	
			if ($FORM{'Package'} eq "$value") { $miPackage = "$name"; }
		}		


		$allRows = $allRows . "
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>

							   <tr>
							   		<td colspan=\"10\" align=\"right\" style=\"padding-right:10px; line-height:24px;border-left:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\"><i style=\"cursor:hand;\" title=\"Cost of shipping includes: Freight Price, Shipping Insurance and Handling Charge\n\nWe always add insurance to every product shipment for your and our protection.\">Cost of Shipping</i></font></td>
									<td bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
							   		<td align=\"right\" style=\"border-right:#DEDDCC 1px solid;background-image:url('Night_Vision_Images/UPSicon.gif'); background-repeat: no-repeat; background-position: left 2px; cursor:hand;\" onClick=\"javascript:document.location.href='http://www.usnightvision.com/calculateShipping.htm?shipZip=$myZip';\" title=\"Click to select a different shipping method (package). You currently have $FORM{'Package'} ( $miPackage ) as your shipping method.\"><a href=\"javascript:document.location.href='http://www.usnightvision.com/calculateShipping.htm?shipZip=$myZip';\"><font face=\"Verdana\" size=\"1\" color=\"#eb0000\">$leSCost</font></a><img src=\"Night_Vision_Images/spacer.gif\" width=\"25\" height=\"8\" border=\"0\"></td>
								</tr>

								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>


							   <tr bgcolor=\"#DEDDCC\">
							   		<td colspan=\"10\" align=\"right\" style=\"padding-right:10px; line-height:24px;border-left:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\"><b>Total Cart Price</b></font></td>
									<td bgcolor=\"#FFFFFF\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
							   		<td align=\"right\" style=\"border-right:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\"><b>\$$TCPrice</b><img src=\"Night_Vision_Images/spacer.gif\" width=\"25\" height=\"8\" border=\"0\"></font></td>
								</tr>

								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>


							   ";
		
		
		
		
		$myCT = $cartTable;
		$myCT =~ s/!!TheseRows!!/$allRows/gi;

		$myButtons = '


		<input type="hidden" name="shipZip" value="' . $to . '">
		<input type="hidden" name="Package" value="' . $type . '">
		
		<table width="100%" border="0" cellspacing="0" cellpadding="0" align="center">
			<tr>
				<td width="50%" align="right" valign="top" style="padding-right:10px;">

					<table width="207" border="0" cellspacing="0" cellpadding="0">
						<tr height="1"><td colspan="12"><img src="Night_Vision_Images/orderQuoteTopper.jpg" width="207" height="5"></td></tr>
						<tr valign="bottom">
							<td colspan="3" align="center" style="padding-top:5px;padding-bottom:8px;border-left:#DEDDCC 1px solid;border-right:#DEDDCC 1px solid;"><input type="submit" value="Order Now" class="submitButton"></td>
						</tr>
						<tr valign="bottom">
							<td width="1" style="border-left:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
							<td align="left" bgcolor="#DEDDCC" width="205" style="padding:15px;"><font style="font-size:10px;font-family:verdana,arial,helvetica;color:#000000;line-height:14px;">Use this option to continue with our SECURE online purchasing process. In order to complete your order we will need to verify your identity, your credit card and/or payment option and gather your shipping & billing addresses.<br><br>Our shopping cart system is secure and all data we gather is only utilized in processing your online purchase(es). </font></td>
							<td width="1" style="border-right:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
						</tr>
						<tr height="1"><td colspan="12"><img src="Night_Vision_Images/orderQuoteBottom.jpg" width="207" height="14"></td></tr>
					</table>

				</td>

				<td align="center" valign="top" style="padding-left:5px;padding-right:5px;"><font style="font-size:12px;font-family:verdana,arial,helvetica;color:#000000;line-height:28px;"><b>OR</b></font></td>

				<td width="50%" align="left" valign="top" style="padding-left:10px;">

					<table width="207" border="0" cellspacing="0" cellpadding="0">
						<tr height="1"><td colspan="12"><img src="Night_Vision_Images/orderQuoteTopper.jpg" width="207" height="5"></td></tr>
						<tr valign="bottom">
							<td colspan="3" align="center" style="padding-top:5px;padding-bottom:8px;border-left:#DEDDCC 1px solid;border-right:#DEDDCC 1px solid;"><input type="button" value="Request Quote" class="submitButton" onClick="javascript:document.location.href=\'http://www.usnightvision.com/requestQuote.htm?shipZip=' . $to . '&Package=' . $type . '\';"></td>
						</tr>
						<tr valign="bottom">
							<td width="1" style="border-left:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
							<td align="left" bgcolor="#DEDDCC" width="205" style="padding:15px;"><font style="font-size:10px;font-family:verdana,arial,helvetica;color:#000000;line-height:14px;">This option is for dealers, re-sellers, international buyers and high volume sales including Military, Law Enforcement, Security and similar organizations.<br><br>A quote is automatically generated and a copy sent to you and another is sent to the the proper US Night Vision Rep. He/she will give you a call or e-mail you to handle your quote request personally.</font></td>
							<td width="1" style="border-right:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
						</tr>
						<tr height="1"><td colspan="12"><img src="Night_Vision_Images/orderQuoteBottom.jpg" width="207" height="14"></td></tr>
					</table>

				</td>
			</tr>
		</table>
				



			
			
			
			
		';
		$PageContent =~ s/!!ThisTitle!!/Shopping Cart ( Select Shipping Method )/gi;
		$PageContent =~ s/!!ProductSubTitle!!/<b>$cAllItems Items in Your Cart<\/b>/gi;
		$PageContent =~ s/!!PageDescription!!/$pd/gi;
		$PageContent =~ s/!!PageContent!!/$myCT/gi;

		## 	REMOVE HTTPS (TEMP)		
		##	$PageContent =~ s/!!FormAction!!/https:\/\/www.usnightvision.com\/processOrder.htm/gi;
		$PageContent =~ s/!!FormAction!!/http:\/\/www.usnightvision.com\/processOrder.htm/gi;

		$PageContent =~ s/!!ThyButtons!!/$myButtons/gi;
		$PageContent =~ s/!!ShipSelect!!//gi;
		
	}



	## ----------------->>> 
							   
	

	
	
	
	
}












print qq~
				<table width="100%" cellpadding="0" cellspacing="0" border="0">
					<tr>
						<td><img src="Night_Vision_Images/spacer.gif" border="0" width="1" height="1"></td>
					</tr>
$myTopBanner


				</table>

			<!--STARTMainLayoutTable-->
				<table width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="#FFFFFF">
					<tr>
						<td width="175" height="2"><img src="Night_Vision_Images/spacer.gif" border="0" width="175" height="2"></td>
						<td width="1" height="2" background="Night_Vision_Images/verticalDottie.gif"><img src="Night_Vision_Images/spacer.gif" border="0" width="1" height="2"></td>
						<td width="100%" height="2"><img src="Night_Vision_Images/spacer.gif" border="0" width="1" height="2"></td>
					</tr>

					<tr>

						<!--STARTLeftMenu-->
						<td width="175" valign="top">
							$leftMenu
						</td>
						<!--ENDLeftMenu-->

						<!--STARTMenu/ContentDivider-->
						<td width="1" background="Night_Vision_Images/verticalDottie.gif"><img src="Night_Vision_Images/spacer.gif" border="0" width="1" height="20"></td>
						<!--ENDMenu/ContentDivider-->

						<!--STARTMainContentArea-->
						<td width="100%" valign="top">

							$PageContent
							
						</td>
						<!--ENDMainContentArea-->

					</tr>


				</table>
			<!--ENDMainLayoutTable-->


~;	
	
	
	
## print out main template BOT from templateMaster.nsp
print $USNVMainTemplateBot;

$dbh->disconnect;

}


exit;



sub parseCartContents {
	$allRows = "";
	$cAllItems = 0;
	foreach $theamc (@cartedItems) {
		$myExtraTabler = "";
		## --> if contains option split the item
		if ($theamc =~ "OPT_") { 
			@stamc = split(/ %%%%%%%%%%% /,$theamc);
			$amc = $stamc[0];
			$myOPTs = $stamc[1];
		}
		## --> else only product, no option
		else { $amc = $theamc; $myOPTs = ""; }

		## --> make sure its legit
		if ($amc =~ "xxxxx") {
			@SPLITAMC = split(/ xxxxx /, $amc);
			$thyPID = $SPLITAMC[0];
			$quant = $SPLITAMC[1];

			my $sth = $dbh->prepare("SELECT * FROM newProducts WHERE ProductID='$thyPID'");
			$sth->execute or die "Unable to execute query\n"; 
			my @row;
				while(@row = $sth->fetchrow_array) { 
					$SavedPartNum = $row[1];
					$SavedMFGName = $row[2];
					$SavedMFGPartNum = $row[3];
					$SavedMFGProdURL = $row[4];
					$SavedItemName = $row[5];
					$SavedDescription = $row[6];
					$SavedTechSpecs = $row[7];
					$SavedSmallPhoto = $row[8];
					$SavedLargePhoto = $row[9];
					$SavedWarranty = $row[10];
					$SavedWeight = $row[11];
					$SavedMasterDist = $row[12];
					$SavedDistributor = $row[13];
					$SavedDealer = $row[14];
					$SavedLawEnforce = $row[15];
					$SavedRetail = $row[16];
					$SavedAccessories = $row[17];
					$SavedProdUsage = $row[18];
					$SavedProductType = $row[19];
					$SavedGeneration = $row[20];
					$BrochureBulletPoints = $row[23];
					$SavedIncludedItems = $row[28];
					$SavedSpecialDiscount = $row[37];
					$SavedProductOptions = $row[38];
					if ($SavedProductOptions =~ ":::::") {
						@splitPO = split(/\n\b/,$SavedProductOptions);
						$cPOs = 1;
						foreach $PO (@splitPO) { $allSavedPOs[$cPOs] = "$PO"; $cPOs++; }
					}
				}

				if ($custUName =~ "@") {
					## NOW YOU KNOW
					if ($custTipo eq "MasterDist") { $lePrice = "$SavedMasterDist"; }
					elsif ($custTipo eq "Distributor") { $lePrice = "$SavedDistributor"; }
					elsif ($custTipo eq "Dealer") { $lePrice = "$SavedDealer"; }
					elsif ($custTipo eq "LawEnforce") { $lePrice = "$SavedLawEnforce"; }
					else { $lePrice = "$SavedRetail"; }
				}
				elsif ($Cookies{'Logged'} eq "SI") {
					if ($Cookies{'CT'} eq "MasterDist") { $lePrice = "$SavedMasterDist"; }		
					elsif ($Cookies{'CT'} eq "Distributor") { $lePrice = "$SavedDistributor"; }		
					elsif ($Cookies{'CT'} eq "Dealer") { $lePrice = "$SavedDealer"; }		
					elsif ($Cookies{'CT'} eq "LawEnforce") { $lePrice = "$SavedLawEnforce"; }
					else { $lePrice = "$SavedRetail"; }
				}
				else { $lePrice = "$SavedRetail"; }

				if ($SavedSpecialDiscount ne "0" && $SavedSpecialDiscount ne "" && $SavedSpecialDiscount ne "0.00") {
					$centuri = $lePrice / 100;
					$discountAmount = $centuri * $SavedSpecialDiscount;
					$newPrice = $lePrice - $discountAmount;
					$TP = $quant * $newPrice;
					$myTotal=&format_money($TP);
					$myDollar=&format_money($newPrice);
					$myTotal = "<font style=\"color:#eb0000;cursor:hand;\" title=\"Sale Priced Item\">$myTotal</font>";
					$myDollar = "<font style=\"color:#eb0000;cursor:hand;\" title=\"Sale Priced Item\">$myDollar</font>";
					$saleStyle = "style='color:#eb0000;' title='Sale Priced Option'";
				}
				else {
					$TP = $quant * $lePrice;
					$myTotal=&format_money($TP);
					$myDollar=&format_money($lePrice);
					$saleStyle = "style='color:#000000;'";
				}
			
				push(@CT,"$TP");

				
				if ($SavedProductType =~ "Accessory") { $myPT = "ACC"; }
				elsif ($SavedProductType =~ "Binocular") { $myPT = "BIN"; }
				elsif ($SavedProductType =~ "BodyArmor") { $myPT = "ARM"; }
				elsif ($SavedProductType =~ "Thermal") { $myPT = "THRM"; }
				elsif ($SavedProductType =~ "Digital") { $myPT = "DIG"; }
				elsif ($SavedProductType =~ "Goggle") { $myPT = "GOG"; }
				elsif ($SavedProductType =~ "Laser") { $myPT = "LAS"; }
				elsif ($SavedProductType =~ "Monocular") { $myPT = "MON"; }
				elsif ($SavedProductType =~ "Weapon") { $myPT = "WPN"; }
	
				if ($SavedGeneration =~ "I") { $myClass = "G1"; }
				elsif ($SavedGeneration =~ "II") { $myClass = "G2"; }
				elsif ($SavedGeneration =~ "IIP") { $myClass = "G2+"; }
				elsif ($SavedGeneration =~ "III") { $myClass = "G3"; }
				elsif ($SavedGeneration =~ "Viewer") { $myClass = "DIG"; }
				elsif ($SavedGeneration =~ "N/A") { $myClass = "n/a"; }
				
			
			$sth->execute or die "Unable to execute query\n"; 
			$sth->finish;
		
		
		
			$ProductName = "<a href=\"http://www.usnightvision.com/Night_Vision_Products.htm?PID=$thyPID\"><font face=\"Arial\" size=\"1\" color=\"#000000\">$SavedItemName</font></a>";
			$myQuantity = "$quant";
		
			$thisRowItem = $cartRow;
			$thisRowItem =~ s/!!PName!!/$ProductName/gi;
			$thisRowItem =~ s/!!Type!!/$myPT/gi;
			$thisRowItem =~ s/!!Class!!/$myClass/gi;
			$thisRowItem =~ s/!!Quantity!!/$myQuantity/gi;
			$thisRowItem =~ s/!!TPrice!!/$myTotal/gi;
			$thisRowItem =~ s/!!Weight!!/$SavedWeight/gi;
		
		


		#################################
		#### product options inserts ####
		#################################
		$myExtraTabler = "";
			if ($myOPTs =~ "OPT_") {

				## --> more than one option chosen
				if ($myOPTs =~ " %%%%% ") { @allOPTs = split(/ %%%%% /,$myOPTs); }
				## --> only one option chosen
				else { $allOPTs[0] = $myOPTs; }
				
				foreach $aOPTs (@allOPTs) {
				
					$aOPTs =~ s/OPT_//gi;
					@splitAOPTS = split(/:::::/,$allSavedPOs[$aOPTs]);
					

					$mydollar = int($splitAOPTS[1]);
					$tpOPT = $quant * $mydollar;
					$MD=&format_money($tpOPT);

					$myExtraTabler = $myExtraTabler . '
					<tr height="19">
						<td width="10" style="border-left:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="10" height="19"></td>
						<td><font face="Arial" size="1" color="#000000"><nobr><font face="Arial" size="1" color="#000000"> - ' . $splitAOPTS[0] . '</font></nobr></font></td>
						<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
						<td align="center"><font face="Arial" size="1" color="#000000"><nobr>OPT</nobr></font></td>
						<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
						<td align="center"><font face="Arial" size="1" color="#000000"><nobr>n/a</nobr></font></td>
						<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
						<td align="center"><font face="Arial" size="1" color="#000000">-</font></td>
						<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
						<td style="padding-left:20px;" nowrap><font face="Arial" size="1" color="#000000">&nbsp;&nbsp;-</font></td>
						<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
						<td align="right" style="border-right:#DEDDCC 1px solid;" nowrap><font face="Arial" size="1" color="#000000" ' . $saleStyle . '><nobr>' . $MD . '<img src="Night_Vision_Images/spacer.gif" width="25" height="8" border="0"></nobr></font></td>
					</tr>
					<tr height="1"><td colspan="12" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td></tr>
					';

					push(@CT,"$tpOPT");
			}
		}

		## (counting ITEMS in CART) NOT ADDING options to the total cart count
		$cAllItems = int($cAllItems + $quant);
		
		$allWeights = ($SavedWeight * $quant) + $allWeights;
		$allRows = $allRows . $thisRowItem . $myExtraTabler;
		
		
		}
	}







	1;
}