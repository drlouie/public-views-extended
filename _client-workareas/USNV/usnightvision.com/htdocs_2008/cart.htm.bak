#!/usr/bin/perl5 -s


###########################################################################################################
# Company: ©2001 NetMedia Solutions                                                                       #
# Date: Saturday, September 21, 2001                                                                      #
# Location: Los Angeles County, California, United States of America                                      #
# Made By: Luis Rodriguez (drlouie)                                                                       #
# Email: Drlouie@NetMediaSol.com                                                                          #
#                                                                                                         #
# This program cannot be duplicated, distributed or re-used for any other purpose other than its original #
# intended purpose and function. You may request NetMedia Solutions for a copy of the script,             #
# personalized to fit your exact needs for a small re-programming fee.                                    #
###########################################################################################################

## --> Make sure all request coming from this server's domain or IP
require "referer.nsp";

## --> Snif cookie, if present test for logged in status
require ("cookiesnif.nsp");

## --> Parse Request Query
require ("parse_query.nsp");

## --> USNVSiteTemplates
require "templateMaster.nsp";

## --> Left Menu Inclusion
require ("leftMenu.nsp");


#- --> SET HARD PARAM
$ct = '9';


	#-- CONNECT TO DB (GET PAGE CONTENT)
	use DBI;
	my $dbh = DBI->connect("DBI:mysql:unvWeb","root","19nv8n6uilPoA") or die "Unable to connect to database: <b>unvWeb</b>\n"; 
	$dbh->{RaiseError} = 1; 

		my $sth = $dbh->prepare("SELECT * FROM WebsiteContent where ContentID = '$ct';");
		$sth->execute or die "Unable to execute query\n"; 
		my @row;
		while(@row = $sth->fetchrow_array) { 
			$PageContent = $row[1];
			$PageHeader = $row[2];
			$PCount++;
		}
	$sth->execute or die "Unable to execute query\n"; 
	$sth->finish;




$myCartContent = "";
	
	

## --> 
## --> if checking ZIPCODE
## --> 

if ($FORM{'shipZip'} ne "" && $FORM{'shipZip'} ne " " && $FORM{'verifyZip'} eq "1" ) {

	print "Content-type: text/html \n\n";

	use lib '.';
	use Business::UPS;

	my $from = "92626";
	my $to = "$FORM{'shipZip'}";
	my $wgt = "1";
	my $type = "3DS";
	my ($co) = qw//;
	my ($shipping,$ups_zone,$error) = getUPS($type,$from,$to,$wgt,$co,'', '', '', '', '');

	if ($error) {
		$error =~ s/domestic or Puerto Rico must have five digits/domestic addresses must be 5 digits, please re-type your zip code for verification/gi;
		$error =~ s/between the selected locations/for the zip code you entered, please re-type your zip code for verification/gi;
		$error =~ s/Invalid ConsigneePostalCode/Enter a Zip Code for the address you want to have us ship your products./gi;

		$muaError = $error;
	}
	else { 
		print "<script language=\"Javascript\">document.location.href='calculateShipping.htm?shipZip=$to';</script>"; 
	}

	# $ups_zone



	
	## --> Main Template START
	print $USNVMainTemplateTop;

	$pd = "$muaError";
	$myContinueShopping = "<input type=\"hidden\" name=\"verifyZip\" value=\"1\"><font class=\"description\" style=\"color:#eb0000\">Zip Code (USA)<br></font><input type=\"text\" name=\"shipZip\" value=\"$to\" OnKeyPress=\"checkInputZip(this);\"><br><br><input type=\"submit\" value=\"Validate new Zip Code\" class=\"submitButton\">";
	$PageContent =~ s/!!ThisTitle!!/Shopping Cart ( Verify Zip Code )/gi;
	$PageContent =~ s/!!ProductSubTitle!!/<b>Zip Code is Invalid or Incorrect<\/b>/gi;
	$PageContent =~ s/!!PageDescription!!/$pd/gi;
	$PageContent =~ s/!!PageContent!!/!!ThyButtons!!/gi;
	$PageContent =~ s/!!FormAction!!/cart.htm/gi;
	$PageContent =~ s/!!ThyButtons!!/$myContinueShopping/gi;
}	
	

	


## --> 
## --> if Emptying cart contents
## --> 

elsif ($FORM{'EMPTY'} eq "1") {
	print "Content-type: text/html \n";
		&SetCookies('Shicar',);
	print "\n";

	## --> Main Template START
	print $USNVMainTemplateTop;

	$pd = "Your shopping cart has been emptied as per your request. If you are have trouble navigating our online store, ordering our products or simply have any questions or comments, please feel free to contact us. Our company's contact information is located at the foot and head of every screen on this site.";
	$myContinueShopping = '<input type="submit" value="Continue Shopping" class="submitButton">';
	$PageContent =~ s/!!ThisTitle!!/Shopping Cart Contents/gi;
	$PageContent =~ s/!!ProductSubTitle!!/<b>Shopping Cart is Empty<\/b>/gi;
	$PageContent =~ s/!!PageDescription!!/$pd/gi;
	$PageContent =~ s/!!PageContent!!//gi;
	$PageContent =~ s/!!FormAction!!/US_Night_Vision_Inventory_Pricesheet.htm/gi;
	$PageContent =~ s/!!ThyButtons!!/$myContinueShopping/gi;	

}



elsif ($FORM{'location'} eq "International") {

	print "Content-type: text/html \n\n";

	## --> Main Template START
	print $USNVMainTemplateTop;

	$pd = "All our product sales to and for International customers are handled on a case-by-case basis, meaning we have to make sure you have U.S. Department of Commerce export clearance and licensing for the export of those technologies. USNV markets and sells its products directly to international government, law enforcement, military and security agencies and with the the proper domestic licenses for the technologies in question.<br><br>Although we do help our international law enforcement and military agencies obtain necessary U.S. government export approvals, USNV prefers to handle international consumer level sales through qualified dealers located in the customer’s country. Please be advised that international customers are responsible for determining the legal status of aiming lasers under the laws of their county of residence. In addition, the customer is responsible for obtaining any necessary licenses or permits needed to import laser aiming devices. If you cannot locate a dealer in your country, please contact <u>sales\@USNightVision.com</u> for assistance.<br><br>For further information on the <i>US State Department Office:</i> <i><b>Defense Trade Controls International Traffic in Arms Regulations</b></i> please visit <a href=\"http://www.pmdtc.org/reference.htm\" target=\"ITAR\" class=\"description\">http://www.pmdtc.org/reference.htm</a><br><br><br>Now if you meet our International Buyer's criteria explained above, simply call us at (800)500-4020 to order the item(s) in your cart.";
	$myContinueShopping = '<input type="submit" value="Agree to Terms & Conditions" class="submitButton">';
	$PageContent =~ s/!!ThisTitle!!/International Buyers Please Read/gi;
	$PageContent =~ s/!!ProductSubTitle!!/<b>Read Carefully<\/b>/gi;
	$PageContent =~ s/!!PageDescription!!/$pd/gi;
	$PageContent =~ s/!!PageContent!!//gi;
	$PageContent =~ s/!!FormAction!!/cart.htm/gi;
	$PageContent =~ s/!!ThyButtons!!/$myContinueShopping/gi;

}




elsif ($Todo_Form[0] =~ "-----" || $Cookies{'Shicar'} ne "") {
## ----------------->>> CART

	$cartTable = '<table width="581" border="0" cellspacing="0" cellpadding="0"><tr height="1"><td colspan="14"><img src="Night_Vision_Images/resultsTableTopper_581.jpg" width="581" height="5"></td></tr><tr bgcolor="#DEDDCC" valign="bottom"><td width="10"><img src="Night_Vision_Images/spacer.gif" width="10" height="25"></td><td width="225"><font face="Arial" size="2" color="#000000"><b>Product</b></font></td><td align="center" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td><td width="50" align="center"><font face="Arial" size="1" color="#000000">Type</font></td><td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td><td width="50" align="center"><font face="Arial" size="1" color="#000000">Class</font></td><td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td><td width="70" align="center" title="Math = Price Each ( x ) Quantity ( = ) Item Total"><font face="Arial" size="1" color="#000000" style="cursor:hand;">Price Each ($)</font></td><td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
	<td width="60" align="center" title="Math = Price Each ( x ) Quantity ( = ) Item Total"><font face="Arial" size="1" color="#000000" style="cursor:hand;">Quantity</font></td><td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td><td width="70" align="center" title="Math = Price Each ( x ) Quantity ( = ) Item Total"><font face="Arial" size="1" color="#000000" style="cursor:hand;">Item Total ($)</font></td><td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td><td width="40" align="center"><font face="Arial" size="1" color="#000000">Delete</font></td></tr><tr height="1"><td colspan="14" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td></tr>!!TheseRows!!<tr height="1"><td colspan="14"><img src="Night_Vision_Images/resultsTableBottom_581.jpg" width="581" height="14"></td></tr></table><br>!!ThyButtons!!
	<input type="hidden" name="verifyZip" value="0"><br><br><table width="500" border="0" cellspacing="0" cellpadding="0"><tr height="1"><td width="100%"><font class="description">Orders to be shipped within the US will be processed automatically and your products will be shipped out as soon immediately, so long as the product is in stock. IInternational customers will be handled by our customer service representatives directly, to true and full ensure compliance with US Arms Exports Regulations.<br><br><center><font style="color:#eb0000;font-weight:bold;">Choose a shipping destination for your order:</font><br><br><input type="radio" name="location" value="USACAN" onClick="javascript:document.forms[0].shipZip.disabled = false;"  OnKeyPress="checkInputZip(this);" checked> USA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="location" value="International" onClick="javascript:document.forms[0].shipZip.disabled = true;document.forms[0].submit();"> International<br><br>Zip Code (USA)<br><input type="text" name="shipZip" value="" OnKeyPress="checkInputZip(this);"><br><br><input type="submit" value="Continue Order/Quote Process" class="SubmitButton" style="width:250px;" onClick="document.forms[0].action=\'calculateShipping.htm\';"></center></font></td></tr></table>';
	$cartRow = '<tr height="19"><td width="10" style="border-left:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="10" height="19"></td><td><font face="Arial" size="1" color="#000000"><nobr>!!PName!!</nobr></font></td><td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td><td align="center"><font face="Arial" size="1" color="#000000"><nobr>!!Type!!</nobr></font></td><td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td><td align="center"><font face="Arial" size="1" color="#000000"><nobr>!!Class!!</nobr></font></td><td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td><td align="right" title="Math = Price Each ( x ) Quantity ( = ) Item Total"><font face="Arial" size="1" color="#000000" style="cursor:hand;">!!Price!!<img src="Night_Vision_Images/spacer.gif" width="10" height="8" border="0"></font></td><td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td><td align="center" title="Math = Price Each ( x ) Quantity ( = ) Item Total" nowrap><font face="Arial" size="1" color="#000000" style="cursor:hand;"><nobr>!!Quantity!!</nobr></font></td><td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td><td align="right" title="Math = Price Each ( x ) Quantity ( = ) Item Total" nowrap><font face="Arial" size="1" color="#000000" style="cursor:hand;">!!TPrice!!<img src="Night_Vision_Images/spacer.gif" width="10" height="8" border="0"></font></td><td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td><td align="center" nowrap style="border-right:#DEDDCC 1px solid;">!!Delete!!</td></tr><tr height="1"><td colspan="14" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td></tr>';


	
	## ----------------->>> IF COOKIE FOUND READ IT
	## ----------------->>> ReadSavedCart cookie>>DB
	if ($Cookies{'Shicar'} ne "" && $Cookies{'Shicar'} ne " ") {
		
		
		
		## ----------------->>> 	
		## ----------------->>> FIRST read saved cart
		## ----------------->>> 
		$inUID = $Cookies{'Shicar'};
		my $sth = $dbh->prepare("SELECT * FROM customerScarts WHERE UID = '$inUID'");
		$sth->execute or die "Sorry, that Username/Password combination is incorrect, please try again.\n";
		my $row = $sth->fetchrow_arrayref;
		my $cartID = $row->[0];
		my $cartContents = $row->[2];
		my $cartEA = $row->[3];
		my $cartCID = $row->[4];
		my $cartDate = $row->[5];
		
		# more than one item
		if ($cartContents =~ "!!!!!!--!!!!!!") { @myCContents = split(/!!!!!!--!!!!!!/,$cartContents); }
		# one only
		else { $myCContents[0] = $cartContents; }
		
		$cMcc = 0;
		foreach $MCC (@myCContents) {
			$FORM{$myINDEL} = "";			
			## ----------------->>> IF COMING FROM CART, CHECK FOR DEL_ && QTY_
			if ($MCC =~ " %%%%%%%%%%% ") { @allMCC = split(/ %%%%%%%%%%% /,$MCC); }
			else { $allMCC[0] = $MCC; }
			
			$dontPush = 0;

			## find QTY fields by looking at QTY_Layout = (QTY_PID_ORDERPARSED)
			foreach $AMCC (@allMCC) {
				@sAMCC = split(/ xxxxx /,$AMCC);
				$myINQTY = "QTY_" . $sAMCC[0] . "_" . $cMcc;
				$myINDEL = "DEL_" . $sAMCC[0] . "_" . $cMcc;
				if ($FORM{$myINQTY}) {
					if ($MCC =~ " %%%%%%%%%%% ") { $MCC = "$sAMCC[0] xxxxx $FORM{$myINQTY} %%%%%%%%%%% $allMCC[1]"; }
					else { $MCC = "$sAMCC[0] xxxxx $FORM{$myINQTY}"; }
					
					## dont parse if chosen to delete
					if ("@Todo_Form" =~ "$myINDEL-----on") {
						# $PageContent = $PageContent . "<script>alert('deleted');</script>";
						 $dontPush = 1;
					}

				}

			 }


			if ($dontPush eq "0") { push(@OldCartedItems,"$MCC"); }
			$cMcc++;
		}




		## ----------------->>> 
		## ----------------->>> THEN find items just added to cart (if any)
		## ----------------->>> 
		&AddToCartHTTP;

		
		## save updated cart to db for future reference by myUID
		my $sth = $dbh->prepare("UPDATE LOW_PRIORITY customerScarts 
							 SET CartContents='$myCartedItems'
							 WHERE UID='$Cookies{'Shicar'}'");
		$sth->execute or die "Unable to execute query\n"; 
		$sth->finish; 
		
		## save to db for future reference by myUID
	}
	## ----------------->>> ELSE CREATE COOKIE & DB TIE
	## ----------------->>> Create New Cart cookie>>DB
	else {

		## find items just added to cart
		&AddToCartHTTP;

		##################################################
		##>> UNIQUE ID USING IP ADDRESS + date + time
		use Data::UUID;
		require("date.nsp");
  		$IP = "$ENV{'REMOTE_ADDR'}" . "$date2" . "$time";
  		$ug    = new Data::UUID;
		$uuid = $ug->create_from_name_str(NameSpace_OID, "$IP");
		@splitUID = split(/-/,$uuid);
		$myUID = join(//,@splitUID);
		##>> UNIQUE END
		##################################################

		print "Content-type: text/html \n";
			&SetCookies('Shicar',$myUID);
		print "\n";
		

		## save to db for future reference by myUID
		my $sth = $dbh->prepare("INSERT INTO customerScarts (CartID, UID, CartContents, EA, CID, Date)
							 	 VALUES (Null, '$myUID', '$myCartedItems', '', '', Null)");
		$sth->execute or die "Unable to execute query\n";
		$sth->finish;
	}
	

	## --> Main Template START
	print $USNVMainTemplateTop;

	$pd = "Please review the list of products in your shopping cart. To delete item(s) click the checkbox next to the item you want to delete and click 'Update Cart Contents'. Once you verify your shopping cart's contents click 'Continue Order/Quote Process' to purchase or get a price quote for the listed item(s).";
	$allRows = "";

	$cTAMC = 0;


	
	$cAllItems = 0;
	foreach $theamc (@cartedItems) {
		$myExtraTabler = "";

		## --> if contains option split the item
		if ($theamc =~ "OPT_") { 
			@stamc = split(/ %%%%%%%%%%% /,$theamc);
			$amc = $stamc[0];
			$myOPTs = $stamc[1];
		}
		## --> else only product, no option
		else { $amc = $theamc; $myOPTs = ""; }


		
		## --> make sure its legit
		if ($amc =~ "xxxxx") {
			@SPLITAMC = split(/ xxxxx /, $amc);
		
			$thyPID = $SPLITAMC[0];
			$quant = $SPLITAMC[1];


			my $sth = $dbh->prepare("SELECT * FROM newProducts WHERE ProductID='$thyPID'");
			$sth->execute or die "Unable to execute query\n"; 
			my @row;
			while(@row = $sth->fetchrow_array) { 
				$SavedPartNum = $row[1];
				$SavedMFGName = $row[2];
				$SavedMFGPartNum = $row[3];
				$SavedMFGProdURL = $row[4];
				$SavedItemName = $row[5];
				$SavedDescription = $row[6];
				$SavedTechSpecs = $row[7];
				$SavedSmallPhoto = $row[8];
				$SavedLargePhoto = $row[9];
				$SavedWarranty = $row[10];
				$SavedWeight = $row[11];
				$SavedMasterDist = $row[12];
				$SavedDistributor = $row[13];
				$SavedDealer = $row[14];
				$SavedLawEnforce = $row[15];
				$SavedRetail = $row[16];
				$SavedAccessories = $row[17];
				$SavedProdUsage = $row[18];
				$SavedProductType = $row[19];
				$SavedGeneration = $row[20];
				$BrochureBulletPoints = $row[23];
				$SavedIncludedItems = $row[28];
				$SavedSpecialDiscount = $row[37];
				$SavedProductOptions = $row[38];
				if ($SavedProductOptions =~ ":::::") {
					@splitPO = split(/\n\b/,$SavedProductOptions);
					$cPOs = 1;
					foreach $PO (@splitPO) { $allSavedPOs[$cPOs] = "$PO"; $cPOs++; }
				}

			}

			


			if ($custUName =~ "@") {
				## NOW YOU KNOW
				if ($custTipo eq "MasterDist") { $lePrice = "$SavedMasterDist"; }
				elsif ($custTipo eq "Distributor") { $lePrice = "$SavedDistributor"; }
				elsif ($custTipo eq "Dealer") { $lePrice = "$SavedDealer"; }
				elsif ($custTipo eq "LawEnforce") { $lePrice = "$SavedLawEnforce"; }
				else { $lePrice = "$SavedRetail"; }
			}
			elsif ($Cookies{'Logged'} eq "SI") {
				if ($Cookies{'CT'} eq "MasterDist") { $lePrice = "$SavedMasterDist"; }		
				elsif ($Cookies{'CT'} eq "Distributor") { $lePrice = "$SavedDistributor"; }		
				elsif ($Cookies{'CT'} eq "Dealer") { $lePrice = "$SavedDealer"; }		
				elsif ($Cookies{'CT'} eq "LawEnforce") { $lePrice = "$SavedLawEnforce"; }
				else { $lePrice = "$SavedRetail"; }
			}
			else { $lePrice = "$SavedRetail"; }



			if ($SavedSpecialDiscount ne "0" && $SavedSpecialDiscount ne "" && $SavedSpecialDiscount ne "0.00") {

				$centuri = $lePrice / 100;
				$discountAmount = $centuri * $SavedSpecialDiscount;
				$newPrice = $lePrice - $discountAmount;

				$TP = $quant * $newPrice;

				$myTotal=&format_money($TP);
				$myDollar=&format_money($newPrice);

				$myTotal = "<font style=\"color:#eb0000;cursor:hand;\" title=\"Sale Priced Item\">$myTotal</font>";
				$myDollar = "<font style=\"color:#eb0000;cursor:hand;\" title=\"Sale Priced Item\">$myDollar</font>";
				$saleStyle = "style='color:#eb0000;' title='Sale Priced Option'";
			}
			else {
				$TP = $quant * $lePrice;
				$myTotal=&format_money($TP);
				$myDollar=&format_money($lePrice);
				$saleStyle = "style='color:#000000;'";
			}			
			
			

			
			
			if ($SavedProductType =~ "Accessory") { $myPT = "<span style='cursor:hand;' title='USNV Product Accessory'>ACC</span>"; $myPTSpell = "USNV Product Accessory"; }
			elsif ($SavedProductType =~ "Binocular") { $myPT = "<span style='cursor:hand;' title='Binoculars'>BIN</span>"; $myPTSpell = "Binoculars"; }
			elsif ($SavedProductType =~ "BodyArmor") { $myPT = "<span style='cursor:hand;' title='Body Armor'>ARM</span>"; $myPTSpell = "Body Armor"; }
			elsif ($SavedProductType =~ "Thermal") { $myPT = "<span style='cursor:hand;' title='Thermal/Heat Sensing'>THRM</span>"; $myPTSpell = "Thermal/Heat Sensing"; }
			elsif ($SavedProductType =~ "Digital") { $myPT = "<span style='cursor:hand;' title='Digial Device'>DIG</span>"; $myPTSpell = "Digial Device"; }
			elsif ($SavedProductType =~ "Goggle") { $myPT = "<span style='cursor:hand;' title='Goggles'>GOG</span>"; $myPTSpell = "Goggles"; }
			elsif ($SavedProductType =~ "Laser") { $myPT = "<span style='cursor:hand;' title='Laser Designator'>LAS</span>"; $myPTSpell = "Laser Designator"; }
			elsif ($SavedProductType =~ "Monocular") { $myPT = "<span style='cursor:hand;' title='Monocular'>MON</span>"; $myPTSpell = "Monocular"; }
			elsif ($SavedProductType =~ "Weapon") { $myPT = "<span style='cursor:hand;' title='Laser Designator'>Weapon Mounted Sight</span>"; $myPTSpell = "Weapon Mounted Sight"; }

			if ($SavedGeneration =~ "I") { $myClass = "<span style='cursor:hand;' title='Generation I Night Vision Tube'>G1</span>"; }
			elsif ($SavedGeneration =~ "II") { $myClass = "<span style='cursor:hand;' title='Generation II Night Vision Tube'>G2</span>"; }
			elsif ($SavedGeneration =~ "IIP") { $myClass = "<span style='cursor:hand;' title='Generation II Plus Night Vision Tube'>G2P</span>"; }
			elsif ($SavedGeneration =~ "III") { $myClass = "<span style='cursor:hand;' title='Generation III Night Vision Tube'>G3</span>"; }
			elsif ($SavedGeneration =~ "Viewer") { $myClass = "<span style='cursor:hand;' title='$myPTSpell Viewer'>DIG</span>"; }
			elsif ($SavedGeneration =~ "N/A") { $myClass = "N/A"; }
			
			
			$sth->execute or die "Unable to execute query\n"; 
			$sth->finish;
		
			$misPartes = $thyPID . "_" . $cTAMC;
			$leChecker = "<input type=\"checkbox\" name=\"DEL_$misPartes\" title=\"Check this box and click 'Update Cart Contents' to remove this item from your cart.\" style=\"cursor:hand;\">";
			$ProductName = "<a href=\"Night_Vision_Products.htm?PID=$thyPID\"><font face=\"Arial\" size=\"1\" color=\"#000000\">$SavedItemName</font></a>";
			$myQuantity = "<input type=\"text\" name=\"QTY_$misPartes\" value=\"$quant\" class=\"quantInput\" OnKeyPress=\"checkInputQty(this);\">";
		
			$thisRowItem = $cartRow;
			$thisRowItem =~ s/!!PName!!/$ProductName/gi;
			$thisRowItem =~ s/!!Type!!/$myPT/gi;
			$thisRowItem =~ s/!!Class!!/$myClass/gi;
			$thisRowItem =~ s/!!Price!!/$myDollar/gi;
			$thisRowItem =~ s/!!Quantity!!/$myQuantity/gi;		
			$thisRowItem =~ s/!!TPrice!!/$myTotal/gi;
			$thisRowItem =~ s/!!Delete!!/$leChecker/gi;


			#################################
			#### product options inserts ####
			#################################
			if ($myOPTs =~ "OPT_") {

				## --> more than one option chosen
				if ($myOPTs =~ " %%%%% ") { @allOPTs = split(/ %%%%% /,$myOPTs); }
				## --> only one option chosen
				else { $allOPTs[0] = $myOPTs; }
				
				foreach $aOPTs (@allOPTs) {
				
					$aOPTs =~ s/OPT_//gi;
					@splitAOPTS = split(/:::::/,$allSavedPOs[$aOPTs]);
					
					$mydollar = $splitAOPTS[1];
					$mydollar =~ s/,//gi;
					$tpOPT = $quant * $mydollar;
					$MD=&format_money($tpOPT);

					# $myExtraTabler = $myExtraTabler . "<script>alert('$quant');</script>";
				
					$myExtraTabler = $myExtraTabler . '

						<tr height="19">
							<td width="10" style="border-left:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="10" height="19"></td>
							<td title="Option for ' . $SavedItemName . ' ( ' . $splitAOPTS[0] . ' )"><font face="Arial" size="1" color="#000000"><nobr><font face="Arial" size="1" color="#000000"> - <i>' . $splitAOPTS[0] . '</i></font></nobr></font></td>
							<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
							<td align="center"><font face="Arial" size="1" color="#000000"><nobr><i>OPT</i></nobr></font></td>
							<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
							<td align="center"><font face="Arial" size="1" color="#000000"><nobr><i>N/A</i></nobr></font></td>
							<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
							<td align="right"><font face="Arial" size="1" color="#000000" ' . $saleStyle . '><i>' . $mydollar . '</i><img src="Night_Vision_Images/spacer.gif" width="10" height="8" border="0"></font></td>
							<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
							<td align="center" style="cursor:hand;" title="Same quantity as parent" nowrap><font face="Arial" size="1" color="#000000"><i>' . $quant . '</i></font></td>
							<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
							<td align="right" nowrap><font face="Arial" size="1" color="#000000" ' . $saleStyle . '><i>' . $MD . '</i><img src="Night_Vision_Images/spacer.gif" width="10" height="8" border="0"></font></td>
							<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
							<td align="center" style="border-right:#DEDDCC 1px solid;cursor:hand;" title="Controlled by Parent Product" nowrap><font face="Arial" size="1" color="#000000"><nobr><i>-</i></nobr></font></td>
						</tr>
						<tr height="1"><td colspan="14" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td></tr>
						';
	

	

				}
			}

		
			$allRows = $allRows . $thisRowItem . $myExtraTabler;
			
			## (counting ITEMS in CART) NOT ADDING options to the total cart count
			$cAllItems = int($cAllItems + $quant);

		}
		$cTAMC++;
		

	}
	
	
	$myCT = $cartTable;
	$myCT =~ s/!!TheseRows!!/$allRows/gi;
	
	
	
	
	
	
	
	$myButtons = '<input type="button" value="Continue Shopping" class="Button" onClick="document.location.href=\'US_Night_Vision_Inventory_Pricesheet.htm\';"> &nbsp; <input type="button" value="Update Cart Contents" class="Button" onClick="document.forms[0].action=\'cart.htm\'; document.forms[0].submit();"> &nbsp; <input type="button" value="Empty Cart" class="Button" onClick="document.location.href=\'cart.htm?EMPTY=1\';">';
	$PageContent =~ s/!!ThisTitle!!/Shopping Cart Contents/gi;
	$PageContent =~ s/!!ProductSubTitle!!/<b>$cAllItems Items in Your Cart<\/b>/gi;
	$PageContent =~ s/!!PageDescription!!/$pd/gi;
	$PageContent =~ s/!!PageContent!!/$myCT/gi;
	$PageContent =~ s/!!FormAction!!/cart.htm/gi;
	$PageContent =~ s/!!ThyButtons!!/$myButtons/gi;	
	
	
}





## --> 
## --> if no incoming vars (and no items in cart)
## --> 

elsif (@cartedItems <= 0) {
	print "Content-type: text/html \n\n";

	## --> Main Template START
	print $USNVMainTemplateTop;

	$pd = "Your shopping cart is completely empty at this time. If you have any problems with our shopping cart system or online store please feel free to give our customer service representatives a call at your earliest convenience. We hope you enjoy our website as much as we know you will enjoy our products.";
	$myContinueShopping = '<input type="submit" value="Continue Shopping" class="submitButton">';
	$PageContent =~ s/!!ThisTitle!!/Shopping Cart Contents/gi;
	$PageContent =~ s/!!ProductSubTitle!!/<b>Shopping Cart is Empty<\/b>/gi;
	$PageContent =~ s/!!PageDescription!!/$pd/gi;
	$PageContent =~ s/!!PageContent!!//gi;
	$PageContent =~ s/!!FormAction!!/US_Night_Vision_Inventory_Pricesheet.htm/gi;
	$PageContent =~ s/!!ThyButtons!!/$myContinueShopping/gi;	
	
	
	
}





	
print qq~
$feedback
				<table width="100%" cellpadding="0" cellspacing="0" border="0">
					<tr>
						<td><img src="Night_Vision_Images/spacer.gif" border="0" width="1" height="1"></td>
					</tr>
$myTopBanner


				</table>

			<!--STARTMainLayoutTable-->
				<table width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="#FFFFFF">
					<tr>
						<td width="175" height="2"><img src="Night_Vision_Images/spacer.gif" border="0" width="175" height="2"></td>
						<td width="1" height="2" background="Night_Vision_Images/verticalDottie.gif"><img src="Night_Vision_Images/spacer.gif" border="0" width="1" height="2"></td>
						<td width="100%" height="2"><img src="Night_Vision_Images/spacer.gif" border="0" width="1" height="2"></td>
					</tr>

					<tr>

						<!--STARTLeftMenu-->
						<td width="175" valign="top">
							$leftMenu
						</td>
						<!--ENDLeftMenu-->

						<!--STARTMenu/ContentDivider-->
						<td width="1" background="Night_Vision_Images/verticalDottie.gif"><img src="Night_Vision_Images/spacer.gif" border="0" width="1" height="20"></td>
						<!--ENDMenu/ContentDivider-->

						<!--STARTMainContentArea-->
						<td width="100%" valign="top">

							$PageContent
							
						</td>
						<!--ENDMainContentArea-->

					</tr>


				</table>
			<!--ENDMainLayoutTable-->


~;	
	
	
	
## print out main template BOT from templateMaster.nsp
print $USNVMainTemplateBot;

$dbh->disconnect;




sub AddToCartHTTP {

	## -- > 
	## -- > find to see if coming from cart by scanning form vars
	## -- > 
	foreach $TF (@Todo_Form) {
		if ($TF =~ "QTY_") {
			@splitTQ = split(/-----/,$TF);
			$comingFromCart = 1;
		}
	}

	### -->
	## -- > NOT COMING FROM CART
	if ($Todo_Form[0] =~ "-----" && $comingFromCart ne "1") {
		$mCC = 0;
		$foundInCart = 0;

    	foreach $pares (@Todo_Form) {

			$nextOne = $Todo_Form[int($mCC+1)];
			$lastOne = $Todo_Form[int($mCC-1)];
			
			@splitFields = split(/-----/,$pares);

			if ($nextOne =~ "OPT_") { $hasOption = 1; }
			else { $hasOption = 0; }
			

			### -->
			### --> READ INCOMING FORM for Main Product Selection
			if ($splitFields[0] =~ "PID") {
				$PID = "$splitFields[1]";
				$CI = "$PID xxxxx 1";
				## for checking cart
				$CI1 = "$PID xxxxx ";
			}
			
			### -->
			### --> READ INCOMING FORM for Product Options
			if ($splitFields[0] =~ "OPT_") {
				@optionParts = split(/:::::/,$splitFields[1]);
				$CI = $CI . " %%%%%%%%%%% " . "$splitFields[0]";
				## for checking cart
				$CI2 = "$splitFields[0]";
			}

			
			### -->
			### --> FIND COOKIE/DB IDENTICALS (ALREADY CARTED) 
			### --> from FORM INPUT PRODUCTS (BEING ADDED)
			### --> 
			if (@OldCartedItems && $Cookies{'Shicar'} && $foundInCart eq "0") {
				$estaCuenta = "1";
				$cUCI = 0;
				$oldCta = 0;	
				foreach $unCI (@OldCartedItems) {
					@splitUCI = split(/ %%%%%%%%%%% /,$unCI);
					@splitMAINUCI = split(/ xxxxx /,$splitUCI[0]);

				 	if ($CI =~ " %%%%%%%%%%% ") {
						if ($unCI =~ "$CI1" && $splitUCI[1] eq "$CI2") {
							$oldCta = $splitMAINUCI[1];
							$nCI = int($oldCta + 1);
							$OldCartedItems[$cUCI] = "$splitMAINUCI[0] xxxxx $nCI %%%%%%%%%%% $splitUCI[1]";

							### --> make sure not to add to cart below if already found this exact 
							### --> product in COOKIE/DB and added one to it to count up
							$foundInCart = 1;
						}
					}
				 	elsif ($CI =~ "$CI1" && !$CI =~ "$CI2") {
						$oldCta = $splitMAINUCI[1];
						$nCI = int($oldCta + 1);
						$OldCartedItems[$cUCI] = "$splitMAINUCI[0] xxxxx $nCI";

						### --> make sure not to add to cart below if already found this exact 
						### --> product in COOKIE/DB and added one to it to count up
						$foundInCart = 1;
					}					
					$cUCI++;
				}
			}

			$mCC++;
			
			
			### -->
			### --> ATTACH NEW FOUND Product & Options to CartedItems (if not already found in COOKIE/DB)
			### -->
			if ($foundInCart eq "0" && $hasOption eq "0") { 

				push(@cartedItems,"$CI"); 
				$CI = "";
			}



		}

		
		
		

	}





		$CCIONE = 0;
		foreach $thisCCI (@cartedItems) {
			if ($myCartedItems =~ "$thisCCI") { }
			else {
				if ($CCIONE eq "0") { $myCartedItems = "$thisCCI"; }
				else { $myCartedItems = $myCartedItems . "!!!!!!--!!!!!!" . "$thisCCI"; }
			}

			$CCIONE++;
		}

		foreach $thisCCI (@OldCartedItems) {
			if ($myCartedItems =~ "$thisCCI") { }
			else {
				if ($CCIONE eq "0") { $myCartedItems = "$thisCCI"; }
				else { $myCartedItems = $myCartedItems . "!!!!!!--!!!!!!" . "$thisCCI"; }
				push(@cartedItems,"$thisCCI");
			}
			$CCIONE++;
		}






}



exit;