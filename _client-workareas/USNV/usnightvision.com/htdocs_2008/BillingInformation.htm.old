#!/usr/bin/perl5 -w

###########################################################################################################
# Company: ©2001 NetMedia Solutions                                                                       #
# Date: Saturday, September 21, 2001                                                                      #
# Location: Los Angeles County, California, United States of America                                      #
# Made By: Luis Rodriguez (drlouie)                                                                       #
# Email: Drlouie@NetMediaSol.com                                                                          #
#                                                                                                         #
# This program cannot be duplicated, distributed or re-used for any other purpose other than its original #
# intended purpose and function. You may request NetMedia Solutions for a copy of the script,             #
# personalized to fit your exact needs for a small re-programming fee.                                    #
###########################################################################################################

## --> Make sure all request coming from this server's domain or IP
require "referer.nsp";

## --> Snif cookie, if present test for logged in status
require ("cookiesnif.nsp");

## --> Parse Request Query
require ("parse_query.nsp");

## --> USNVSiteTemplates
require "templateMaster.nsp";

$showCartPreview = 0;

## --> Left Menu Inclusion
require ("leftMenu.nsp");

require ("date.nsp");

#- --> SET HARD PARAM
$ct = '9';


	#-- CONNECT TO DB (GET PAGE CONTENT)
	use DBI;
	my $dbh = DBI->connect("DBI:mysql:unvWeb","root","19nv8n6uilPoA") or die "Unable to connect to database: <b>unvWeb</b>\n"; 
	$dbh->{RaiseError} = 1; 

		my $sth = $dbh->prepare("SELECT * FROM WebsiteContent where ContentID = '$ct';");
		$sth->execute or die "Unable to execute query\n"; 
		my @row;
		while(@row = $sth->fetchrow_array) { 
			$PageContent = $row[1];
			$PageHeader = $row[2];
			$PCount++;
		}
	$sth->execute or die "Unable to execute query\n"; 
	$sth->finish;

if ($Cookies{'Shicar'} ne "") {

$countInput = 0;	
	
		$validCityState = 0;
		if ($FORM{'shipZip'}) {

			use Text::Beautify;

			$LCount=0;
			$myZip = "$FORM{'shipZip'}";
			my $sth = $dbh->prepare("SELECT * FROM USCensusZip1999 where ZIP_CODE = '$myZip';");
			$sth->execute or die "Unable to execute query\n"; 
			my @row;
			while(@row = $sth->fetchrow_array) {
				$CITYNAME = lc($row[4]);
				@splitCity = split(/ /,$CITYNAME);
				$CSC=0;
				foreach $SC (@splitCity) {
					my $text1 = Text::Beautify->new($SC);
					my $CleanCity = $text1->beautify;
					if ($CSC eq "0") { $splitCity[$CSC] = "$CleanCity"; }
					else { $splitCity[$CSC] = " $CleanCity"; }
					$CSC++;
				}

				
				$STATEID = $row[5];
				push(@Cities,"@splitCity");
				push(@StateIDs,"$STATEID");
				$LCount++;
			}
			$sth->execute or die "Unable to execute query\n"; 
			$sth->finish;
			
			foreach $SID (@StateIDs) {
				my $sth = $dbh->prepare("SELECT * FROM States where StateID = '$SID';");
				$sth->execute or die "Unable to execute query\n"; 
				my @row;
				while(@row = $sth->fetchrow_array) {
					$StateName = $row[1];
					$StateABV = $row[2];
					push(@States,"$StateABV,$StateName");
					$LCount++;
				}
				$sth->execute or die "Unable to execute query\n"; 
				$sth->finish;
			}

			$CL = 0;
			foreach $CEE (@Cities) {
				## set valid state to yes
				$validCityState = 1;
				if ($CL eq "0") { $thyShipCity = "$CEE"; }
				$CL++;
			}
			
			$thyShipCity =~ s/  / /gi;
			
		}	

$myCartContent = "";


	$cartTable = '
		<table width="581" border="0" cellspacing="0" cellpadding="0">
			<tr height="1"><td colspan="12"><img src="Night_Vision_Images/resultsTableTopper_581.jpg" width="581" height="5"></td></tr>
			<tr height="1"><td colspan="12" align="center" style="border-left:#DEDDCC 1px solid;border-right:#DEDDCC 1px solid;padding-bottom:4px;"><font style="line-height:18px;font-size:11px;" face="Verdana" color="#000000"><b>Item(s) You\'re Ordering</b></td></tr>
			<tr bgcolor="#DEDDCC" valign="bottom">
				<td width="10"><img src="Night_Vision_Images/spacer.gif" width="10" height="25"></td>
				<td width="225"><font face="Arial" size="2" color="#000000"><b>Product</b></font></td>
				<td align="center" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
				<td width="40" align="center"><font face="Arial" size="1" color="#000000">Type</font></td>
				<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
				<td width="40" align="center"><font face="Arial" size="1" color="#000000">Class</font></td>
				<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
				<td width="50" align="center"><font face="Arial" size="1" color="#000000">Quantity</font></td>
				<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
				<td width="70" align="center"><font face="Arial" size="1" color="#000000">Weight (lbs)</font></td>
				<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
				<td width="100" align="center"><font face="Arial" size="1" color="#000000">Total Price ($)</font></td>
			</tr>
			<tr height="1"><td colspan="12" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td></tr>
			!!TheseRows!!
			<tr height="1"><td colspan="12"><img src="Night_Vision_Images/resultsTableBottom_581.jpg" width="581" height="14"></td></tr>
			</table>';
	$cartRow = '
		<tr height="19">
			<td width="10" style="border-left:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="10" height="19"></td>
			<td><font face="Arial" size="1" color="#000000"><nobr>!!PName!!</nobr></font></td>
			<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
			<td align="center"><font face="Arial" size="1" color="#000000"><nobr>!!Type!!</nobr></font></td>
			<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
			<td align="center"><font face="Arial" size="1" color="#000000"><nobr>!!Class!!</nobr></font></td>
			<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
			<td align="center"><font face="Arial" size="1" color="#000000">!!Quantity!!</font></td>
			<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
			<td align="left" style="padding-left:20px;" nowrap><font face="Arial" size="1" color="#000000">!!Weight!!</font></td>
			<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
			<td align="right" style="border-right:#DEDDCC 1px solid;" nowrap><font face="Arial" size="1" color="#000000"><nobr>!!TPrice!!<img src="Night_Vision_Images/spacer.gif" width="25" height="8" border="0"></nobr></font></td>
		</tr>
		<tr height="1"><td colspan="12" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td></tr>';


	## -->
	## --> Run Cookie reader for updates/deletions/quantity
	## -->

	#############################
	#### FIRST READ THE CART ####
	#############################
		## ----------------->>> 	
		## ----------------->>> FIRST read saved cart
		## ----------------->>> 
		$inUID = $Cookies{'Shicar'};
		my $sth = $dbh->prepare("SELECT * FROM customerScarts WHERE UID = '$inUID'");
		$sth->execute or die "Sorry, that Username/Password combination is incorrect, please try again.\n";
		my $row = $sth->fetchrow_arrayref;
		my $cartID = $row->[0];
		my $cartContents = $row->[2];
		my $cartEA = $row->[3];
		my $cartCID = $row->[4];
		my $cartDate = $row->[5];
		
		# more than one item
		if ($cartContents =~ "!!!!!!--!!!!!!") { @myCContents = split(/!!!!!!--!!!!!!/,$cartContents); }
		# one only
		else { $myCContents[0] = $cartContents; }
		
		$cMcc = 0;
		foreach $MCC (@myCContents) {
			$FORM{$myINDEL} = "";			
			## ----------------->>> IF COMING FROM CART, CHECK FOR DEL_ && QTY_
			if ($MCC =~ " %%%%%%%%%%% ") { @allMCC = split(/ %%%%%%%%%%% /,$MCC); }
			else { $allMCC[0] = $MCC; }
			
			$dontPush = 0;

			## find QTY fields by looking at QTY_Layout = (QTY_PID_ORDERPARSED)
			foreach $AMCC (@allMCC) {
				@sAMCC = split(/ xxxxx /,$AMCC);
				$myINQTY = "QTY_" . $sAMCC[0] . "_" . $cMcc;
				$myINDEL = "DEL_" . $sAMCC[0] . "_" . $cMcc;
				if ($FORM{$myINQTY}) {
					if ($MCC =~ " %%%%%%%%%%% ") { $MCC = "$sAMCC[0] xxxxx $FORM{$myINQTY} %%%%%%%%%%% $allMCC[1]"; }
					else { $MCC = "$sAMCC[0] xxxxx $FORM{$myINQTY}"; }
					
					
					## dont parse if chosen to delete
					if ($FORM{$myINDEL} eq "on") {
						# $cartTable = $cartTable . "<script>alert('$FORM{$myINDEL}');</script>";
						$dontPush = 1;
					}

				}

			 }


			if ($dontPush eq "0") { push(@cartedItems,"$MCC"); }
			$cMcc++;
		}


	


	
	
	
	




## --->>> IF PACKAGE CHOSEN (Order or Quote Selection)
if ($FORM{'Package'} && $Cookies{'Shicar'} ne "") {


## !!MUST FINISH!! ##
## PURCHASE ORDER SYSTEM -> USNV ADDS NUMBERS THAT CUST CAN TYPE AND USE AS THEIR REFERENCE/ORDER NUMBER/QUOTE ID AND PURCHASE
$purchaseOrder = $FORM{'PurchOrd'};


$shipZip = $FORM{'shipZip'};
$thyPT = $FORM{'PayType'};
$thyAddress2 = $FORM{'Address2'};
$thyShipAddress2 = $FORM{'Address2'};
$thyShipState = $FORM{'ShipState'};
$thyState = $FORM{'State'};
$thyCompanyName = $FORM{'CompanyName'};







$countProblems = 0;


if ($FORM{'RC'} eq "1") {
$countInput++;

	$ShipProblems = "";
	## -- >> EMAIL CHECKER/USER CHECKER (START)
	if ($FORM{'Email'} ne "" && $FORM{'Email'} ne " ") {
		$Email = $FORM{'Email'};
		$countThis=0;
		## Start User Account Check, make sure no dupes are made
		my $sth = $dbh->prepare("SELECT * FROM Customers");
		$sth->execute or die "Unable to execute query\n"; 
		my @row;
		while(@row = $sth->fetchrow_array) { 
			$cualCT = $row[3];
			my $SavedEmail = $row[15];
			my $SavedUsername = $row[16];
			
			## ------------->>> IF EXISTS DIE
			if (($SavedEmail eq "$Email") || ($SavedUsername eq "$Email")) {
				$countThis++;
			}
		}
		$sth->finish;


		if ($countThis eq "0") { 
			if ($FORM{'Email'} =~ "@") { $EmailCheck = "EmailgoodOne();"; }
			else { 
				$EmailCheck = "BadEmailAddress();"; 
				$HighEmail = "style=\"color:#eb0000\""; 
				$ShipProblems = $ShipProblems . "<br> - Email Address is invalid, must contain <i>@</i> symbol";
				$countProblems++;
			}
		}
		else { 
			$EmailCheck = "EmailinUse();"; 
			$HighEmail = "style=\"color:#eb0000\""; 
			$ShipProblems = $ShipProblems . "<br> - Email Address already in-use by another user in our system";
			$countProblems++;
		}
	}
	else { 
		$EmailCheck = "BadEmailAddress();"; 
		$HighEmail = "style=\"color:#eb0000\""; 
		$ShipProblems = $ShipProblems . "<br> - Email Address is missing or incorrect";
		$countProblems++;
	}
	$thyEmail = $FORM{'Email'}; 
	## -- >> EMAIL CHECKER/USER CHECKER (END)



	$PayProblems = "";
	## -- >> CC CHECKER (START)
	if ($FORM{'PayType'} =~ "CC") {
		$countInput++;
		$thySeaSeaT = $FORM{'SeaSeaT'};
		$thySeaSeaN = $FORM{'SeaSeaN'};
		$thySeaSeaEX = $FORM{'SeaSeaEX'};
		$thySeaSeaSC = $FORM{'SeaSeaSC'};
		$FORM{'cardholder'} = "f";
		
		if ($FORM{'SeaSeaT'} ne "" && $FORM{'SeaSeaT'} ne " ") {
			$FORM{'cardtype'} = "$FORM{'SeaSeaT'}";
			if ($FORM{'SeaSeaN'} ne "" && $FORM{'SeaSeaN'} ne " ") {
				$FORM{'cardnumber'} = "$FORM{'SeaSeaN'}";
				if ($FORM{'SeaSeaEX'} ne "" && $FORM{'SeaSeaEX'} ne " ") { 
					$FORM{'cardexp'} = "$FORM{'SeaSeaEX'}"; 
					&expireCheck;
				}
				else {
					&missingExpiration;
				}

				### SECURITYCODE
				if ($FORM{'SeaSeaSC'} ne "" && $FORM{'SeaSeaSC'} ne " ") { 
					$FORM{'securecode'} = "$FORM{'SeaSeaSC'}"; 
					if ($FORM{'cardtype'} eq "amex") { &secure4; }
					else { &secure3; }
				}
				else {
					&missingSecurityCode;
				}

			}
			else {
				$CCCheck = "CCdataMissing()"; 
				$HighCCN = "style=\"color:#eb0000\""; 
				$PayProblems = $PayProblems . "<br> - Credit Card Number is missing";
				$countProblems++;
			}
		}
		else { 
			$CCCheck = "CCdataMissing()"; 
			$HighCCT = "style=\"color:#eb0000\""; 
			$PayProblems = $PayProblems . "<br> - Credit Card Type is not Selected";
			$countProblems++;
		}
	
		### made sure they were at least filled in a little, now process
		require("ccv.nsp");
		&CC_Verify;
	
	}
	elsif ($FORM{'PayType'} eq "CHOOSEONE" || $FORM{'PayType'} eq "" || $FORM{'PayType'} eq " ") {
		$CCCheck = "PaymentTypeNotChosen()";
		$HighPT = "style=\"color:#eb0000\"";
		$PayProblems = $PayProblems . "<br> - You did not select a Payment Method";
		$countProblems++;
	}
	## -- >> CC CHECKER (END)

if ($PayProblems ne "") {
	$PayProblems = "<table cellpadding='0' cellspacing='0' border='0' style='margin-bottom:5px;'><tr><td background='Night_Vision_Images/horizontalDottie.gif'><img src='Night_Vision_Images/spacer.gif' width='1' height='1'></td></tr><tr><td align='left'><font style='font-size:9px;' face='Verdana' color='#EB0000'>" . $PayProblems . "</font></td></tr><tr><td height='10'><img src='Night_Vision_Images/spacer.gif' width='1' height='12'></td></tr><tr><td height='1' background='Night_Vision_Images/horizontalDottie.gif'><img src='Night_Vision_Images/spacer.gif' width='1' height='1'></td></tr></table>";
}




	
$thyShipFName = $FORM{'ShipFName'};
@splitSFN = split(//, $thyShipFName);
if (@splitSFN <= 1 && $thyShipFName ne " ") { 
	$HighSFN = "style=\"color:#eb0000\""; 
	$ShipProblems = $ShipProblems . "<br> - First Name is invalid or not filled in";
	$countProblems++;
}

$thyShipLName = $FORM{'ShipLName'};
@splitSLN = split(//, $thyShipLName);
if (@splitSLN <= 1 && $thyShipLName ne " ") { 
	$HighSLN = "style=\"color:#eb0000\""; 
	$ShipProblems = $ShipProblems . "<br> - Last Name is invalid or not filled in";
	$countProblems++;
}

$thyShipTNum = $FORM{'ShipTNum'};
$thyShipTArea = $FORM{'ShipTArea'};
@splitSTN = split(//, $thyShipTNum);
@splitSTA = split(//, $thyShipTArea);
if (@splitSTN != 7 || @splitSTA != 3) { 
	$HighST = "style=\"color:#eb0000\"";
	$ShipProblems = $ShipProblems . "<br> - Telephone Number and/or Area Code is invalid or not filled in";
	$countProblems++;
}	

$thyShipAddress1 = $FORM{'ShipAddress1'};
@splitSA1 = split(//, $thyShipAddress1);
if (@splitSA1 <= 8) { 
	$HighSA1 = "style=\"color:#eb0000\""; 
	$ShipProblems = $ShipProblems . "<br> - Address is invalid or not filled in";
	$countProblems++;
}

### if city not found in list of cities (derrived from zip)
if ($validCityState eq "0") {
	$thyShipCity = $FORM{'ShipCity'};
	@splitSC = split(//, $thyShipCity);
	if (@splitSC <= 3) { 
		$HighSC = "style=\"color:#eb0000\""; 
		$ShipProblems = $ShipProblems . "<br> - City is invalid or not filled in";
		$countProblems++;
	}
}


if ($ShipProblems ne "") {
	$ShipProblems = "<table cellpadding='0' cellspacing='0' border='0' style='margin-bottom:5px;'><tr><td background='Night_Vision_Images/horizontalDottie.gif'><img src='Night_Vision_Images/spacer.gif' width='1' height='1'></td></tr><tr><td align='left'><font style='font-size:9px;' face='Verdana' color='#EB0000'>" . $ShipProblems . "</font></td></tr><tr><td height='10'><img src='Night_Vision_Images/spacer.gif' width='1' height='12'></td></tr><tr><td height='1' background='Night_Vision_Images/horizontalDottie.gif'><img src='Night_Vision_Images/spacer.gif' width='1' height='1'></td></tr></table>";
}
else {
	$ShipProblems = "<font style='font-size:9px;' face='Verdana' color='#000000'>(&sect;) Military can use AP, AE or AA in \"2nd Address Field\"</font>";
}







$BillProblems = "";
$thyFName = $FORM{'FName'};
@splitFN = split(//, $thyFName);
if (@splitFN <= 1 && $thyFName ne " ") { 
	$HighFN = "style=\"color:#eb0000\""; 
	$BillProblems = $BillProblems . "<br> - First Name is invalid or not filled in";
	$countProblems++;
}

$thyLName = $FORM{'LName'};
@splitLN = split(//, $thyLName);
if (@splitLN <= 1 && $thyLName ne " ") { 
	$HighLN = "style=\"color:#eb0000\""; 
	$BillProblems = $BillProblems . "<br> - Last Name is invalid or not filled in";
	$countProblems++;
}

$thyAddress1 = $FORM{'Address1'};
@splitA1 = split(//, $thyAddress1);
if (@splitA1 <= 8) { 
	$HighA1 = "style=\"color:#eb0000\""; 
	$BillProblems = $BillProblems . "<br> - Address is invalid or not filled in";
	$countProblems++;
}

$thyCity = $FORM{'City'};
@splitC = split(//, $thyCity);
if (@splitC <= 3) { 
	$HighC = "style=\"color:#eb0000\""; 
	$BillProblems = $BillProblems . "<br> - City is invalid or not filled in";
	$countProblems++;
}

$thyZip = $FORM{'Zip'};
@splitZ = split(//, $thyZip);
if (@splitZ != 5) { 
	$HighZ = "style=\"color:#eb0000\""; 
	$BillProblems = $BillProblems . "<br> - Zip/Postal Code is invalid or not filled in";
	$countProblems++;
}


if ($BillProblems ne "") {
	$BillProblems = "<table cellpadding='0' cellspacing='0' border='0' style='margin-bottom:5px;'><tr><td background='Night_Vision_Images/horizontalDottie.gif'><img src='Night_Vision_Images/spacer.gif' width='1' height='1'></td></tr><tr><td align='left'><font style='font-size:9px;' face='Verdana' color='#EB0000'>" . $BillProblems . "</font></td></tr><tr><td height='10'><img src='Night_Vision_Images/spacer.gif' width='1' height='12'></td></tr><tr><td height='1' background='Night_Vision_Images/horizontalDottie.gif'><img src='Night_Vision_Images/spacer.gif' width='1' height='1'></td></tr></table>";
}
else {
	$BillProblems = "<font style='font-size:9px;' face='Verdana' color='#000000'>( as it appears on your credit card statement )</font>";
}


$PassProblems = "";
$thyPass = $FORM{'Pass'};
$thyPass2 = $FORM{'Pass2'};
if ($thyPass ne $thyPass2) {
	$HighP = "style=\"color:#eb0000\"";
	$HighP2 = "style=\"color:#eb0000\"";
	$PassProblems = $PassProblems . "<br> - Password and Confirm Password do not match";
	$countProblems++;
}
else {
	@splitP = split(//, $thyPass);
	if (@splitP <= 7) { 
		$HighP = "style=\"color:#eb0000\""; 
		$PassProblems = $PassProblems . "<br> - Password must be at least 8 digits in length";
		$countProblems++;
	}
	@splitP2 = split(//, $thyPass2);
	if (@splitP2 <= 7) { 
		$HighP2 = "style=\"color:#eb0000\""; 
	}
}


if ($PassProblems ne "") {
	$PassProblems = "<br><table cellpadding='0' cellspacing='0' border='0' style='margin-bottom:5px;'><tr><td background='Night_Vision_Images/horizontalDottie.gif'><img src='Night_Vision_Images/spacer.gif' width='1' height='1'></td></tr><tr><td align='left'><font style='font-size:9px;' face='Verdana' color='#EB0000'>" . $PassProblems . "</font></td></tr><tr><td height='10'><img src='Night_Vision_Images/spacer.gif' width='1' height='12'></td></tr><tr><td height='1' background='Night_Vision_Images/horizontalDottie.gif'><img src='Night_Vision_Images/spacer.gif' width='1' height='1'></td></tr></table>";
}



}

$writeShipZip = '<a href="javascript:document.location.href=\'cart.htm?verifyZip=1&shipZip=Enter New ZIP\';" title="To change this ZIP CODE we must re-calculate shipping costs to the new zip you supply. To change this ZIP CODE click here now. (IF YOU DO THIS NOW ALL INFORMATION INPUT ON THIS FORM WILL BE LOST!)" tabindex="13"><font color="#999999" face="verdana" size="1">' . $myZip . '</font></a>';

$writeUsername = 'Username is your E-mail';

if ($FORM{'YesToSame'} eq "on") { $thyCheck = " checked"; }
else { $thyCheck = ""; }

if ($countProblems ne "0" || !$FORM{'RC'}) { 
	$cualInput = "text";
	$cualPassword = "password";
	$cualCheckbox = "onClick=\"javascript:sameAsShipping(this.checked);\" $thyCheck";
	$asteriskMarker = "";
	$redAsterisksMark = '<font style="font-size:12px;" face="Verdana" color="#000000">( <font color="#eb0000"><i><b>RED Text Marks Problem Field(s)</b></i></font> )<br><br></font></font>';
	$showCCT = "style=\"visibility:hidden;\"";
	$showCCN = "style=\"visibility:hidden;\"";
	$showCCEX = "style=\"visibility:hidden;\"";
	$showCCSC = "style=\"visibility:hidden;\"";
	$showCCTT = "style=\"visibility:hidden;\"";
	$showCCNT = "style=\"visibility:hidden;\"";
	$showCCEXT = "style=\"visibility:hidden;\"";
	$showCCSCT = "style=\"visibility:hidden;\"";

}
else {
	$cualInput = "text\" readonly "; 
	$cualPassword = "password\" readonly ";
	$cualCheckbox = "disabled $thyCheck";
	$asteriskMarker = "";
	$ShipProblems = "";
	$BillProblems = "";
	$writeUsername = "$FORM{'Email'}";
	if ($FORM{'PayType'} =~ "CC") {
		$showPT = "style=\"visibility:visible;\"";
		$showCCT = "style=\"visibility:visible;\"";
		$showCCN = "style=\"visibility:visible;\"";
		$showCCEX = "style=\"visibility:visible;\"";
		$showCCSC = "style=\"visibility:visible;\"";
		$showCCTT = "style=\"visibility:visible;\"";
		$showCCNT = "style=\"visibility:visible;\"";
		$showCCEXT = "style=\"visibility:visible;\"";
		$showCCSCT = "style=\"visibility:visible;\"";

	}
	$disableSelect = "disabled";

}












$myTables = '

<script language="Javascript" src="NightVisionScripts/popwindow.js"></script>
<style ="text/css">
.commonSmallB { font-size:11px;font-family:verdana,arial,helvetica;color:#333333;line-height:10px;font-weight:bold; }
.commonSmall { font-size:11px;font-family:verdana,arial,helvetica;color:#333333; }
.commonSmallest { font-size:9px;font-family:verdana,arial,helvetica;color:#333333;}
.commonMediumB { font-size:11px;font-family:verdana,arial,helvetica;color:#333333;line-height:10px;font-weight:bold; }
.commonInput { color:#000000; height:20px; font-size: 10px; font-family:verdana,arial,helvetica; padding: 3px; }
select { color:#000000; height:20px; font-size: 11px; font-family:verdana,arial,helvetica; padding: 3px; }
radio { height:20px; font-size: 11px; font-family:verdana,arial,helvetica; padding: 3px; }

</style>


<input type="hidden" name="shipZip" value="' . $shipZip . '">
<input type="hidden" name="Package" value="' . $FORM{'Package'} . '">
<input type="hidden" name="RC" value="1">
' . $redAsterisksMark . '
		<table width="504" border="0" cellspacing="0" cellpadding="0">
          <tr height="5">
            <td colspan="3"><img src="Night_Vision_Images/orderQuoteFormTopper.jpg" width="504" height="5"></td>
          </tr>
          <tr>
            <td  colspan="3" align="center" style="border-left:#DEDDCC 1px solid;border-right:#DEDDCC 1px solid;padding-bottom:4px;"><font style="line-height:18px;font-size:11px;" face="Verdana" color="#000000"><b>Shipping Information</b><br>
                  <font style="font-size:9px;">' . $ShipProblems . '</font></font></td>
          </tr>
          <tr height="1">
            <td bgcolor="#DEDDCC" colspan="3"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr height="1">
            <td bgcolor="#FFFFFF" colspan="3"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr>
            <td bgcolor="#ffffff" style="border-left:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
            <td bgcolor="#DEDDCC" width="502" align="center">
      ' . $PayTipo . '
        <table width="100%" cellpadding="0" cellspacing="0" border="0">
          <tr>
            <td width="50%" align="right" valign="top" style="padding-top:15px;padding-bottom:15px;padding-right:25px;"><table  border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td width="100%" height="25" align="right"><font class="commonSmallest" ' . $HighSFN . '><b>' . $asteriskMarker . 'First Name&nbsp;&nbsp;</b></font></td>
                <td height="25"><font class="commonSmallest">' . $writeShipFName . '</font><input type="' . $cualInput . '" name="ShipFName" value="' . $thyShipFName . '" class="commonInput" size="20" tabIndex="1"></td>
              </tr>
              <tr>
                <td height="25" align="right"><font class="commonSmallest" ' . $HighSLN . '><b>' . $asteriskMarker . 'Last Name&nbsp;&nbsp;</b></font></td>
                <td height="25"><font class="commonSmallest">' . $writeShipLName . '</font><input type="' . $cualInput . '" name="ShipLName" value="' . $thyShipLName . '" class="commonInput" size="20" tabIndex="2"></td>
              </tr>
              <tr>
                <td height="25" align="right"><font class="commonSmallest"><b>Company Name&nbsp;&nbsp;</b></font></td>
                <td height="25"><font class="commonSmallest">' . $writeCompanyName . '</font><input type="' . $cualInput . '" name="CompanyName" value="' . $thyCompanyName . '" class="commonInput" size="20" tabIndex="3"></td>
              </tr>
              </table>
                <!--TL--></td>
            <td width="50%" align="left" valign="top" style="padding-top:15px;padding-bottom:15px;padding-right:10px;"><table  border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td height="25" align="right"><font class="commonSmallest" ' . $HighST . '><b>' . $asteriskMarker . '(Area) Phone&nbsp;&nbsp;</b></font></td>
                <td height="25" nowrap><font class="commonSmallest">' . $writeShipT . '</font><input name="ShipTArea" type="' . $cualInput . '" maxlength="3" class="commonInput" id="ShipTArea" tabIndex="4" OnKeyPress="checkInputPh(this);" value="' . $thyShipTArea . '" size="5">
&nbsp;&nbsp;
      <input name="ShipTNum" type="' . $cualInput . '" maxlength="7" class="commonInput" id="ShipTNum" tabIndex="5" OnKeyPress="checkInputPh(this);" value="' . $thyShipTNum . '" size="12"></td>
              </tr>
              <tr>
                <td height="25" align="right"><font class="commonSmallest"><b>(Area) Fax&nbsp;&nbsp;</b></font></td>
                <td height="25"><font class="commonSmallest">' . $writeShipF . '</font><input name="ShipFArea" type="' . $cualInput . '" maxlength="3" class="commonInput" id="ShipFArea" tabIndex="6" OnKeyPress="checkInputPh(this);" value="' . $thyShipFArea . '" size="5">
&nbsp;&nbsp;
      <input name="ShipFNum" type="' . $cualInput . '" maxlength="7" class="commonInput" id="ShipFNum" tabIndex="7" OnKeyPress="checkInputPh(this);" value="' . $thyShipFNum . '" size="12"></td>
              </tr>
              <tr>
                <td height="25" align="right" nowrap><font class="commonSmallest" ' . $HighEmail . '><b>' . $asteriskMarker . 'E-Mail Address&nbsp;&nbsp;</b></font></td>
                <td height="25"><font class="commonSmallest">' . $writeEmail . '</font><input type="hidden" name="UNamePassed" value=""><input name="Email" type="' . $cualInput . '" class="commonInput" id="Email" tabIndex="8" value="' . $thyEmail . '" size="20" $readOnly1></td>
              </tr>
            </table>
            <!--TR--></td>
          </tr>
          <tr>
            <td background="Night_Vision_Images/horizontalDottie.gif" colspan="2" align="right"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr align="center" valign="top">
            <td align="right" valign="top" style="padding-top:15px;padding-bottom:15px;padding-right:25px;"><table  border="0" cellspacing="0" cellpadding="0">
                <tr>
                  <td width="100%" height="25" align="right"><font class="commonSmallest" ' . $HighSA1 . '><b>' . $asteriskMarker . 'Address&nbsp;&nbsp;</b></font></td>
                  <td height="25"><font class="commonSmallest">' . $writeShipAddress1 . '</font><input type="' . $cualInput . '" name="ShipAddress1" value="' . $thyShipAddress1 . '" class="commonInput" size="20" tabIndex="9"></td>
                </tr>
                <tr>
                  <td width="100%" height="25" align="right"><font class="commonSmallest"><b>&sect;&nbsp;&nbsp;</b></font></td>
                  <td height="25"><font class="commonSmallest">' . $writeShipAddress2 . '</font><input type="' . $cualInput . '" name="ShipAddress2" value="' . $thyShipAddress2 . '" class="commonInput" size="20" tabIndex="10"></td>
                </tr>
                <tr>
                  <td width="100%" height="25" align="right"><font class="commonSmallest" ' . $HighSC . '><b>' . $asteriskMarker . 'City&nbsp;&nbsp;</b></font></td>
                  <td height="25"><font class="commonSmallest">' . $writeShipCity . '</font><input type="' . $cualInput . '" name="ShipCity" value="' . $thyShipCity . '" class="commonInput" size="20" tabIndex="11"></td>
                </tr>
              </table>
                <!--BL--></td>
            <td align="left" valign="top" style="padding-top:15px;padding-bottom:15px;padding-right:10px;"><table  border="0" cellspacing="0" cellpadding="0">
              <tr>
                <td height="25" align="right"><font class="commonSmallest"><b>' . $asteriskMarker . 'State&nbsp;&nbsp;</b></font></td>
                <td height="25"><font class="commonSmallest">' . $writeShipState . '</font>
				
';
	# if chosen (using zip found city and state) if trying to change this value at this point we revert
	# back to zip selection screen
	if ($validCityState eq "1") {
		$myTables = $myTables . '<select name="ShipState" class="commonInput" tabIndex="12">';
		@EstadosUnidos = ("AL,Alabama","AK,Alaska","AZ,Arizona","AR,Arkansas","CA,California","CO,Colorado","CT,Connecticut","DE,Delaware","DC,DC","FL,Florida","GA,Georgia","HI,Hawaii","ID,Idaho","IL,Illinois","IN,Indiana","IA,Iowa","KS,Kansas","KY,Kentucky","LA,Louisiana","ME,Maine","MD,Maryland","MA,Massachusetts","MI,Michigan","MN,Minnesota","MS,Mississippi","MO,Missouri","MT,Montana","NE,Nebraska","NV,Nevada","NH,New Hampshire","NJ,New Jersey","NM,New Mexico","NY,New York","NC,North Carolina","ND,North Dakota","OH,Ohio","OK,Oklahoma","OR,Oregon","PA,Pennsylvania","RI,Rhode Island","SC,South Carolina","SD,South Dakota","TN,Tennessee","TX,Texas","UT,Utah","VT,Vermont","VA,Virginia","WA,Washington","WV,West Virginia","WI,Wisconsin","WY,Wyoming");
		foreach $Estado (@EstadosUnidos) {
			$count++;
   			# Split the pair up into individual variables.
	   		local($value, $name) = split(/,/, $Estado);
			use locale;
			$value = uc($value);
			if ($thyShipState eq "$value") {
				$myTables = $myTables . '<option value="' . $value . '" SELECTED>' . $name . '</option>'; 
			}
			else {
				$myTables = $myTables . '<option value="' . $value . '">' . $name . '</option>'; 
			}
		}
	}
	
	else {
		$myTables = $myTables . '<select name="ShipState" class="commonInput" tabIndex="12" ' . $disableSelect . ' ' . $selectAction . ' ' . $selectTitle . '>';
		## WHICH State IS CHOSEN? (from prev form submit)
		$count=0;
		@EstadosUnidos = ("AL,Alabama","AK,Alaska","AZ,Arizona","AR,Arkansas","CA,California","CO,Colorado","CT,Connecticut","DE,Delaware","DC,DC","FL,Florida","GA,Georgia","HI,Hawaii","ID,Idaho","IL,Illinois","IN,Indiana","IA,Iowa","KS,Kansas","KY,Kentucky","LA,Louisiana","ME,Maine","MD,Maryland","MA,Massachusetts","MI,Michigan","MN,Minnesota","MS,Mississippi","MO,Missouri","MT,Montana","NE,Nebraska","NV,Nevada","NH,New Hampshire","NJ,New Jersey","NM,New Mexico","NY,New York","NC,North Carolina","ND,North Dakota","OH,Ohio","OK,Oklahoma","OR,Oregon","PA,Pennsylvania","RI,Rhode Island","SC,South Carolina","SD,South Dakota","TN,Tennessee","TX,Texas","UT,Utah","VT,Vermont","VA,Virginia","WA,Washington","WV,West Virginia","WI,Wisconsin","WY,Wyoming");
		foreach $Estado (@EstadosUnidos) {
			$count++;
   			# Split the pair up into individual variables.
	   		local($value, $name) = split(/,/, $Estado);
			if ($thyShipState eq "$value") {
				$myTables = $myTables . '<option value="' . $value . '" SELECTED>' . $name . '</option>'; 
			}
			else {
				$myTables = $myTables . '<option value="' . $value . '">' . $name . '</option>'; 
			}
		}
	}
	
	
	
	
	$myTables = $myTables . '</select>';

}


$myTables = $myTables . '

                </td>
              </tr>
              <tr>
                <td height="25" align="right"><font class="commonSmallest"><b>Zip/Postal Code&nbsp;&nbsp;</b></font></td>
                <td height="25"><font class="commonSmallest">' . $writeShipZip . '</font><input type="hidden" name="ShipZip" maxlength="10" value="' . $myZip . '"></td>
              </tr>
            </table>
            <!--BR--></td>
          </tr>
      </table></td>
            <td bgcolor="#ffffff" style="border-right:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr height="5">
            <td colspan="3"><img src="Night_Vision_Images/orderQuoteFormBottom.jpg" width="504" height="5"></td>
          </tr>
        </table>
		<br>
		<table width="504" border="0" cellspacing="0" cellpadding="0">
          <tr height="5">
            <td colspan="3"><img src="Night_Vision_Images/orderQuoteFormTopper.jpg" width="504" height="5"></td>
          </tr>
          <tr>
            <td  colspan="3" align="center" style="border-left:#DEDDCC 1px solid;border-right:#DEDDCC 1px solid;padding-bottom:4px;"><font style="line-height:18px;font-size:11px;" face="Verdana" color="#000000"><b>Billing Information</b><br>
                  <font style="font-size:9px;">' . $BillProblems . '</font></font></td>
          </tr>
          <tr height="1">
            <td bgcolor="#DEDDCC" colspan="3"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr height="1">
            <td bgcolor="#FFFFFF" colspan="3"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr>
            <td bgcolor="#ffffff" style="border-left:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
            <td bgcolor="#DEDDCC" width="502" align="center"><table width="100%" cellpadding="0" cellspacing="0" border="0">
                <tr align="center">
                  <td colspan="2" style="padding-top:15px;padding-bottom:15px;"><font style="font-size:11px;" face="Verdana" color="#000000">
                    <input type="checkbox" name="YesToSame" tabindex="14" ' . $cualCheckbox . '>
                    <b>Make Billing Information same as Shipping Information</b></font></td>
                </tr>
                <tr>
                  <td background="Night_Vision_Images/horizontalDottie.gif" colspan="2" align="right"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
                </tr>
                <tr>
                  <td width="50%" align="right" valign="top" style="padding-top:15px;padding-bottom:15px;padding-right:25px;"><table  border="0" cellspacing="0" cellpadding="0">
                      <tr>
                        <td width="100%" height="25" align="right"><font class="commonSmallest" ' . $HighFN . '><b>' . $asteriskMarker . 'First Name&nbsp;&nbsp;</b></font></td>
                        <td height="25"><font class="commonSmallest">' . $writeFName . '</font><input name="FName" type="' . $cualInput . '" class="commonInput" id="FName" tabIndex="15" value="' . $thyFName . '" size="20"></td>
                      </tr>
                    </table>
                      <!--TL--></td>
                  <td width="50%" align="left" valign="top" style="padding-top:15px;padding-bottom:15px;padding-right:10px;"><table  border="0" cellspacing="0" cellpadding="0">
                      <tr>
                        <td height="25" align="right"><font class="commonSmallest" ' . $HighLN . '><b>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;' . $asteriskMarker . 'Last Name&nbsp;&nbsp;</b></font></td>
                        <td height="25"><font class="commonSmallest">' . $writeLName . '</font><input name="LName" type="' . $cualInput . '" class="commonInput" id="LName" tabIndex="16" value="' . $thyLName . '" size="20"></td>
                      </tr>
                    </table>
                      <!--TR--></td>
                </tr>
                <tr>
                  <td background="Night_Vision_Images/horizontalDottie.gif" colspan="2" align="right"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
                </tr>
                <tr align="center" valign="top">
                  <td align="right" valign="top" style="padding-top:15px;padding-bottom:15px;padding-right:25px;"><table  border="0" cellspacing="0" cellpadding="0">
                      <tr>
                        <td width="100%" height="25" align="right"><font class="commonSmallest" ' . $HighA1 . '><b>' . $asteriskMarker . 'Address&nbsp;&nbsp;</b></font></td>
                        <td height="25"><font class="commonSmallest">' . $writeAddress1 . '</font><input name="Address1" type="' . $cualInput . '" class="commonInput" id="Address1" tabIndex="17" value="' . $thyAddress1 . '" size="20"></td>
                      </tr>
                      <tr>
                        <td width="100%" height="25" align="right"><font class="commonSmallest"><b>&sect;&nbsp;&nbsp;</b></font></td>
                        <td height="25"><font class="commonSmallest">' . $writeAddress2 . '</font><input name="Address2" type="' . $cualInput . '" class="commonInput" id="Address2" tabIndex="18" value="' . $thyAddress2 . '" size="20"></td>
                      </tr>
                      <tr>
                        <td width="100%" height="25" align="right"><font class="commonSmallest" ' . $HighC . '><b>' . $asteriskMarker . 'City&nbsp;&nbsp;</b></font></td>
                        <td height="25"><font class="commonSmallest">' . $writeCity . '</font><input name="City" type="' . $cualInput . '" class="commonInput" id="City" tabIndex="19" value="' . $thyCity . '" size="20"></td>
                      </tr>
                    </table>
                      <!--BL--></td>
                  <td align="left" valign="top" style="padding-top:15px;padding-bottom:15px;padding-right:10px;"><table  border="0" cellspacing="0" cellpadding="0">
                      <tr>
                        <td height="25" align="right"><font class="commonSmallest"><b>' . $asteriskMarker . 'State&nbsp;&nbsp;</b></font></td>
                        <td height="25"><font class="commonSmallest">' . $writeState . '</font>
';
	# if chosen (using zip found city and state) if trying to change this value at this point we revert
	# back to zip selection screen
	if ($validCityState eq "1") { $selectAction = "onChange=\"javascript:document.location.href='cart.htm?verifyZip=1&shipZip=Enter New ZIP';\""; $selectTitle="To change this ZIP CODE we must re-calculate shipping costs to the new zip you supply. To change this ZIP CODE click here now."; }
	else { $selectAction = ""; $selectTitle=""; }
	

	
	$myTables = $myTables . '<select name="State" class="commonInput" id="State" tabIndex="20" ' . $disableSelect . '>';


	## WHICH ProductType IS CHOSEN?
	$count=0;
	@EstadosUnidos = ("AL,Alabama","AK,Alaska","AZ,Arizona","AR,Arkansas","CA,California","CO,Colorado","CT,Connecticut","DE,Delaware","DC,DC","FL,Florida","GA,Georgia","HI,Hawaii","ID,Idaho","IL,Illinois","IN,Indiana","IA,Iowa","KS,Kansas","KY,Kentucky","LA,Louisiana","ME,Maine","MD,Maryland","MA,Massachusetts","MI,Michigan","MN,Minnesota","MS,Mississippi","MO,Missouri","MT,Montana","NE,Nebraska","NV,Nevada","NH,New Hampshire","NJ,New Jersey","NM,New Mexico","NY,New York","NC,North Carolina","ND,North Dakota","OH,Ohio","OK,Oklahoma","OR,Oregon","PA,Pennsylvania","RI,Rhode Island","SC,South Carolina","SD,South Dakota","TN,Tennessee","TX,Texas","UT,Utah","VT,Vermont","VA,Virginia","WA,Washington","WV,West Virginia","WI,Wisconsin","WY,Wyoming");
	foreach $Estado (@EstadosUnidos) {
		$count++;
   		# Split the pair up into individual variables.
   		local($value, $name) = split(/,/, $Estado);
		if ($thyState eq "$value") {
			$myTables = $myTables . '<option value="' . $value . '" SELECTED>' . $name . '</option>'; 
		}
		else {
			$myTables = $myTables . '<option value="' . $value . '">' . $name . '</option>'; 
		}
	}

	$myTables = $myTables . '</select>';



$myTables = $myTables . '




                        </td>
                      </tr>
                      <tr>
                        <td height="25" align="right"><font class="commonSmallest" ' . $HighZ . '><b>' . $asteriskMarker . 'Zip/Postal Code&nbsp;&nbsp;</b></font></td>
                        <td height="25"><font class="commonSmallest">' . $writeZip . '</font><input name="Zip" type="' . $cualInput . '" class="commonInput" id="Zip" tabIndex="21" value="' . $thyZip . '" size="12"></td>
                      </tr>
                    </table>
                      <!--BR--></td>
                </tr>
            </table></td>
            <td bgcolor="#ffffff" style="border-right:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr height="5">
            <td colspan="3"><img src="Night_Vision_Images/orderQuoteFormBottom.jpg" width="504" height="5"></td>
          </tr>
        </table>
		<br>
		<table width="504" border="0" cellspacing="0" cellpadding="0">
          <tr height="5">
            <td colspan="3"><img src="Night_Vision_Images/orderQuoteFormTopper.jpg" width="504" height="5"></td>
          </tr>
          <tr>
            <td  colspan="3" align="center" style="border-left:#DEDDCC 1px solid;border-right:#DEDDCC 1px solid;padding-bottom:4px;"><font style="line-height:18px;font-size:11px;" face="Verdana" color="#000000"><b>New User Account ' . $PassProblems . '</b></font></td>
          </tr>
          <tr height="1">
            <td bgcolor="#DEDDCC" colspan="3"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr height="1">
            <td bgcolor="#FFFFFF" colspan="3"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr>
            <td bgcolor="#ffffff" style="border-left:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
            <td bgcolor="#DEDDCC" width="502" align="center"><table width="100%" cellpadding="0" cellspacing="0" border="0">
                <tr align="center">
                  <td width="100%" style="padding-top:15px;padding-bottom:15px;"><font style="font-size:11px;" face="Verdana" color="#000000">
                    </font>
                    <table width="100%"  border="0" cellspacing="0" cellpadding="0">
                      <tr>
                        <td height="25" align="right"><font class="commonSmallest"><b>Username&nbsp;&nbsp;</b></font></td>
                        <td height="25" nowrap><font class="commonSmallest">' . $writeUsername . '</font></td>
                      </tr>
                      <tr>
                        <td height="25" align="right"><font class="commonSmallest" ' . $HighP . '><b>' . $asteriskMarker . 'Password&nbsp;&nbsp;</b></font></td>
                        <td height="25"><font class="commonSmallest">' . $writePass . '</font><input type="' . $cualPassword . '" name="Pass" value="' . $thyPass . '" class="commonInput" size="12" tabIndex="22"></td>
                      </tr>
                      <tr>
                        <td height="25" align="right" nowrap><font class="commonSmallest" ' . $HighP2 . '><b>' . $asteriskMarker . 'Confirm Password&nbsp;&nbsp;</b></font></td>
                        <td height="25"><font class="commonSmallest">' . $writePass . '</font><input type="' . $cualPassword . '" name="Pass2" value="' . $thyPass2 . '" class="commonInput" size="12" tabIndex="23"></td>
                      </tr>
                    </table></td>
                </tr>

            </table></td>
            <td bgcolor="#ffffff" style="border-right:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr height="5">
            <td colspan="3"><img src="Night_Vision_Images/orderQuoteFormBottom.jpg" width="504" height="5"></td>
          </tr>
        </table>
		<br>
		<table width="504" border="0" cellspacing="0" cellpadding="0">
          <tr height="5">
            <td colspan="3"><img src="Night_Vision_Images/orderQuoteFormTopper.jpg" width="504" height="5"></td>
          </tr>
          <tr>
            <td  colspan="3" align="center" style="border-left:#DEDDCC 1px solid;border-right:#DEDDCC 1px solid;padding-bottom:4px;"><font style="line-height:18px;font-size:11px;" face="Verdana" color="#000000"><b>Payment Information ' . $PayProblems . '</b></font></td>
          </tr>
          <tr height="1">
            <td bgcolor="#DEDDCC" colspan="3"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr height="1">
            <td bgcolor="#FFFFFF" colspan="3"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr>
            <td bgcolor="#ffffff" style="border-left:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
            <td bgcolor="#DEDDCC" width="502" align="center"><table width="100%" cellpadding="0" cellspacing="0" border="0">
                <tr align="center">
                  <td width="100%" style="padding-top:15px;padding-bottom:15px;"><font style="font-size:11px;" face="Verdana" color="#000000"> </font>
                      <table width="100%"  border="0" cellspacing="0" cellpadding="0">
                        <tr>
                          <td height="25" align="right"><font class="commonSmallest" ' . $HighPO . '><b>Purchase Order#&nbsp;&nbsp;</b></font></td>
                          <td height="25" nowrap><font class="commonSmallest">' . $writePO . '</font><input type="' . $cualInput . '" name="PurchOrd" value="" class="commonInput" size="30" tabindex="24"></td>
                        </tr>
                        <tr>
                          <td height="25" align="right"><p><font class="commonSmallest" ' . $HighPT . '><b>' . $asteriskMarker . 'Payment Method&nbsp;&nbsp;</b></font></p>
                          </td>
                          <td height="25"><font class="commonSmallest">' . $writePT . '</font>
';

	$myTables = $myTables . '<input type="hidden" name="CCPassed" value=""><select name="PayType" class="commonInput" tabindex="25" onChange="togglePTs();" ' . $disableSelect . '><option value="CHOOSEONE"> -- Choose One -- </option>';

	## WHICH ProductType IS CHOSEN?
	$count=0;
	@PTypes = ("CC::CC1,1st Credit Card","CC::CC2,2nd Credit Card","CC::CC3,3rd Credit Card","OTHER::net5,Net5","OTHER::net10,Net10","OTHER::net25,Net25","OTHER::check,Check/Money Order","OTHER::cod,C.O.D.");
	foreach $PType (@PTypes) {
		$count++;
   		# Split the pair up into individual variables.
   		local($value, $name) = split(/,/, $PType);
		if ($thyPT =~ "$value") {
			$name =~ s/1st //gi;
			$myTables = $myTables . '<option value="' . $value . '" SELECTED>' . $name . '</option>';
		}
		## DEFAULT PAYTYPES ALWAYS PRINTED
		elsif ("$value" =~ "CC1") {
			$name =~ s/1st //gi;
			$myTables = $myTables . '<option value="' . $value . '">' . $name . '</option>';
		}
	}
	$myTables = $myTables . '</select>';



$myTables = $myTables . '
						 </td>
                        </tr>
                        <tr>
                          <td height="25" align="right" nowrap><font class="commonSmallest" id="SeaSeaTT" style="visibility:hidden;" ' . $HighCCT . '><b>' . $asteriskMarker . 'Credit Card Type&nbsp;&nbsp;</b></font></td>
                          <td height="25">
';

	$myTables = $myTables . '<select name="SeaSeaT" id="SeaSeaT" class="commonInput" tabindex="25" ' . $showCCT . ' ' . $disableSelect . '>';

	## WHICH CCType IS CHOSEN?
	$count=0;
	@CCTypes = ("amex,American Express","novus,Discover / Novus","mastercard,MasterCard","visa,Visa");
	foreach $CCType (@CCTypes) {
		$count++;
   		# Split the pair up into individual variables.
   		local($value, $name) = split(/,/, $CCType);
		if ($thySeaSeaT =~ "$value") {
			$myTables = $myTables . '<option value="' . $value . '" SELECTED>' . $name . '</option>'; 
		}
		else {
			$myTables = $myTables . '<option value="' . $value . '">' . $name . '</option>'; 
		}
	}
	$myTables = $myTables . '</select>';



$myTables = $myTables . '
						  </td>
                        </tr>
                        <tr>
                          <td height="25" align="right" nowrap><font class="commonSmallest" id="SeaSeaNT" style="visibility:hidden;" ' . $HighCCN . '><b>' . $asteriskMarker . 'Credit Card #&nbsp;&nbsp;</b></font></td>
                          <td height="25"><input type="' . $cualInput . '" name="SeaSeaN" id="SeaSeaN" value="' . $thySeaSeaN . '" class="commonInput" size="30" tabindex="26" ' . $showCCN . '></td>
                        </tr>
                        <tr>
                          <td height="25" align="right" nowrap><font class="commonSmallest" id="SeaSeaEXT" style="visibility:hidden;" ' . $HighCCEX . '><b>' . $asteriskMarker . 'Expiration Date&nbsp;&nbsp;</b></font></td>
                          <td height="25"><input type="' . $cualInput . '" name="SeaSeaEX" id="SeaSeaEX" value="' . $thySeaSeaEX . '" class="commonInput" size="10" tabindex="27" ' . $showCCEX . '></td>
                        </tr>
                        <tr>
                          <td height="25" align="right" nowrap><font class="commonSmallest" id="SeaSeaSCT" style="visibility:hidden;" ' . $HighCCSC . '><b>' . $asteriskMarker . '<a href="javascript:void(0);popWindow(\'Credit_Card_Security_Code.htm\',\'CustomerCare\',\'345\',\'650\',\'NO\');" alt="What\'s a security code? Click to find out." class="commonSmallest" ' . $HighCCSC . '>Security Code</a>&nbsp;&nbsp;</b></font></td>
                          <td height="25"><input type="' . $cualInput . '" name="SeaSeaSC" id="SeaSeaSC" value="' . $thySeaSeaSC . '" class="commonInput" size="10" tabindex="27" ' . $showCCSC . '></td>
                        </tr>
                    </table></td>
                </tr>
            </table></td>
            <td bgcolor="#ffffff" style="border-right:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
          </tr>
          <tr height="5">
            <td colspan="3"><img src="Night_Vision_Images/orderQuoteFormBottom.jpg" width="504" height="5"></td>
          </tr>
        </table>
		
';


if ($countProblems ne "0" || !$FORM{'RC'}) {

	$myTables = $myTables . '
<script language="Javascript">
		function togglePTs() {
			var formindex = document.forms[0].PayType.selectedIndex;
			var thisone = document.forms[0].PayType.options[formindex].value;
			if (thisone.indexOf("CC") != -1) {
				document.forms[0].CCPassed.value = "NO";
				document.getElementById("SeaSeaT").style.visibility = "visible";
				document.getElementById("SeaSeaN").style.visibility = "visible";
				document.getElementById("SeaSeaEX").style.visibility = "visible";
				document.getElementById("SeaSeaSC").style.visibility = "visible";
				document.getElementById("SeaSeaTT").style.visibility = "visible";
				document.getElementById("SeaSeaNT").style.visibility = "visible";
				document.getElementById("SeaSeaEXT").style.visibility = "visible";
				document.getElementById("SeaSeaSCT").style.visibility = "visible";
				if (thisone == "CC::CC1") { 
					document.forms[0].SeaSeaT.value = "' . $thySeaSeaT . '";
					document.forms[0].SeaSeaN.value = "' . $thySeaSeaN . '";
					document.forms[0].SeaSeaEX.value = "' . $thySeaSeaEX . '";
					document.forms[0].SeaSeaSC.value = "' . $thySeaSeaSC . '";
				}
				if (thisone == "CC::CC2") {
					document.forms[0].SeaSeaT.value = "' . $thySeaSeaT . '";
					document.forms[0].SeaSeaN.value = "' . $thySeaSeaN . '";
					document.forms[0].SeaSeaEX.value = "' . $thySeaSeaEX . '";
					document.forms[0].SeaSeaSC.value = "' . $thySeaSeaSC . '";
				}
				if (thisone == "CC::CC3") {
					document.forms[0].SeaSeaT.value = "' . $thySeaSeaT . '";
					document.forms[0].SeaSeaN.value = "' . $thySeaSeaN . '";
					document.forms[0].SeaSeaEX.value = "' . $thySeaSeaEX . '";
					document.forms[0].SeaSeaSC.value = "' . $thySeaSeaSC . '";
				}
			}
			else {
				document.forms[0].CCPassed.value = "YES";
				document.getElementById("SeaSeaT").style.visibility = "hidden";
				document.getElementById("SeaSeaN").style.visibility = "hidden";
				document.getElementById("SeaSeaEX").style.visibility = "hidden";
				document.getElementById("SeaSeaSC").style.visibility = "hidden";
				document.getElementById("SeaSeaTT").style.visibility = "hidden";
				document.getElementById("SeaSeaNT").style.visibility = "hidden";
				document.getElementById("SeaSeaEXT").style.visibility = "hidden";
				document.getElementById("SeaSeaSCT").style.visibility = "hidden";
			}
		}

		
function checkInputPh(val) {
   	var key = window.event.keyCode;
	var leValue= val.value;
   	// key numeric?
	// 48 = 0 (dont want zero)
   	if (key > 47 && key < 58) {
		leValue = val.value;
		return; 
	}
	else {
		// discard
    	window.event.returnValue = null;
	}
}

function sameAsShipping(isIt) {
	thyForm = document.forms[0];
	if (isIt == true) {
		thyForm.FName.value = thyForm.ShipFName.value;
		thyForm.LName.value = thyForm.ShipLName.value;
		thyForm.Address1.value = thyForm.ShipAddress1.value;
		thyForm.Address2.value = thyForm.ShipAddress2.value;
		thyForm.City.value = thyForm.ShipCity.value;
		thyForm.State.value = thyForm.ShipState.value;
		thyForm.Zip.value = thyForm.ShipZip.value;
	}
	else {
		thyForm.FName.value = "";
		thyForm.LName.value = "";
		thyForm.Address1.value = "";
		thyForm.Address2.value = "";
		thyForm.State.value = "";
		thyForm.Zip.value = "";
	}
}

		
// USER CHECK STUFF
function EmailinUse() {
	document.forms[0].UNamePassed.value="NO";
}


function EmailgoodOne() {
	document.forms[0].UNamePassed.value="YES";
}

function BadEmailAddress() {
	document.forms[0].UNamePassed.value="YES";
}

' . $EmailCheck . '









function CCinvalid() {
	showCCFields();
	document.forms[0].CCPassed.value="NO";
}

function SCinvalid() {
	showCCFields();
	document.forms[0].CCPassed.value="NO";
}

function CCdataMissing() {
	showCCFields();
	document.forms[0].CCPassed.value="NO";
}

function SCdataMissing() {
	showCCFields();
	document.forms[0].CCPassed.value="NO";
}

function CCgoodOne() {
	showCCFields();
	document.forms[0].CCPassed.value="YES";
}

function showCCFields() {
	document.getElementById("SeaSeaT").style.visibility = "visible";
	document.getElementById("SeaSeaN").style.visibility = "visible";
	document.getElementById("SeaSeaEX").style.visibility = "visible";
	document.getElementById("SeaSeaSC").style.visibility = "visible";
	document.getElementById("SeaSeaTT").style.visibility = "visible";
	document.getElementById("SeaSeaNT").style.visibility = "visible";
	document.getElementById("SeaSeaEXT").style.visibility = "visible";
	document.getElementById("SeaSeaSCT").style.visibility = "visible";
}


function PaymentTypeNotChosen() {
//	document.forms[0].PayType.focus();
}


' . $CCCheck . '







function checkForm() {

}


	</script>
';
}							   
							   

&parseCartContents;




###################################################################################################
###################################################################################################
###################################################################################################
if ($countInput eq "0") {
	$pd = "This is the final step of our checkout process, below you will find a form containing fields that correspond to the information we require to make an online purchase. Please fill in all fields, giving special attention to the (<font color=\"#eb0000\">*</font>) required fields.";
	$myAction = "processOrder.htm";
	$myButtons = '<br><input type="submit" value="Validate My Information" class="submitButton"tabindex="28"> &nbsp;&nbsp; <!--<input type="button" value="Revise My Information" class="button" tabindex="29">-->';

	print "Content-type: text/html \n\n";
	## --> Main Template START
	print $USNVMainTemplateTop;

}
elsif ($countProblems ne "0") {
	$pd = "We have detected at least one problem with the information you submitted. The problem spots have been highlighted by making the form name(s) red. Also, an itemized explanation of the erroneous field(s) are listed at the top of each section. Please revise these problem spots and re-submit your order.";
	$myAction = "processOrder.htm";

	print "Content-type: text/html \n\n";
	## --> Main Template START
	print $USNVMainTemplateTop;
	$myButtons = '<br><input type="submit" value="Validate My Information" class="submitButton"tabindex="28"> &nbsp;&nbsp; <!--<input type="button" value="Revise My Information" class="button" tabindex="29">-->';
}
else { 
	$pd = "All your information has been verified and your order is ready to be processed by our staff. Simply look through your order parameters and the information you submitted to us, and if all looks well click 'Verify and Submit This Order'.";
	$myButtons = '<br><input type="submit" value="Verify and Submit This Order" style="width:250px;" class="submitButton"tabindex="28"> &nbsp;&nbsp; <!--<input type="button" value="Revise My Information" class="button" tabindex="29">-->';

	
	

		
	$myCT = $cartTable;
	$myCT =~ s/!!TheseRows!!/$allRows/gi;
	$myAction = "orderProcessed.htm";
	
	
	require("AdSvC.nsp");


	## --> Main Template START
	print $USNVMainTemplateTop;

	
}

	$PageContent =~ s/!!ThisTitle!!/Shopping Cart ( Checkout Counter )/gi;
	$PageContent =~ s/!!ProductSubTitle!!/<b>Data Encrypted for Security<\/b>/gi;
	$PageContent =~ s/!!PageDescription!!/$pd/gi;
	$PageContent =~ s/!!PageContent!!/$myCT <br> $myTables !!ThyButtons!!/gi;
	$PageContent =~ s/!!FormAction!!/$myAction/gi;
	$PageContent =~ s/!!ThyButtons!!/$myButtons/gi;	
	


	&printPage;
















	
	
## print out main template BOT from templateMaster.nsp
print $USNVMainTemplateBot;





sub printPage {

print qq~
				<table width="100%" cellpadding="0" cellspacing="0" border="0">
					<tr>
						<td><img src="Night_Vision_Images/spacer.gif" border="0" width="1" height="1"></td>
					</tr>
$myTopBanner


				</table>

			<!--STARTMainLayoutTable-->
				<table width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="#FFFFFF">
					<tr>
						<td width="175" height="2"><img src="Night_Vision_Images/spacer.gif" border="0" width="175" height="2"></td>
						<td width="1" height="2" background="Night_Vision_Images/verticalDottie.gif"><img src="Night_Vision_Images/spacer.gif" border="0" width="1" height="2"></td>
						<td width="100%" height="2"><img src="Night_Vision_Images/spacer.gif" border="0" width="1" height="2"></td>
					</tr>

					<tr>

						<!--STARTLeftMenu-->
						<td width="175" valign="top">
							$leftMenu
						</td>
						<!--ENDLeftMenu-->

						<!--STARTMenu/ContentDivider-->
						<td width="1" background="Night_Vision_Images/verticalDottie.gif"><img src="Night_Vision_Images/spacer.gif" border="0" width="1" height="20"></td>
						<!--ENDMenu/ContentDivider-->

						<!--STARTMainContentArea-->
						<td width="100%" valign="top">

							$PageContent
							
						</td>
						<!--ENDMainContentArea-->

					</tr>


				</table>
			<!--ENDMainLayoutTable-->


~;	
	1;	
}




sub writeOutInformation {
	$writeShipFName = "$FORM{'ShipFName'}";
	$writeShipLName = "<nobr>$FORM{'ShipLName'}/<nobr>";
	$writeCompanyName = "<nobr>$FORM{'CompanyName'}</nobr>";

	$tNum = $FORM{'ShipTNum'};
	$p3 = substr($tNum, 0, 3);
	$p4 = substr($tNum, 3, 4);
	$writeShipT = "($FORM{'ShipTArea'})$p3-$p4";

	$fNum = $FORM{'ShipFNum'};
	$f3 = substr($fNum, 0, 3);
	$f4 = substr($fNum, 3, 4);
	$writeShipF = "($FORM{'ShipFArea'})$f3-$f4";
	
	if ($writeShipF eq "()-") { $writeShipF = ""; }
		
	$writeEmail = "$FORM{'Email'}";
	$writeShipAddress1 = "<nobr>$FORM{'ShipAddress1'}</nobr>";
	$writeShipAddress2 = "<nobr>$FORM{'ShipAddress2'}</nobr>";
	if ($validCityState eq "1") { $writeShipCity = "$Cities[0]"; }
	else { $writeShipCity = "<nobr>$FORM{'ShipCity'}</nobr>"; }
	$writeShipState = "$FORM{'ShipState'}";
	$writeShipZip = "$FORM{'ShipZip'}";
	

	$writeFName = "$FORM{'FName'}";
	$writeLName = "<nobr>$FORM{'LName'}</nobr>";
	$writeAddress1 = "<nobr>$FORM{'Address1'}</nobr>";
	$writeAddress2 = "<nobr>$FORM{'Address2'}</nobr>";
	$writeCity = "<nobr>$FORM{'City'}</nobr>";
	$writeState = "$FORM{'State'}";
	$writeZip = "$FORM{'Zip'}";


	$writePass = "Hidden for your protection";
	$writePass2 = "";

	if ($FORM{'PayType'} =~ "CC") { 
		$writePT = "<nobr>$FORM{'SeaSeaT'} ($FORM{'SeaSeaN'} / $FORM{'SeaSeaEX'})</nobr>";	
	}
	elsif ($FORM{'PayType'} =~ "Check") { 
		$writePT = "Check";
	}
	elsif ($FORM{'PayType'} =~ "PurchaseOrder") { 
		$writePT = "Approved Purchase Order ($FORM{'PurchOrd'})";	
	}
	
	
}

$dbh->disconnect;
	1;
}		







sub secure3 {
	$length3 = length($thySeaSeaSC);
	if ($length3 != 3) { &badSecure3; }
	if (!($thySeaSeaSC =~ /^[0-9]*$/)) { &badSecure3; }
	1;
}
sub badSecure3 {
	if ($FORM{'cardtype'} eq "visa") { $myCard = "Visa"; }
	if ($FORM{'cardtype'} eq "mastercard") { $myCard = "MasterCard"; }
	if ($FORM{'cardtype'} eq "novus") { $myCard = "Discover/Novus"; }
	
	$CCCheck = "SCdataMissing()";
	$HighCCSC = "style=\"color:#eb0000\"";
	$PayProblems = $PayProblems . "<br> - Your card type ( $myCard ) requires a 3 digit Security Code.";
	$countProblems++;
	1;
}




sub secure4 {
	$length4 = length($thySeaSeaSC);
	if ($length4 != 4) { &badSecure4; }
	if (!($thySeaSeaSC =~ /^[0-9]*$/)) { &badSecure4; }
	1;
}
sub badSecure4 {
	$CCCheck = "SCdataMissing()"; 
	$HighCCSC = "style=\"color:#eb0000\""; 
	$PayProblems = $PayProblems . "<br> - Your card type ( American Express ) requires a 4 digit Security Code.";
	$countProblems++;
	1;
}


sub missingSecurityCode {
	$CCCheck = "SCdataMissing()";
	$HighCCSC = "style=\"color:#eb0000\"";
	$PayProblems = $PayProblems . "<br> - Credit Card's Security Code is missing.";
	$countProblems++;
	1;
}


sub expireCheck {
	$fslash = '/';
	$myEXP = $FORM{'cardexp'};
	$myEXP =~ s/ //gi;
	$myEXP =~ s/-//gi;
	$myEXP =~ s/$fslash//gi;
	$myEXP =~ s/\\//gi;
	$lengthEXP = length($myEXP);
	if ($lengthEXP != 4) { &badExpiration; }
	if (!($myEXP =~ /^[0-9]*$/)) { &badExpiration; }

	$expMonth = substr($myEXP,0,2);
	$expYear = substr($myEXP,2,2);
	$checkYear = substr($year,2,2);

	$expMonthCheck = $expMonth;
	$expMonthCheck--;
	
	if ($expYear == $checkYear) { 
		if ($checkYear eq "$expYear") {
			if ($expMonthCheck > $months3[$mon]) { $continueRun = 1; }
			elsif ($months3[$mon] eq $expMonth) { $continueRun = 1; }
			else { &expiredCard; }
		}
	
	}
	elsif ($expYear < $checkYear) { &expiredCard; }

	1;
}

sub expiredCard {
	$CCCheck = "CCdataMissing()"; 
	$HighCCEX = "style=\"color:#eb0000\"";
	$PayProblems = $PayProblems . "<br> - Credit Card's Expiration Date is invalid.<br>&nbsp;&nbsp;&nbsp;According to your input, your credit card expired on <i>$months[$expMonthCheck], '$expYear</i>";
	$countProblems++;
	1;
}

sub badExpiration {
	$CCCheck = "CCdataMissing()"; 
	$HighCCEX = "style=\"color:#eb0000\"";
	$PayProblems = $PayProblems . "<br> - Credit Card's Expiration Date is invalid.";
	$countProblems++;
	1;
}

sub missingExpiration {
	$CCCheck = "CCdataMissing()"; 
	$HighCCEX = "style=\"color:#eb0000\"";
	$PayProblems = $PayProblems . "<br> - Credit Card's Expiration Date is missing.";
	$countProblems++;
	1;
}




sub parseCartContents {
	@CT = "";
	$allRows = "";
	$cAllItems = 0;
	foreach $theamc (@cartedItems) {
		$myExtraTabler = "";
		## --> if contains option split the item
		if ($theamc =~ "OPT_") { 
			@stamc = split(/ %%%%%%%%%%% /,$theamc);
			$amc = $stamc[0];
			$myOPTs = $stamc[1];
		}
		## --> else only product, no option
		else { $amc = $theamc; $myOPTs = ""; }

		## --> make sure its legit
		if ($amc =~ "xxxxx") {
			@SPLITAMC = split(/ xxxxx /, $amc);
			$thyPID = $SPLITAMC[0];
			$quant = $SPLITAMC[1];

			my $sth = $dbh->prepare("SELECT * FROM newProducts WHERE ProductID='$thyPID'");
			$sth->execute or die "Unable to execute query\n"; 
			my @row;
				while(@row = $sth->fetchrow_array) { 
					$SavedPartNum = $row[1];
					$SavedMFGName = $row[2];
					$SavedMFGPartNum = $row[3];
					$SavedMFGProdURL = $row[4];
					$SavedItemName = $row[5];
					$SavedDescription = $row[6];
					$SavedTechSpecs = $row[7];
					$SavedSmallPhoto = $row[8];
					$SavedLargePhoto = $row[9];
					$SavedWarranty = $row[10];
					$SavedWeight = $row[11];
					$SavedMasterDist = $row[12];
					$SavedDistributor = $row[13];
					$SavedDealer = $row[14];
					$SavedLawEnforce = $row[15];
					$SavedRetail = $row[16];
					$SavedAccessories = $row[17];
					$SavedProdUsage = $row[18];
					$SavedProductType = $row[19];
					$SavedGeneration = $row[20];
					$BrochureBulletPoints = $row[23];
					$SavedIncludedItems = $row[28];
					$SavedSpecialDiscount = $row[37];
					$SavedProductOptions = $row[38];
					if ($SavedProductOptions =~ ":::::") {
						@splitPO = split(/\n\b/,$SavedProductOptions);
						$cPOs = 1;
						foreach $PO (@splitPO) { $allSavedPOs[$cPOs] = "$PO"; $cPOs++; }
					}
				}

				if ($custUName =~ "@") {
					## NOW YOU KNOW
					if ($custTipo eq "MasterDist") { $lePrice = "$SavedMasterDist"; }
					elsif ($custTipo eq "Distributor") { $lePrice = "$SavedDistributor"; }
					elsif ($custTipo eq "Dealer") { $lePrice = "$SavedDealer"; }
					elsif ($custTipo eq "LawEnforce") { $lePrice = "$SavedLawEnforce"; }
					else { $lePrice = "$SavedRetail"; }
				}
				elsif ($Cookies{'Logged'} eq "SI") {
					if ($Cookies{'CT'} eq "MasterDist") { $lePrice = "$SavedMasterDist"; }		
					elsif ($Cookies{'CT'} eq "Distributor") { $lePrice = "$SavedDistributor"; }		
					elsif ($Cookies{'CT'} eq "Dealer") { $lePrice = "$SavedDealer"; }		
					elsif ($Cookies{'CT'} eq "LawEnforce") { $lePrice = "$SavedLawEnforce"; }
					else { $lePrice = "$SavedRetail"; }
				}
				else { $lePrice = "$SavedRetail"; }

				if ($SavedSpecialDiscount ne "0" && $SavedSpecialDiscount ne "" && $SavedSpecialDiscount ne "0.00") {
					$centuri = $lePrice / 100;
					$discountAmount = $centuri * $SavedSpecialDiscount;
					$newPrice = $lePrice - $discountAmount;
					$TP = $quant * $newPrice;
					$myTotal=&format_money($TP);
					$myDollar=&format_money($newPrice);
					$myTotal = "<font style=\"color:#eb0000;cursor:hand;\" title=\"Sale Priced Item\">$myTotal</font>";
					$myDollar = "<font style=\"color:#eb0000;cursor:hand;\" title=\"Sale Priced Item\">$myDollar</font>";
				}
				else {
					$TP = $quant * $lePrice;
					$myTotal=&format_money($TP);
					$myDollar=&format_money($lePrice);
				}
			
				push(@CT,"$TP");

				if ($SavedProductType =~ "Accessory") { $myPT = "ACC"; }
				elsif ($SavedProductType =~ "Binocular") { $myPT = "BIN"; }
				elsif ($SavedProductType =~ "BodyArmor") { $myPT = "ARM"; }
				elsif ($SavedProductType =~ "Thermal") { $myPT = "THRM"; }
				elsif ($SavedProductType =~ "Digital") { $myPT = "DIG"; }
				elsif ($SavedProductType =~ "Goggle") { $myPT = "GOG"; }
				elsif ($SavedProductType =~ "Laser") { $myPT = "LAS"; }
				elsif ($SavedProductType =~ "Monocular") { $myPT = "MON"; }
				elsif ($SavedProductType =~ "Weapon") { $myPT = "WPN"; }
	
				if ($SavedGeneration =~ "I") { $myClass = "G1"; }
				elsif ($SavedGeneration =~ "II") { $myClass = "G2"; }
				elsif ($SavedGeneration =~ "IIP") { $myClass = "G2+"; }
				elsif ($SavedGeneration =~ "III") { $myClass = "G3"; }
				elsif ($SavedGeneration =~ "Viewer") { $myClass = "DIG"; }
				elsif ($SavedGeneration =~ "N/A") { $myClass = "n/a"; }
				
			
			$sth->execute or die "Unable to execute query\n"; 
			$sth->finish;
		
		
		
			$ProductName = "<a href=\"http://www.usnightvision.com/Night_Vision_Products.htm?PID=$thyPID\"><font face=\"Arial\" size=\"1\" color=\"#000000\">$SavedItemName</font></a>";
			$myQuantity = "$quant";
		
			$thisRowItem = $cartRow;
			$thisRowItem =~ s/!!PName!!/$ProductName/gi;
			$thisRowItem =~ s/!!Type!!/$myPT/gi;
			$thisRowItem =~ s/!!Class!!/$myClass/gi;
			$thisRowItem =~ s/!!Quantity!!/$myQuantity/gi;
			$thisRowItem =~ s/!!TPrice!!/$myTotal/gi;
			$thisRowItem =~ s/!!Weight!!/$SavedWeight/gi;
		
		


		#################################
		#### product options inserts ####
		#################################
		$myExtraTabler = "";
			if ($myOPTs =~ "OPT_") {

				## --> more than one option chosen
				if ($myOPTs =~ " %%%%% ") { @allOPTs = split(/ %%%%% /,$myOPTs); }
				## --> only one option chosen
				else { $allOPTs[0] = $myOPTs; }
				
				foreach $aOPTs (@allOPTs) {
				
					$aOPTs =~ s/OPT_//gi;
					@splitAOPTS = split(/:::::/,$allSavedPOs[$aOPTs]);
					

					$mydollar = int($splitAOPTS[1]);
					$tpOPT = $quant * $mydollar;
					$MD=&format_money($tpOPT);

					$myExtraTabler = $myExtraTabler . '
					<tr height="19">
						<td width="10" style="border-left:#DEDDCC 1px solid;"><img src="Night_Vision_Images/spacer.gif" width="10" height="19"></td>
						<td><font face="Arial" size="1" color="#000000"><nobr><font face="Arial" size="1" color="#000000"> - ' . $splitAOPTS[0] . '</font></nobr></font></td>
						<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
						<td align="center"><font face="Arial" size="1" color="#000000"><nobr>OPT</nobr></font></td>
						<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
						<td align="center"><font face="Arial" size="1" color="#000000"><nobr>n/a</nobr></font></td>
						<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
						<td align="center"><font face="Arial" size="1" color="#000000">-</font></td>
						<td align="center" bgcolor="#DEDDCC" width="1"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
						<td style="padding-left:20px;" nowrap><font face="Arial" size="1" color="#000000">&nbsp;&nbsp;-</font></td>
						<td align="center" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td>
						<td align="right" style="border-right:#DEDDCC 1px solid;" nowrap><font face="Arial" size="1" color="#000000"><nobr>' . $MD . '<img src="Night_Vision_Images/spacer.gif" width="25" height="8" border="0"></nobr></font></td>
					</tr>
					<tr height="1"><td colspan="12" bgcolor="#DEDDCC"><img src="Night_Vision_Images/spacer.gif" width="1" height="1"></td></tr>
					';

					push(@CT,"$tpOPT");
			}
		}

		## (counting ITEMS in CART) NOT ADDING options to the total cart count
		$cAllItems = int($cAllItems + $quant);
		
		$allWeights = ($SavedWeight * $quant) + $allWeights;
		$allRows = $allRows . $thisRowItem . $myExtraTabler;
		
		
		}
	}

	
										
									## --->>>ADD ALL PRICES TOGETHER FOR TOTAL
									$theTotalPrice = 0;
									foreach $myCTotal (@CT) {
										$theTotalPrice = $theTotalPrice+=$myCTotal;
									}
									$theTotal=&format_money($theTotalPrice);
									# $PageContent = $PageContent . "<script>alert('$theTotal');</script>";

	
	

									use lib '.';
									use Business::UPS;
									my $type = "$FORM{'Package'}";
									my $to = "$FORM{'shipZip'}";
									my $wgt = "$allWeights";
									my ($from,$co) = qw/92626/;
									my ($shipping,$ups_zone,$error) = getUPS($type,$from,$to,$wgt,$co,'', '', '', '', '');
									
									$pd = "Your route has been cleared, your package(s) have been measured and weighed and the shipping price for the delivery service has been calculated. If you are satisfied with your choice of shipping method and agree to the <i>Total Cart Price</i>, click 'Order Now' to jump to the final process of Ordering or click 'Request Quote' to submit a price quote request to us.<br><br><i>If you want to change your shipping method selection simply click the shipping price highlighted in red to take you to the selection screen.</i>"; 
								
									$handlingCharge = "15.00";
								
									### --->CALCULATE INSURANCE COST
									$insuranceCharge = int(int($theTotalPrice / 100) * .75);
								
									### --->INSURANCE COST
									$insuranceCharged = "$insuranceCharge";
									$insuranceCharged=&format_money($insuranceCharged);
								
									### --->ADD ALL SHIPPING COSTS INTO ONE CHARGE
									$newSCost = ($shipping + $handlingCharge) + $insuranceCharge;
								
									### --->SHIP COST
									$leSCost = "$newSCost";
									$leSCost=&format_money($leSCost);
								
									### --->TOTAL CART PRICE
									$TCPrice = ($newSCost + $theTotalPrice);
									# $TCPrice=&format_money($TCPrice);		
										
								
									### --->CALCULATE SALES TAX FOR CALI/NON GOVERNMENT
									## sales tax for California Residents who are Retail or Law Enforcement (or if not specified, not logged in)
									if (!$cualCT || $cualCT ne "International" || $cualCT ne "Dealer" || $cualCT ne "Distributor" || $cualCT ne "MasterDist") {
										if ($thyShipState eq "CA") {
											$caSalesTax = "7.75";
											### calculate TAX without ship/hand/insurance
											$salesTax = (($theTotalPrice / 100) * $caSalesTax);
											$salesTax = sprintf("%.2f", $salesTax);
											$myTaxie = "California Internet Sales Tax";
										}
									else {
											$salesTax = "0.00";		
											$myTaxie = "No Internet Sales Tax for $thyShipState";
										}
									}
									else {
										$salesTax = "0.00";
										$myTaxie = "International Sales Tax";
									}
										
									### --->ADD TAX TOTAL CART PRICE
									$TCPrice = ($TCPrice += $salesTax);
									$TCPrice=&format_money($TCPrice);		

									### --->SALES TAX
									$TaxCost = $salesTax;
									$TaxCost=&format_money($TaxCost);
							   
									## cual package
									@Packages = ("1DM,Next Day Air Early AM","1DA,Next Day Air","2DA,2nd Day Air","3DS,3 Day Select","GNDCOM,Ground Commercial","GNDRES,Ground Residential");
									foreach $Type (@Packages) {
										local($value, $name) = split(/,/, $Type);	
										if ($FORM{'Package'} eq "$value") { $miPackage = "$name"; }
									}		
									
		###							   
		### ADDED ROWS TO MAIN TABLE (weight & totals)
		###
		$allRows = $allRows . "
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>


							   <tr>
							   		<td colspan=\"10\" align=\"right\" style=\"padding-right:10px; line-height:24px;border-left:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\">Cart Sub-Total</font></td>
									<td bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
							   		<td align=\"right\" style=\"border-right:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\">$theTotal<img src=\"Night_Vision_Images/spacer.gif\" width=\"25\" height=\"8\" border=\"0\"></font></td>
								</tr>

								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>

							   	<tr bgcolor=\"#DEDDCC\">
							   		<td colspan=\"8\" align=\"right\" style=\"padding-right:10px; line-height:24px;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\"><b>Total Weight</b></font></td>
									<td bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
							   		<td style=\"padding-left:20px;\" ><font face=\"Verdana\" size=\"1\" color=\"#000000\"><b>$allWeights lbs</b></font></td>
									<td bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
									<td align=\"right\" bgcolor=\"#DEDDCC\" style=\"border-right:#DEDDCC 1px solid;background-image:url('Night_Vision_Images/UPSicon.gif'); background-repeat: no-repeat; background-position: left 2px; cursor:hand;\" title=\"UPS Shipping Cost: This figure includes Freight, Shipment Insurance & Handling Charges [  Package selected: $miPackage ]\"><font face=\"Verdana\" size=\"1\" color=\"#eb00000\"><u>$leSCost</u></font><img src=\"Night_Vision_Images/spacer.gif\" width=\"25\" height=\"8\" border=\"0\"></td>
								</tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>


							   <tr>
							   		<td colspan=\"10\" align=\"right\" style=\"padding-right:10px; line-height:24px;border-left:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\">$myTaxie</font></td>
									<td bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
							   		<td align=\"right\" style=\"border-right:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#eb0000\">$TaxCost</font></a><img src=\"Night_Vision_Images/spacer.gif\" width=\"25\" height=\"8\" border=\"0\"></td>
								</tr>								
								
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>


							   <tr bgcolor=\"#DEDDCC\">
							   		<td colspan=\"10\" align=\"right\" style=\"padding-right:10px; line-height:24px;border-left:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\"><b>Total Cart Price</b></font></td>
									<td bgcolor=\"#FFFFFF\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td>
							   		<td align=\"right\" style=\"border-right:#DEDDCC 1px solid;\"><font face=\"Verdana\" size=\"1\" color=\"#000000\"><b>\$$TCPrice</b><img src=\"Night_Vision_Images/spacer.gif\" width=\"25\" height=\"8\" border=\"0\"></font></td>
								</tr>

								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#ffffff\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>
								<tr height=\"1\"><td colspan=\"12\" bgcolor=\"#DEDDCC\"><img src=\"Night_Vision_Images/spacer.gif\" width=\"1\" height=\"1\"></td></tr>

							   ";


	

	1;
}



exit;




